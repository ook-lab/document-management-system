# Doc-Processor 修正計画

## 優先度の定義
- **S (致命的)**: システムが正常に動作しない、データ損失の可能性
- **A (重大)**: 機能不全、セキュリティリスク
- **B (重要)**: パフォーマンス問題、保守性の低下
- **C (改善)**: コード品質、将来的なリスク

---

## 優先度S: 致命的な問題（即座に修正が必要）

### 1. active_tasks/active_workers の型不整合 (app.py:1093, 1116, 1155)
**問題**: グローバル変数として辞書で初期化されているが、リストとして使用されている箇所がある
```python
active_tasks = {}  # 辞書として初期化
# しかし...
active_tasks.append(task_id)  # リストのメソッドを呼び出し
```
**影響**: AttributeError が発生し、処理が停止する
**修正**: 辞書型に統一し、すべての使用箇所を修正

### 2. global宣言の欠落 (10箇所以上)
**問題**: 以下の関数でグローバル変数を変更しているが、global宣言がない
- `periodic_resource_update()` (app.py:1152) - 複数のグローバル変数を参照
- `process_with_timeout()` (app.py:~1200) - current_workers を変更
- `update_supabase_stats()` - is_processing_status を参照
- その他多数

**影響**: UnboundLocalError または変更が反映されない
**修正**: 各関数の冒頭に適切な global 宣言を追加

### 3. register_worker/unregister_worker が空実装 (app.py:1106, 1112)
**問題**:
```python
def register_worker(doc_id: str):
    """ワーカー登録（現在は未使用）"""
    pass

def unregister_worker(doc_id: str):
    """ワーカー登録解除（現在は未使用）"""
    pass
```
しかし、実際にはコード内で呼び出されている

**影響**: ワーカーの状態管理が全く機能していない
**修正**: 実装を追加するか、完全に削除して呼び出し箇所も削除

### 4. periodic_resource_update() のエラーハンドリング欠如 (app.py:1152)
**問題**: threading.Timer で定期実行されるが、エラーが発生すると以降の更新が停止する
```python
def periodic_resource_update():
    # エラーが発生すると、以降のタイマーが設定されない
    threading.Timer(2.0, periodic_resource_update).start()
```

**影響**: リソース監視が停止し、並列数調整が機能しなくなる
**修正**: try-except でラップし、エラーが発生してもタイマーを再設定

### 5. threading.Timer と asyncio の混在 (app.py:1152, 1193)
**問題**: スレッドベースのタイマーと asyncio を混在させているが、スレッドセーフな設計になっていない
**影響**: 競合状態によるデータ破損、デッドロック
**修正**: asyncio.create_task() を使用するか、適切なロックを導入

---

## 優先度A: 重大な問題

### 6. Supabase書き込みの頻度が高すぎる (app.py:複数箇所)
**問題**:
- periodic_resource_update() が2秒ごとに実行
- 各ドキュメント処理時に複数回書き込み
- 並列処理中は秒間数十回の書き込みが発生

**影響**:
- Supabase API制限に到達する可能性
- レスポンス遅延
- コスト増加

**修正**:
- バッチ更新の導入
- 更新頻度の調整（5秒に1回など）
- ローカルキャッシュの活用

### 7. set_processing_lock() のタイムアウト処理なし (app.py:1078)
**問題**: ロック取得に失敗し続けた場合、無限に待機する可能性
**修正**: タイムアウトとリトライ回数の上限を設定

### 8. エラー時のロック解放漏れ (複数箇所)
**問題**: 一部の例外処理で set_processing_lock(False) を呼び出していない
**影響**: ロックが永久に保持され、以降の処理が開始できない
**修正**: すべてのエラーパスで finally を使用

### 9. CORS設定が全開放 (app.py:89)
```python
CORS(app)
```
**問題**: すべてのオリジンからのアクセスを許可
**影響**: CSRF攻撃のリスク
**修正**: 特定のオリジンのみ許可

### 10. 認証・認可の欠如
**問題**: すべてのエンドポイントが認証なしでアクセス可能
```python
@app.route('/start_processing', methods=['POST'])
def start_processing():
    # 認証チェックなし
```
**影響**:
- 不正な処理開始
- DoS攻撃
- データ漏洩

**修正**:
- API キー認証
- または JWT トークン認証
- サービスアカウント認証

### 11. APIキーがログに出力される可能性 (app.py:複数箇所)
**問題**: 環境変数をそのままログ出力する箇所がある
**修正**: ログ出力前にマスキング処理

### 12. 例外情報の詳細なスタックトレースを返している
**問題**: エラーレスポンスに完全なスタックトレースを含めている
**影響**: 内部構造の漏洩、攻撃の手がかりを与える
**修正**: 本番環境ではエラーメッセージのみ返す

### 13. stop_processing() の競合条件 (app.py:1301)
**問題**: ロック確認と設定の間にタイムラグがあり、競合状態が発生しうる
```python
lock_status = get_processing_lock()
if not lock_status:
    return error
# ← この間に別インスタンスが処理を開始する可能性
set_processing_lock(False)
```
**修正**: Compare-And-Swap (CAS) 操作を使用

### 14. reset_processing() に認証がない (app.py:1334)
**問題**: 誰でもシステムをリセットできる
**影響**: 処理中のジョブを強制終了できる
**修正**: 管理者認証を追加

### 15. メモリ使用率の計算が不正確な可能性 (app.py:470)
**問題**: cgroup のメモリ使用率計算でキャッシュメモリを考慮していない
**影響**: 実際より高いメモリ使用率を報告し、並列数を過度に抑制
**修正**: `memory.stat` からキャッシュメモリを取得して減算

---

## 優先度B: 重要な問題

### 16. エラーメッセージが英語と日本語混在
**問題**: 一貫性がない
**修正**: すべて英語に統一（ログは日本語可）

### 17. マジックナンバーが多数存在
```python
if memory_percent > 85.0:  # 85.0 とは？
    throttle_delay += 0.5   # 0.5 の根拠は？
```
**修正**: 定数として定義し、コメントで説明

### 18. get_processing_status() のN+1問題 (app.py:1316)
**問題**: 統計情報を取得するために複数回 Supabase にアクセス
**修正**: 1回のクエリで必要な情報をすべて取得

### 19. AdaptiveResourceManager の調整ロジックが複雑 (app.py:653-730)
**問題**:
- 条件分岐が多い
- テストが困難
- パラメータ調整が難しい

**修正**:
- ステートマシンパターンに変更
- 設定ファイルでパラメータを外部化

### 20. ログレベルが適切でない箇所がある
**問題**:
- 通常動作を INFO でログ出力（大量のログ）
- 重要なエラーを WARNING で出力

**修正**:
- 通常動作は DEBUG
- エラーは ERROR
- 想定外の事態は CRITICAL

### 21. process_document_safe() の命名が不適切 (app.py:1117)
**問題**: "safe" という名前だが、実際には例外を catch するだけで、完全に安全ではない
**修正**: `process_document_with_error_handling()` など、より正確な名前

### 22. 重複したエラーハンドリングコード
**問題**: 複数の関数で同じパターンのエラーハンドリング
**修正**: デコレーターまたはヘルパー関数に抽出

### 23. タイムアウト値がハードコード (app.py:1200)
```python
await asyncio.wait_for(process_document(...), timeout=1800)
```
**修正**: 環境変数で設定可能にする

### 24. メモリ情報の取得に失敗した場合のフォールバック不足
**問題**: cgroup 読み取りに失敗すると psutil にフォールバックするが、psutil も失敗する可能性を考慮していない
**修正**: デフォルト値を返す最終フォールバックを追加

### 25. process_queued_documents() が無限ループ (app.py:1193)
**問題**:
```python
while True:
    # 終了条件がない
```
**影響**: 正常終了のパスがない
**修正**: 終了フラグを追加

### 26. asyncio.sleep(0.1) の多用
**問題**: ポーリング待機で CPU リソースを無駄に消費
**修正**: イベント駆動に変更（asyncio.Event など）

### 27. ドキュメント処理の順序が保証されていない
**問題**: 並列処理により、queue_order が考慮されない
**影響**: 優先度の高いドキュメントが後回しになる可能性
**修正**: 優先度キューの実装

### 28. エラー時のリトライロジックがない
**問題**: 一時的なエラー（ネットワーク障害など）で処理が失敗
**修正**: Exponential Backoff を使用したリトライ

### 29. 大量のドキュメント処理時のメモリリーク可能性
**問題**: active_tasks や統計情報がクリアされない
**修正**: 定期的なクリーンアップ処理

### 30. CPU使用率の計算が不正確 (app.py:540-543)
**問題**: 短時間での使用率計算のため、値が不安定
**修正**: 移動平均を使用

---

## 優先度C: 改善項目

### 31-50: コードの可読性・保守性

31. 関数が長すぎる（process_queued_documents は200行以上）
32. クラスが大きすぎる（AdaptiveResourceManager が複雑）
33. コメントが不足している箇所がある
34. 変数名が不明確（mem_info, stats など）
35. 型ヒントが不足している箇所がある
36. docstring が不完全
37. デッドコードが残っている（未使用の import など）
38. 重複したロジック（メモリ取得が複数箇所に散在）
39. グローバル変数が多すぎる（10個以上）
40. 条件分岐が深すぎる箇所（ネスト5段以上）
41. elif の連鎖が長い
42. リスト内包表記が複雑で読みにくい
43. lambda 関数の多用
44. 一時変数が多すぎる
45. 関数の引数が多い（5個以上）
46. 戻り値の型が統一されていない（dict, tuple, None など）
47. 例外の種類が粗い（Exception を catch）
48. マジックメソッドの誤用
49. クラス変数とインスタンス変数の混在
50. 循環依存の可能性

### 51-80: テスト・品質保証

51. ユニットテストが存在しない
52. 統合テストが存在しない
53. エンドツーエンドテストが存在しない
54. テストカバレッジが測定されていない
55. モックの使用方法が不明確
56. テストデータの管理方法が不明確
57. CI/CD パイプラインでのテスト実行がない
58. パフォーマンステストが存在しない
59. ロードテストが存在しない
60. ストレステストが存在しない
61. セキュリティテストが存在しない
62. 静的解析ツールの未使用（pylint, mypy など）
63. コードフォーマッターの未使用（black, autopep8）
64. リンターの未使用（flake8）
65. 型チェッカーの未使用（mypy）
66. 依存関係の脆弱性チェック未実施
67. コードレビューのチェックリストがない
68. バグ追跡システムとの連携がない
69. バージョン管理のベストプラクティス未遵守
70. ブランチ戦略が不明確
71. コミットメッセージの規約がない
72. プルリクエストテンプレートがない
73. イシューテンプレートがない
74. 変更履歴の管理方法が不明確
75. リリースノートが存在しない
76. デプロイ手順が属人化
77. ロールバック手順が不明確
78. 障害対応手順が不明確
79. インシデント管理プロセスがない
80. ポストモーテムの習慣がない

### 81-110: ドキュメント・運用

81. README が不足
82. アーキテクチャ図がない
83. API ドキュメントがない（Swagger/OpenAPI）
84. 環境構築手順が不明確
85. デプロイ手順が部分的
86. トラブルシューティングガイドがない
87. FAQ がない
88. ユーザーマニュアルがない
89. 開発者ガイドがない
90. コントリビューションガイドがない
91. コーディング規約が文書化されていない
92. 設計思想が文書化されていない
93. 技術的負債の記録がない
94. 既知の問題のリストがない
95. ロードマップがない
96. パフォーマンスベンチマークがない
97. リソース要件が不明確
98. スケーラビリティの限界が不明
99. 監視・アラート設定が不足
100. ログ分析の手順がない
101. メトリクスの定義がない
102. SLI/SLO が定義されていない
103. エラーバジェットの概念がない
104. オンコール体制が不明確
105. エスカレーションパスが不明確
106. バックアップ戦略が不明確
107. ディザスタリカバリ計画がない
108. データ保持ポリシーが不明確
109. コンプライアンス要件が不明確
110. プライバシーポリシーが不明確

### 111-140: パフォーマンス・スケーラビリティ

111. データベースインデックスが最適化されていない
112. クエリが非効率（N+1問題）
113. キャッシュ戦略が不明確
114. CDN の活用がない
115. 静的ファイルの最適化がない
116. 画像の最適化がない
117. レスポンス圧縮が有効化されていない可能性
118. HTTP/2 の活用がない
119. コネクションプーリングの設定が不明確
120. タイムアウト設定が最適化されていない
121. バッチ処理の最適化が不十分
122. 非同期処理の最適化が不十分
123. メモリ使用量の最適化が不十分
124. CPU使用率の最適化が不十分
125. ディスクI/O の最適化が不十分
126. ネットワークI/O の最適化が不十分
127. 並列度の調整が手動
128. スケールアウトの自動化がない
129. スケールインの自動化がない
130. リソースの事前割り当てがない
131. ガベージコレクションの調整がない
132. メモリリークの検出がない
133. プロファイリングの実施がない
134. ボトルネック分析がない
135. レイテンシー測定がない
136. スループット測定がない
137. 同時接続数の制限がない
138. レート制限がない
139. サーキットブレーカーがない
140. バルクヘッドパターンの未実装

### 141-170: セキュリティ・コンプライアンス

141. SQL インジェクション対策が不明確
142. XSS 対策が不明確
143. CSRF トークンの実装がない
144. セッション管理が不適切
145. パスワードハッシュ化が不明確
146. 暗号化アルゴリズムの選定が不明確
147. TLS/SSL 設定が不明確
148. 証明書管理が不明確
149. シークレット管理が不適切（.env に直書き）
150. 環境変数の検証がない
151. 入力値の検証が不十分
152. 出力値のサニタイゼーションが不十分
153. ファイルアップロードの検証が不十分
154. ファイルサイズ制限がない
155. ファイルタイプ制限が不明確
156. ディレクトリトラバーサル対策が不明確
157. コマンドインジェクション対策が不明確
158. XXE 攻撃対策が不明確
159. SSRF 攻撃対策が不明確
160. リモートコード実行対策が不明確
161. 権限昇格対策が不明確
162. 水平権限移動対策が不明確
163. セッション固定攻撃対策が不明確
164. クリックジャッキング対策が不明確
165. オープンリダイレクト対策が不明確
166. 情報漏洩対策が不十分
167. ログインジェクション対策がない
168. タイミング攻撃対策が不明確
169. DDoS 対策が不明確
170. API レート制限が不明確

### 171-200: 設定・環境・依存関係

171. Python バージョンの指定が不明確
172. 依存パッケージのバージョン固定が不十分
173. requirements.txt と実際の環境の乖離
174. 開発環境と本番環境の差異が大きい
175. 環境変数の命名規則が不統一
176. 環境変数のデフォルト値がない
177. 環境変数の必須チェックがない
178. 設定ファイルのバリデーションがない
179. 設定の階層化がない（開発/ステージング/本番）
180. 機能フラグの仕組みがない
181. A/B テストの仕組みがない
182. カナリアデプロイの仕組みがない
183. ブルーグリーンデプロイの仕組みがない
184. ローリングアップデートの設定が不明確
185. ヘルスチェックエンドポイントが不完全
186. レディネスプローブが不明確
187. ライブネスプローブが不明確
188. スタートアッププローブがない
189. Graceful Shutdown が不完全
190. シグナルハンドリングが不明確
191. プロセス管理が不適切
192. ワーカープロセスの管理が不明確
193. メモリ制限の設定が不明確
194. CPU制限の設定が不明確
195. タイムアウト設定が不統一
196. リトライ設定が不統一
197. ロギング設定が不統一
198. 監視エージェントの設定が不明確
199. APM（Application Performance Monitoring）の未導入
200. 分散トレーシングの未導入

---

## 修正の進め方

### フェーズ1: 致命的な問題の修正（優先度S）
1. active_tasks/active_workers の型統一
2. global 宣言の追加
3. register_worker/unregister_worker の実装または削除
4. periodic_resource_update のエラーハンドリング
5. スレッドセーフティの確保

**所要時間**: 2-3時間
**デプロイ**: 即座に実施

### フェーズ2: 重大な問題の修正（優先度A）
6-15の問題を修正
- Supabase 書き込み最適化
- エラーハンドリング強化
- セキュリティ強化（認証、CORS）
- ロック処理の改善

**所要時間**: 1-2日
**デプロイ**: 段階的に実施

### フェーズ3: 重要な問題の修正（優先度B）
16-30の問題を修正
- コード品質向上
- パフォーマンス最適化
- リトライロジック追加

**所要時間**: 3-5日
**デプロイ**: 週次リリース

### フェーズ4: 改善項目（優先度C）
31-200の問題を段階的に修正
- リファクタリング
- テスト追加
- ドキュメント整備
- 監視強化

**所要時間**: 2-4週間
**デプロイ**: 計画的に実施

---

## 次のアクション

フェーズ1の修正を開始しますか？それとも特定の問題を優先的に修正しますか？
