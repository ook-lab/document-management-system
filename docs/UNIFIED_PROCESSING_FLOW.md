# çµ±åˆå‡¦ç†ãƒ•ãƒ­ãƒ¼ - Classroom/Driveãƒ«ãƒ¼ãƒˆçµ±åˆç‰ˆ

**ä½œæˆæ—¥**: 2025-12-12
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0 (çµ±åˆç‰ˆ)
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†

---

## ğŸ“‹ æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Classroom/Driveãƒ«ãƒ¼ãƒˆçµ±åˆå¾Œã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’èª¬æ˜ã—ã¾ã™ã€‚

### çµ±åˆã®ãƒ¡ãƒªãƒƒãƒˆ

1. **ã‚³ãƒ¼ãƒ‰é‡è¤‡å‰Šæ¸›**: `daily_sync.py` ãŒä¸è¦ã«
2. **è²¬ä»»ã®æ˜ç¢ºåŒ–**: GAS=ãƒ‡ãƒ¼ã‚¿åé›†ã€Python=AIå‡¦ç†
3. **å‡¦ç†ã®ä¸€è²«æ€§**: å˜ä¸€ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ç®¡ç†
4. **è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤**: å¤±æ•—æ™‚ã«æœ€å¤§3å›ã¾ã§è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
5. **é‹ç”¨ã‚³ã‚¹ãƒˆå‰Šæ¸›**: åŒã˜ãƒ•ãƒ­ãƒ¼ã§å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†

---

## ğŸ”„ å‡¦ç†ãƒ•ãƒ­ãƒ¼å…¨ä½“å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ãƒ‡ãƒ¼ã‚¿åé›†å±¤ï¼ˆGASï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                               â”‚
  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                                  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
  â”‚ Classroom â”‚                                  â”‚   Drive   â”‚
  â”‚   æŠ•ç¨¿    â”‚                                  â”‚  ãƒ•ã‚¡ã‚¤ãƒ«  â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                                               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supabase: documents ãƒ†ãƒ¼ãƒ–ãƒ«                        â”‚
â”‚         (processing_status = 'pending')                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
                    ã€Supabase Trigger è‡ªå‹•å®Ÿè¡Œã€‘
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Supabase: document_reprocessing_queue ãƒ†ãƒ¼ãƒ–ãƒ«           â”‚
â”‚              (status = 'pending')                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
                    ã€Python å®šæœŸå®Ÿè¡Œï¼ˆcronç­‰ï¼‰ã€‘
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          reprocess_classroom_documents_v2.py                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ 1. ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ pending/failed ã‚¿ã‚¹ã‚¯ã‚’å–å¾—       â”‚           â”‚
â”‚  â”‚    - pending å„ªå…ˆã€failed ã¯å¾Œå›ã—              â”‚           â”‚
â”‚  â”‚    - æœ€å¤§3å›ã¾ã§ãƒªãƒˆãƒ©ã‚¤ï¼ˆattempt_count < 3ï¼‰   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ 2. AIå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ                       â”‚           â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚           â”‚
â”‚  â”‚    â”‚ StageA: Gemini 2.5 Flashï¼ˆåˆ†é¡ï¼‰ â”‚         â”‚           â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚           â”‚
â”‚  â”‚                      â†“                           â”‚           â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚           â”‚
â”‚  â”‚    â”‚ StageB: Gemini 2.5 Proï¼ˆVisionï¼‰â”‚         â”‚           â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚           â”‚
â”‚  â”‚                      â†“                           â”‚           â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚           â”‚
â”‚  â”‚    â”‚ StageC: Claude Haiku 4.5ï¼ˆæŠ½å‡ºï¼‰â”‚         â”‚           â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ 3. ãƒãƒ£ãƒ³ã‚¯åŒ–å‡¦ç†                               â”‚           â”‚
â”‚  â”‚    - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒ³ã‚¯ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ã‚µãƒãƒªãƒ¼ç­‰ï¼‰â”‚           â”‚
â”‚  â”‚    - å°ãƒãƒ£ãƒ³ã‚¯ï¼ˆ150æ–‡å­—å˜ä½ï¼‰                  â”‚           â”‚
â”‚  â”‚    - å¤§ãƒãƒ£ãƒ³ã‚¯ï¼ˆå…¨æ–‡ï¼‰                         â”‚           â”‚
â”‚  â”‚    - åˆæˆãƒãƒ£ãƒ³ã‚¯ï¼ˆæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼‰               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°                             â”‚           â”‚
â”‚  â”‚    - documents.processing_status = 'completed'  â”‚           â”‚
â”‚  â”‚    - document_chunks ã«ãƒãƒ£ãƒ³ã‚¯ã‚’ä¿å­˜           â”‚           â”‚
â”‚  â”‚    - queue.status = 'completed'                 â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‡¦ç†å®Œäº†ãƒ»æ¤œç´¢å¯èƒ½                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®è©³ç´°

### Phase 1: ãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆGASï¼‰

**å®Ÿè¡Œé »åº¦**: å®šæœŸå®Ÿè¡Œï¼ˆä¾‹: 1æ—¥1å›ã€æ‰‹å‹•å®Ÿè¡Œå¯ï¼‰

#### Classroomãƒ«ãƒ¼ãƒˆ

```javascript
// gas/ClassroomToSupabase_updated.gs

1. Google Classroom APIã‹ã‚‰æŠ•ç¨¿ã‚’å–å¾—
   - ãŠçŸ¥ã‚‰ã›ã€èª²é¡Œã€è³‡æ–™

2. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
   - Google Driveã«ã‚³ãƒ”ãƒ¼
   - ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ¨©é™ä»˜ä¸

3. Supabaseã«æŠ•å…¥
   source_type: 'classroom' or 'classroom_text'
   processing_status: 'pending'  â† â˜…é‡è¦
   ingestion_route: 'classroom'
```

#### Driveãƒ«ãƒ¼ãƒˆï¼ˆæ–°è¦ï¼‰

```javascript
// æ–°è¦GASã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰

1. æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€ã‚’ç›£è¦–
2. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
3. Supabaseã«æŠ•å…¥
   source_type: 'drive'
   processing_status: 'pending'  â† â˜…é‡è¦
   ingestion_route: 'drive'
```

### Phase 2: è‡ªå‹•ã‚­ãƒ¥ãƒ¼è¿½åŠ ï¼ˆSupabase Triggerï¼‰

**å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**: `documents` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®INSERTæ™‚

```sql
-- database/schema_updates/v10_auto_queue_trigger.sql

CREATE TRIGGER trigger_auto_queue_on_insert
AFTER INSERT ON documents
FOR EACH ROW
EXECUTE FUNCTION auto_add_to_reprocessing_queue();
```

**å‡¦ç†å†…å®¹**:
1. `processing_status = 'pending'` ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿å¯¾è±¡
2. é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢ã«ã‚­ãƒ¥ãƒ¼ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
3. `document_reprocessing_queue` ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 

### Phase 3: AIå‡¦ç†ï¼ˆPythonï¼‰

**å®Ÿè¡Œé »åº¦**: å®šæœŸå®Ÿè¡Œï¼ˆä¾‹: 10åˆ†ã”ã¨ï¼‰

```bash
# cronè¨­å®šä¾‹
*/10 * * * * cd /path/to/project && python reprocess_classroom_documents_v2.py --process-queue --limit=50
```

**å‡¦ç†å†…å®¹**:

#### 3-1. ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã‚¿ã‚¹ã‚¯å–å¾—

```python
# reprocess_classroom_documents_v2.py

def _get_next_task(self):
    # SQLé–¢æ•°ã‚’å‘¼ã³å‡ºã—
    response = self.db.client.rpc(
        'get_next_reprocessing_task',
        {'p_worker_id': self.worker_id}
    ).execute()
```

**SQLé–¢æ•°**:
```sql
-- å„ªå…ˆé †ä½:
-- 1. status = 'pending' ã‚’å„ªå…ˆ
-- 2. status = 'failed' ã‹ã¤ attempt_count < max_attempts
-- 3. priority DESCï¼ˆå„ªå…ˆåº¦ãŒé«˜ã„ã‚‚ã®ï¼‰
-- 4. created_at ASCï¼ˆå¤ã„ã‚‚ã®ï¼‰

SELECT id FROM document_reprocessing_queue
WHERE (status = 'pending' OR status = 'failed')
  AND attempt_count < max_attempts
ORDER BY
  CASE WHEN status = 'pending' THEN 0 ELSE 1 END,
  priority DESC,
  created_at ASC
LIMIT 1
FOR UPDATE SKIP LOCKED;
```

#### 3-2. AIå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```python
# pipelines/two_stage_ingestion.py

async def process_file(self, file_meta, workspace, force_reprocess=True):
    # StageA: Gemini 2.5 Flashï¼ˆåˆ†é¡ï¼‰
    stage1_result = await classifier.classify(...)

    # StageB: Gemini 2.5 Proï¼ˆVisionå‡¦ç†ï¼‰
    vision_result = await vision_processor.process(...)

    # StageC: Claude Haiku 4.5ï¼ˆè©³ç´°æŠ½å‡ºï¼‰
    stage2_result = extractor.extract_metadata(...)

    # ãƒãƒ£ãƒ³ã‚¯åŒ–
    chunks = metadata_chunker.create_chunks(...)
```

#### 3-3. ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥

```python
# è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ¡ä»¶
if attempt_count < max_attempts (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3):
    status = 'pending'  # è‡ªå‹•ã§å†è©¦è¡Œã•ã‚Œã‚‹
else:
    status = 'failed'   # ã‚‚ã†å†è©¦è¡Œã•ã‚Œãªã„
```

---

## ğŸ” å‡¦ç†çŠ¶æ…‹ã®é·ç§»å›³

```
ã€æ­£å¸¸ãƒ•ãƒ­ãƒ¼ã€‘
pending â†’ processing â†’ completed

ã€å¤±æ•—æ™‚ï¼ˆãƒªãƒˆãƒ©ã‚¤ã‚ã‚Šï¼‰ã€‘
pending â†’ processing â†’ failed (attempt_count=1)
        â†’ processing â†’ failed (attempt_count=2)
        â†’ processing â†’ failed (attempt_count=3)
        â†’ çµ‚äº†ï¼ˆã“ã‚Œä»¥ä¸Šãƒªãƒˆãƒ©ã‚¤ã—ãªã„ï¼‰

ã€ã‚¹ã‚­ãƒƒãƒ—ã€‘
pending â†’ processing â†’ skipped
```

---

## ğŸ“ˆ ç›£è¦–ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚­ãƒ¥ãƒ¼ã®çŠ¶æ…‹ç¢ºèª

```sql
-- ã‚­ãƒ¥ãƒ¼ã®çµ±è¨ˆ
SELECT
  status,
  COUNT(*) as count,
  AVG(attempt_count) as avg_attempts
FROM document_reprocessing_queue
GROUP BY status;

-- çµæœä¾‹:
--  status     | count | avg_attempts
-- ------------|-------|-------------
--  pending    |   150 |         0.0
--  processing |     5 |         1.2
--  completed  |  2340 |         1.1
--  failed     |    12 |         3.0
```

### å¤±æ•—ã‚¿ã‚¹ã‚¯ã®ç¢ºèª

```sql
-- 3å›å¤±æ•—ã—ãŸã‚¿ã‚¹ã‚¯ï¼ˆã‚‚ã†å†è©¦è¡Œã•ã‚Œãªã„ï¼‰
SELECT
  q.id,
  q.document_id,
  q.original_file_name,
  q.attempt_count,
  q.last_error_message,
  q.last_attempt_at
FROM document_reprocessing_queue q
WHERE q.status = 'failed'
  AND q.attempt_count >= q.max_attempts
ORDER BY q.last_attempt_at DESC
LIMIT 20;
```

### å‡¦ç†ä¸­ã®ã‚¿ã‚¹ã‚¯ç¢ºèª

```sql
-- å‡¦ç†ä¸­ã®ã‚¿ã‚¹ã‚¯
SELECT
  q.id,
  q.original_file_name,
  q.processed_by,
  q.processing_started_at,
  NOW() - q.processing_started_at as duration
FROM document_reprocessing_queue q
WHERE q.status = 'processing'
ORDER BY q.processing_started_at ASC;
```

### ãƒ­ã‚°ç¢ºèª

```bash
# æœ€æ–°ã®ãƒ­ã‚°ã‚’ç¢ºèª
tail -f logs/reprocess_classroom_documents_v2_*.log

# ã‚¨ãƒ©ãƒ¼ã®ã¿æŠ½å‡º
grep "ERROR\|âŒ" logs/reprocess_classroom_documents_v2_*.log
```

---

## ğŸ› ï¸ é‹ç”¨æ‰‹é †

### åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### 1. Supabaseã«ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆ

```bash
# Supabase SQL Editorã§å®Ÿè¡Œ
# database/schema_updates/v10_auto_queue_trigger.sql ã®å†…å®¹ã‚’å®Ÿè¡Œ
```

#### 2. GASã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨­å®š

```javascript
// gas/ClassroomToSupabase_updated.gs

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä»¥ä¸‹ã‚’è¨­å®š
SUPABASE_URL: 'https://your-project.supabase.co'
SUPABASE_KEY: 'your-anon-key'
DEST_FOLDER_ID: 'your-folder-id'
```

#### 3. Pythonå®šæœŸå®Ÿè¡Œã®è¨­å®š

```bash
# crontabã«è¿½åŠ 
crontab -e

# 10åˆ†ã”ã¨ã«å®Ÿè¡Œï¼ˆæœ€å¤§50ä»¶å‡¦ç†ï¼‰
*/10 * * * * cd /k/document-management-system && /k/document-management-system/venv/bin/python reprocess_classroom_documents_v2.py --process-queue --limit=50 >> /k/document-management-system/logs/cron.log 2>&1
```

### æ—¥å¸¸é‹ç”¨

#### GASã®æ‰‹å‹•å®Ÿè¡Œï¼ˆå¿…è¦æ™‚ï¼‰

```
1. Google Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã
2. é–¢æ•°ã€ŒsyncAllClassroomsToDocumentsã€ã‚’é¸æŠ
3. å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
```

#### å‡¦ç†çŠ¶æ³ã®ç¢ºèª

```bash
# ã‚­ãƒ¥ãƒ¼ã®çµ±è¨ˆã‚’ç¢ºèª
python -c "
from reprocess_classroom_documents_v2 import ClassroomReprocessorV2
reprocessor = ClassroomReprocessorV2()
reprocessor.print_queue_stats()
"
```

#### å¤±æ•—ã‚¿ã‚¹ã‚¯ã®æ‰‹å‹•ãƒªãƒˆãƒ©ã‚¤

```sql
-- ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã‚’æŒã¤failedã‚¿ã‚¹ã‚¯ã‚’pendingã«æˆ»ã™
UPDATE document_reprocessing_queue
SET status = 'pending',
    attempt_count = 0  -- ãƒªã‚»ãƒƒãƒˆ
WHERE status = 'failed'
  AND last_error_message LIKE '%rate limit%'  -- ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼
  AND attempt_count >= max_attempts;
```

---

## ğŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docs/GAS_INTEGRATION_GUIDE.md`: GASçµ±åˆã‚¬ã‚¤ãƒ‰ï¼ˆè©³ç´°ä»•æ§˜ï¼‰
- `PROJECT_EVALUATION_REPORT_20251212.md`: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“è©•ä¾¡
- `scripts/archive/ARCHIVED_DAILY_SYNC_README.md`: daily_sync.py ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”±

### ã‚³ãƒ¼ãƒ‰

- `gas/ClassroomToSupabase_updated.gs`: GASã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆClassroomï¼‰
- `reprocess_classroom_documents_v2.py`: çµ±ä¸€å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `pipelines/two_stage_ingestion.py`: AIå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- `core/ai/stageA_classifier.py`: StageAåˆ†é¡
- `core/ai/stageB_vision.py`: StageB Visionå‡¦ç†
- `core/ai/stageC_extractor.py`: StageCè©³ç´°æŠ½å‡º
- `core/processing/metadata_chunker.py`: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒ³ã‚¯åŒ–

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- `database/schema_updates/v9_add_reprocessing_queue.sql`: ã‚­ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
- `database/schema_updates/v10_auto_queue_trigger.sql`: è‡ªå‹•ã‚­ãƒ¥ãƒ¼è¿½åŠ ãƒˆãƒªã‚¬ãƒ¼

---

## âš ï¸ æ³¨æ„äº‹é …

### å‡¦ç†æ™‚é–“

- **1ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Š**: ç´„10-30ç§’ï¼ˆAIãƒ¢ãƒ‡ãƒ«ã®å¿œç­”æ™‚é–“ã«ä¾å­˜ï¼‰
- **ãƒãƒƒãƒå‡¦ç†**: 50ä»¶ã§ç´„10-20åˆ†

### APIåˆ¶é™

- **Gemini API**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«æ³¨æ„ï¼ˆå¿…è¦ã«å¿œã˜ã¦`--limit`ã‚’èª¿æ•´ï¼‰
- **Claude API**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«æ³¨æ„

### ã‚³ã‚¹ãƒˆ

| ãƒ«ãƒ¼ãƒˆ | StageA | StageB | StageC | 1ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Šæ¦‚ç®— |
|-------|--------|--------|--------|-------------------|
| Classroom/Drive | Gemini Flash | Gemini Pro | Claude Haiku | ~$0.005 |
| ãƒ¡ãƒ¼ãƒ« | Gemini Flash-lite | Gemini Flash | Gemini Flash | ~$0.001 |

---

## ğŸ‰ ã¾ã¨ã‚

### çµ±åˆå®Œäº†é …ç›®

- âœ… `get_next_reprocessing_task` é–¢æ•°ä¿®æ­£ï¼ˆfailedè‡ªå‹•ãƒªãƒˆãƒ©ã‚¤å¯¾å¿œï¼‰
- âœ… GASçµ±åˆã‚¬ã‚¤ãƒ‰ä½œæˆ
- âœ… Supabase Triggerä½œæˆï¼ˆè‡ªå‹•ã‚­ãƒ¥ãƒ¼è¿½åŠ ï¼‰
- âœ… `daily_sync.py` ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
- âœ… çµ±åˆå‡¦ç†ãƒ•ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Supabase Triggerã‚’å®Ÿè¡Œ**: `v10_auto_queue_trigger.sql` ã‚’Supabase SQL Editorã§å®Ÿè¡Œ
2. **GASã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›´æ–°**: `processing_status = 'pending'` ã¨ `ingestion_route` ã‚’è¿½åŠ 
3. **Pythonå®šæœŸå®Ÿè¡Œã‚’è¨­å®š**: cronã¾ãŸã¯GitHub Actionsã§è¨­å®š
4. **å‹•ä½œç¢ºèª**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§çµ±åˆãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèª

---

**æœ€çµ‚æ›´æ–°**: 2025-12-12
**ä½œæˆè€…**: Claude Code (Sonnet 4.5)
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0
