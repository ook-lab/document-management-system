{
  "domain_id": "yotsuya_hensachi",
  "domain_label": "Yotsuya Otsuka Deviation Value List",
  "version": "3.2",

  "fingerprint": {
    "keywords": ["四谷大塚", "合不合判定", "80偏差値", "Aライン"],
    "structural_detection": {
      "required_text": "偏差値"
    }
  },

  "max_entity_length": 30,

  "special_markers": ["☆", "◇", "▼", "●", "□", "◎", "○", "△"],

  "table_rules": {
    "require_entity_text": {
      "enabled": true,
      "description": "エンティティ（学校名）には非数字のテキストが必須。数値のみのセルは学校名とみなさない",
      "rule": "entityフィールドに漢字・ひらがな・カタカナ・英字のいずれかが1文字以上含まれていなければ無効として除外する",
      "min_entity_chars": 2,
      "min_entity_chars_description": "1文字のみ（「三」「力」等）のエンティティは除外する。ただしcell_splitting内で学校名の一部として連結される場合は例外",
      "examples_invalid": ["36", "35", "34", "32", "70", "三", "力"],
      "examples_valid": ["開成", "聖光学院2", "☆筑波大駒場", "芝"]
    },

    "format_detection": {
      "flat_indicator_col_header": "学校名",
      "only_these_headers": [
        "1月前半(~ 1/19)",
        "1月後半(1/20 ~)",
        "2/1 午前",
        "2/1 午後",
        "2/2 午前",
        "2/2 午後",
        "2/3",
        "2/4 ~"
      ],
      "columns": [
        {
          "header": "1月前半(~ 1/19)",
          "date_rule": "superscript",
          "date_rule_description": "肩付き注釈に記載された具体日付を使用する",
          "default_date": null
        },
        {
          "header": "1月後半(1/20 ~)",
          "date_rule": "superscript",
          "date_rule_description": "肩付き注釈に記載された具体日付を使用する",
          "default_date": null
        },
        {
          "header": "2/1 午前",
          "date_rule": "fixed",
          "date": "2/1 午前"
        },
        {
          "header": "2/1 午後",
          "date_rule": "fixed",
          "date": "2/1 午後"
        },
        {
          "header": "2/2 午前",
          "date_rule": "fixed",
          "date": "2/2 午前"
        },
        {
          "header": "2/2 午後",
          "date_rule": "fixed",
          "date": "2/2 午後"
        },
        {
          "header": "2/3",
          "date_rule": "fixed",
          "date": "2/3"
        },
        {
          "header": "2/4 ~",
          "date_rule": "divider_with_default",
          "date_rule_description": "デフォルトは '2/4'。日付デバイダーで上書き。肩付き日付があればさらに優先",
          "default_date": "2/4",
          "divider_propagation": "forward_fill_only"
        }
      ]
    },

    "date_divider_rows": {
      "description": "日付セルによる日程更新は、以下の幾何学的条件を満たす場合のみ、その直下の学校に限定して適用する",
      "strict_contact_rule": {
        "enabled": true,
        "max_vertical_distance_px": 10,
        "horizontal_overlap_required": "left_half",
        "trigger_sequence": "date_on_top_then_school_below",
        "propagation": "none",
        "propagation_description": "行以降への伝播は一切禁止。直下の1校に適用した時点で終了せよ"
      }
    },

    "superscript_dates": {
      "description": "データゾーン内の日付セルは肩付き日付として扱い、その直下の学校1校の col_header を置き換える",
      "enabled": true,
      "detection": {
        "source": "data_zone_cells",
        "source_description": "is_header=false のデータセルのみを対象",
        "pattern": "([0-9]{1,2})/([0-9]{1,2})",
        "pattern_description": "M/D 形式の日付パターン（例: 2/5, 1/15）"
      },
      "replacement": {
        "target": "直下の学校1校",
        "max_vertical_distance_px": 10,
        "max_vertical_distance_description": "肩付き日付セルの bbox 下端から、対象セルの bbox 上端までの垂直距離が10ピクセル以内",
        "scope": "1校のみ",
        "scope_description": "条件を満たす最初の1校のセルのみを対象。複数の学校にはマッチしない",
        "replace_field": "col_header",
        "replace_field_description": "学校セルの col_header（例: '2/4 ~'）を肩付き日付テキスト（例: '2/5'）で上書き"
      },
      "visibility": {
        "hide_superscript": true,
        "hide_superscript_description": "肩付き日付セル自体は最終出力では非表示とする（_hidden=true フラグを立てる）"
      }
    },

    "session_number": {
      "description": "学校名末尾の1桁数字は入試回次（第N回）を意味する。ただし直前の文字が数字でないこと",
      "pattern": "(?<=\\D)(\\d)$ — 直前が非数字の場合のみ末尾1桁をキャプチャ",
      "interpret_as_date_index": true,
      "interpret_as_date_index_description": "回次は試験日を特定する手がかりになる。例: session=2 の場合、その学校の第2回入試の日程を適用"
    },

    "marker_separation": {
      "strip_from_entity": true,
      "prepend_to_display_name": true
    },

    "metric_validation": {
      "type": "integer_range",
      "min": 30,
      "max": 80
    },

    "date_normalization": {
      "output_format": "M/D or M/D 午前|午後",
      "keep_ampm": true,
      "keep_ampm_description": "「2/1 午前」「2/1 午後」の午前/午後は日付の一部として保持する",
      "input_patterns": [
        {"regex": "(\\d{4})-(\\d{1,2})-(\\d{1,2})", "groups": [2, 3]},
        {"regex": "(\\d{1,2})月(\\d{1,2})", "groups": [1, 2]},
        {"regex": "(\\d{1,2})/(\\d{1,2})", "groups": [1, 2]}
      ]
    },

    "dedup": {
      "key_fields": ["entity", "row_header", "col_header", "session"]
    },

    "sort": {
      "field": "row_header",
      "order": "descending",
      "type": "integer"
    }
  },

  "grid_construction": {
    "row_sort": "integer_descending",
    "col_sort": "date_md_ascending",
    "cell_separator": "\n",
    "context_aware_date": true,
    "direction": "downward",
    "ampm_columns": "「2/1 午前」「2/1 午後」「2/2 午前」「2/2 午後」は別カラムとして扱う",
    "panel_column_resolution": {}
  }
}
