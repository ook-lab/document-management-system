# ============================================
# 統一パイプライン プロンプト設定
# ============================================
# 全ステージのプロンプトを一元管理
#
# 使用方法:
#   config_loader.get_prompt('stage_f/default')
#   -> prompts.stage_f.default の内容を返す

prompts:
  stage_f:
    default: |
      # Stage F: Visual Analysis - Classroom Documents
      
      あなたはGoogle Classroom課題ドキュメントの視覚解析を専門とするAIアシスタントです。
      
      ## タスク
      
      Stage E で抽出したテキストを基準として、画像を詳細に見て、**完璧な3つの情報**を作成してください。
      
      ## 出力する情報
      
      1. **全テキスト（完璧版）**
         - **Stage E のテキストを基準として、画像と照合して以下を行う:**
           - **検証**: Stage E のテキストが正しいか確認
           - **修正**: 間違いがあれば正しく修正
           - **補完**: 欠けている部分を補完（画像化されたタイトル、ロゴ、装飾文字など）
         - **結果として、全ての文字を1文字も漏らさない完璧なテキストを作成**
         - 課題タイトル、本文、期限、添付ファイル情報、UI要素、**表の全データ**、全て含む
         - **重要**: Stage E に表が含まれている場合、その表の全データを `full_text` に含めてください
         - レイアウトと位置関係を保持
         - 表、リスト、見出しなどの構造を維持
      
      2. **レイアウト情報**
         - セクション区切り
         - **表構造（行・列）**: Stage E に表が含まれている場合、全ての表を `layout_info.tables` に格納してください
         - リスト項目
         - 見出しレベル

      3. **視覚的要素**
         - 強調されているテキスト（太字、色付きなど）
         - 提出期限の表示
         - 重要マーク・アイコン
         - 添付ファイルのリスト

      4. **構造化データの抽出**
         - 視覚的に表として表示されていなくても、文章中に含まれる構造化データを識別して表形式に変換してください
         - 例: 課題の配点情報、提出要件、スケジュール情報など
         - 価格情報、数量情報、日時情報、メタデータなど、構造化可能な情報は全て表形式に変換してください
         - データソース情報（例: 投稿文の文字数、OCRテキストの文字数など）も表形式で記録してください
      
      ## 出力形式
      
      JSON形式で以下の構造で出力してください：
      
      ```json
      {{
        "full_text": "完璧な全テキスト（Stage E を検証・修正・補完した結果）",
        "layout_info": {{
          "sections": [
            {{
              "type": "heading/paragraph/table/list/deadline",
              "content": "セクションの内容",
              "level": 1
            }}
          ],
          "tables": [
            {{
              "table_title": "表のタイトル（任意）",
              "table_type": "visual_table/structured_data/metadata/requirements など",
              "rows": [["ヘッダー1", "ヘッダー2"], ["データ1", "データ2"]],
              "caption": "表の説明"
            }}
          ]
        }},
        "visual_elements": {{
          "emphasized_text": ["強調されているテキスト"],
          "deadline_info": "提出期限（YYYY-MM-DD HH:MM形式）",
          "attachments": ["ファイル名1", "ファイル名2"],
          "notes": ["注釈・コメント"]
        }}
      }}
      ```
      
      ## 注意事項
      
      - 手書き文字も可能な限り読み取る
      - 日付は必ず YYYY-MM-DD 形式に統一
      - 不明な情報は null とする
      
      **重要:**
      - **Stage E のテキストを基準として、画像を詳細に見て検証・修正・補完してください**
      - **間違いがあれば正しく修正し、欠けている部分があれば全て補完してください**
      - **文字が省略されたり、間引かれたりすることは絶対に許されません**
      - **UIボタン、メニュー、装飾文字、全て含めてください**
      - レイアウト構造を正確に把握してください
      - **構造化可能なデータは全て `layout_info.tables` に表形式で含めてください**
      - 表には `table_type` フィールドを追加して、表の種類を明示してください（visual_table, structured_data, metadata, requirements など）
      
      ## Stage E テキストの活用方法
      
      **Stage E のテキストが提供されている場合:**
      1. **基準として使用**: Stage E のテキストはほぼ正確なので、これを基準とする
      2. **画像と照合**: 画像を見て、Stage E のテキストが正しいか検証する
      3. **間違いを修正**: もし間違いがあれば、画像を見て正しく修正する
      4. **表の検証と修正**:
         - Stage E に表が含まれている場合、画像を見て表の内容が正しいか検証する
         - 表のセルの値が間違っている場合は、画像を見て正しく修正する
         - 表の構造（行数・列数）が間違っている場合は、画像を見て正しく修正する
         - 表に欠けているデータがある場合は、画像を見て補完する
      5. **欠けている部分を補完**:
         - 画像化されたタイトル、ロゴ、装飾文字
         - 背景画像として配置された文字、透かし文字
         - 小さな文字、注釈、脚注、コピーライト表記
         - その他、Stage E が見逃した文字を全て補完
      
      **検証・補完の原則:**
      - **full_text の文字数 >= Stage E のテキスト文字数** であるべき
      - もし full_text の文字数が少ない場合、文字を削除しています（許されません）
      - **Stage E のテキストを削除せず、欠けている文字を追加してください**
      - **Stage E に表が含まれている場合**:
        - 表の全データを `full_text` に含める（1文字も削除厳禁）
        - 表の構造を `layout_info.tables` に格納する
        - 表の情報を失うことは絶対に許されません
      

    flyer: |
      あなたはスーパーマーケットのチラシから視覚情報を抽出する専門家です。
      
      このチラシ画像から、人間が見たままの視覚情報をそのまま抽出してください。
      
      ## 抽出する情報
      
      1. **全テキスト（OCR）**
         - チラシ内のすべてのテキストを抽出
         - 商品名、価格、単位、説明文など全て
         - レイアウトと位置関係を保持
         - 表、リスト、見出しなどの構造を維持
      
      2. **レイアウト情報**
         - セクション区切り（カテゴリ別など）
         - 商品グループ
         - 価格表示の位置
         - 特売・セール情報の強調部分

      3. **視覚的要素**
         - 強調されているテキスト（赤字、大文字など）
         - 価格の表示形式（税込/税抜）
         - 商品画像の位置とキャプション
         - セール期間、注釈、ポイント情報

      4. **構造化データの抽出**
         - 商品情報（商品名、価格、割引、最終価格など）を表形式で抽出してください
         - 例: 「100円のリンゴが20％オフで80円」→ 表形式: [["商品", "通常価格", "割引", "販売価格"], ["リンゴ", "100円", "20％オフ", "80円"]]
         - カテゴリ別の商品リスト、セール情報、価格比較なども表形式に変換してください
         - データソース情報（例: 抽出したテキストの文字数、商品数など）も表形式で記録してください
      
      ## 出力形式
      
      JSON形式で以下の構造で出力してください：
      
      ```json
      {{
        "full_text": "抽出した全テキスト（改行や空白を保持）",
        "layout_info": {{
          "sections": [
            {{
              "type": "heading/product_group/sale_section",
              "content": "セクションの内容",
              "level": 1
            }}
          ],
          "tables": [
            {{
              "table_title": "商品リスト（カテゴリ名など）",
              "table_type": "product_list/pricing/sale_items など",
              "rows": [["商品名", "通常価格", "割引", "販売価格"], ["リンゴ", "100円", "20％オフ", "80円"]],
              "caption": "表の説明"
            }}
          ],
          "product_items": [
            {{
              "position": "左上",
              "text": "商品名と価格のテキスト"
            }}
          ]
        }},
        "visual_elements": {{
          "emphasized_prices": ["198円", "特価380円"],
          "sale_periods": ["3/15～3/20"],
          "notes": ["ポイント5倍", "数量限定"]
        }}
      }}
      ```

      **重要:**
      - 価格情報は絶対に省略しないでください
      - 商品名は完全な形で抽出してください
      - 税込/税抜の表記も必ず含めてください
      - セール期間や条件も正確に抽出してください
      - **商品情報は `layout_info.tables` に表形式で含めてください**
      - 表には `table_type` フィールドを追加して、表の種類を明示してください（product_list, pricing, sale_items など）
      

    kakeibo: |
      あなたはレシート画像からすべてのテキスト情報を抽出する専門家です。
      
      この画像に印字されているすべての文字・数字・記号を、一字一句漏らさず抽出してください。
      
      ## 最重要原則
      
      このタスクの目的は「人間の目の代わり」として機能することです。
      人間がレシートを見て読み取れるすべての情報を抽出してください。
      
      ## 抽出する情報
      
      ### 1. 全テキスト（上から下へ、順番に）
      - 店舗名
      - 住所、電話番号
      - 営業時間、店舗コード
      - すべての商品名（略語もそのまま）
      - すべての数量、単価、金額
      - 税率マーク（※、★、8%、10%など）
      - **【重要】税額情報（特に注意して正確に読み取る）:**
        - 小計の金額
        - 「外税 8%対象額」または「8%対象額」の行とその金額
        - 「外税 8%」または「8%税」の行とその金額
        - 「外税10%対象額」または「10%対象額」の行とその金額
        - 「外税10%」または「10%税」の行とその金額
        - 内税の場合は「内税額」「うち消費税」などの行とその金額
      - 合計金額
      - お預かり、お釣り
      - レジ番号、取引番号、レシート番号
      - 日付、時刻
      - バーコード番号
      - ポイント情報、キャンペーン情報
      - その他、すべての印字テキスト
      
      ### 2. レイアウト情報
      - 各行の位置（左寄せ/中央/右寄せ）
      - フォントサイズ（大/中/小）
      - 強調表示（太字、二重線など）
      - 行の区切り、空行
      
      ### 3. 数値情報
      - すべての数値をそのまま記録
      - 推測・計算は一切しない
      - カンマ、小数点もそのまま

      ### 4. 構造化データの抽出
      - 商品リスト（商品名、数量、単価、金額）を表形式で抽出してください
      - 税額情報（税率、対象額、税額）を表形式で抽出してください
      - 支払情報（小計、税額、合計、お預かり、お釣り）を表形式で抽出してください

      ## 出力形式

      JSON形式で以下の構造で出力してください：

      ```json
      {
        "raw_text": "レシート全体のテキスト（改行・スペースを含む、一字一句そのまま）",
        "lines": [
          {
            "line_number": 1,
            "text": "この行のテキスト",
            "alignment": "left/center/right",
            "font_size": "large/normal/small",
            "emphasized": true/false
          }
        ],
        "structured_tables": [
          {
            "table_title": "購入商品リスト",
            "table_type": "item_list",
            "rows": [["商品名", "数量", "単価", "金額"], ["商品A", "1", "100", "100"]]
          },
          {
            "table_title": "税額情報",
            "table_type": "tax_info",
            "rows": [["税率", "対象額", "税額"], ["8%", "1000", "80"], ["10%", "500", "50"]]
          },
          {
            "table_title": "支払情報",
            "table_type": "payment_info",
            "rows": [["項目", "金額"], ["小計", "1500"], ["消費税", "130"], ["合計", "1630"], ["お預かり", "2000"], ["お釣り", "370"]]
          }
        ],
        "detected_elements": {
          "has_store_name": true,
          "has_address": true,
          "has_phone": true,
          "has_store_code": true,
          "has_date": true,
          "has_time": true,
          "has_items": true,
          "has_subtotal": true,
          "has_tax_8": true,
          "has_tax_10": true,
          "has_total": true,
          "has_payment_info": true,
          "has_receipt_number": true
        },
        "notes": "読み取りにくい箇所、不鮮明な箇所があればここに記載"
      }
      ```
      
      ## 重要な注意

      - **すべての文字を抽出**：省略、間引き、推測は一切禁止
      - **レイアウトを保持**：位置関係、行の区切りを保持
      - **数値はそのまま**：計算しない、推測しない
      - **税額欄の数値は特に慎重に**：
        - 右寄せの小さい数字も正確に読み取る
        - 例: 「¥55」は55であり、4や5ではない
        - 例: 「¥68」は68であり、118や8ではない
        - 桁数を正確に（1桁、2桁、3桁など）
      - **税率マークを保持**：※、★、8%、10% などのマークをそのまま記録
      - **不明な文字**：読み取れない場合は「[不明]」と記載
      - **構造化テーブルを作成**：商品リスト、税額情報、支払情報を `structured_tables` に表形式で含めてください
      
      ## エラー処理
      
      - 複数のレシートが写っている場合：`{"error": "multiple_receipts"}`
      - レシート以外の画像の場合：`{"error": "not_a_receipt"}`
      - 画像が不鮮明で読み取れない場合：`{"error": "unreadable", "details": "不鮮明な箇所の説明"}`
      

  # ============================================
  # Stage G: 論理的精錬（Logical Refinement）
  # ============================================
  # 役割: Stage F の冗長な出力を整理し、後続が引用しやすい「REF_ID付き目録」を作成
  # 使用モデル: gemini-2.0-flash-lite（低コスト）
  # ============================================
  stage_g:
    # モデル設定（stage_g_refiner.pyで使用）
    model: "gemini-2.0-flash-lite"

    default: |
      あなたは公文書の管理・整理の専門家です。
      Stage Fで物理的に抽出された冗長なデータを整理し、「重複が一切なく、かつ1文字も情報の欠落がない」正本JSONを作成してください。

      【入力データ】
      投稿本文（post_body）: $post_body_text

      テキストブロック（$text_blocks_count個）:
      $text_blocks_json

      表データ（$tables_count個）:
      $tables_json

      【整理ルール（能力の死守）】
      1. **情報の完全維持**: 数値、日付、小さな注釈、手書き文字の読み取り結果など、入力にある全ての事実を1文字も漏らさず残してください。
      2. **重複の知能的排除**: 同じ内容が「本文」と「表」にある場合、より構造的に正しい方（例：表データ）を優先し、二重書きを解消してください。
      3. **参照IDの付与**: 各要素に `REF_001` から始まる一意の参照IDを付与してください。
      4. **統合Markdownの生成**: 読み順に従い、人間が通読可能な「お掃除済み」の1本のMarkdownテキスト（unified_text）を作成してください。

      【出力JSON形式】
      {
        "unified_text": "整理されたMarkdown全文（ここが後の正本になる）",
        "source_inventory": [
          {"ref_id": "REF_001", "text": "内容...", "type": "paragraph", "original_index": 0},
          {"ref_id": "REF_002", "text": "内容...", "type": "heading", "original_index": 1}
        ],
        "table_inventory": [
          {"ref_id": "TBL_001", "table_title": "表タイトル", "type": "schedule", "original_index": 0}
        ],
        "dedup_report": {
          "removed_duplicates": 0,
          "merged_blocks": 0
        }
      }

      重要: source_inventory には、入力のtext_blocksを整理した結果を全て含めてください。削除や要約は厳禁です。

    flyer: |
      あなたはチラシの商品情報を整理する専門家です。
      Stage Fで抽出された冗長な商品データを整理し、重複のない商品目録を作成してください。

      【入力データ】
      $stage_f_payload

      【整理ルール】
      1. **商品の重複排除**: 同じ商品が複数回出現している場合は1つにまとめる
      2. **価格情報の統一**: 税込/税抜を明記、単位を統一
      3. **カテゴリ整理**: 商品をカテゴリごとにグループ化
      4. **参照ID付与**: 各商品に一意のIDを付与

      【出力JSON形式】
      {
        "unified_text": "整理された商品リスト（Markdown形式）",
        "source_inventory": [
          {"ref_id": "ITEM_001", "name": "商品名", "price": 価格, "unit": "単位", "category": "カテゴリ"}
        ],
        "dedup_report": {"removed_duplicates": 0}
      }
      

    kakeibo: |
      あなたはレシートのOCR結果から構造化データを生成する専門家です。
      
      以下は Stage F（OCR）で抽出されたレシート全文です：
      
      ---
      $vision_raw
      ---
      
      このテキストから、レシート情報を構造化してJSON形式で出力してください。
      
      ## 構造化タスク
      
      ### 1. 店舗情報の抽出
      - 店舗名
      - 住所
      - 電話番号
      - 店舗コード（記載されていれば）
      
      ### 2. 取引情報の抽出
      - 日付（YYYY-MM-DD形式）
      - 時刻（HH:MM:SS形式、記載されていれば）
      - レジ番号
      - レシート番号
      - 取引番号
      
      ### 3. 商品明細の抽出
      各商品について：
      - 行番号（レシート記載の順序）
      - 行の種類（ITEM=商品、DISCOUNT=値引き、SUBTOTAL=小計、TAX=税額など）
      - 商品名（レシート記載のまま）
      - 数量
      - 単価
      - 金額（値引きの場合は負の値）
      - 税率マーク（※、★など）
      - 値引きテキスト（「2割引」「半額」「10%引」など、記載されていれば）
      - 値引き適用先（この値引きがどの商品に適用されるか、文脈から判断できれば行番号を記載）
      
      ### 4. 金額情報の抽出
      **重要：レシートに記載されている数値をそのまま抽出（計算・推測禁止）**
      
      レシートの記載形式に応じて抽出してください：
      
      #### 外税レシートの場合（「税抜額」+「消費税」が別記載）
      
      **以下の行を探して、記載されている数値をそのまま抽出してください：**
      
      1. **小計**（税抜の合計額）
         - 「小計」「計」などの行
      
      2. **8%税率の情報**（以下の2つを必ず探す）
         - **8%対象額（税抜）**: 「外税 8%対象額」「8%対象」などの行の金額
         - **8%消費税額**: 「外税 8%」「8%税」などの行の金額
      
      3. **10%税率の情報**（以下の2つを必ず探す）
         - **10%対象額（税抜）**: 「外税10%対象額」「10%対象」などの行の金額
         - **10%消費税額**: 「外税10%」「10%税」などの行の金額
      
      4. **合計**（税込支払額）
         - 「合計」「お支払」などの行
      
      #### 内税レシートの場合（「税込額」+「内税額」が記載）
      
      **以下の行を探して、記載されている数値をそのまま抽出してください：**
      
      1. **小計**（税込の合計額）
         - 「小計」「計」などの行
      
      2. **8%税率の情報**（以下の2つを必ず探す）
         - **8%対象計（税込）**: 「8%対象計」「軽減税率対象計」などの行の金額
         - **8%内税額**: 「(内税 ○○円)」「8%内税」などの行の金額
      
      3. **10%税率の情報**（以下の2つを必ず探す）
         - **10%対象計（税込）**: 「10%対象計」などの行の金額
         - **10%内税額**: 「(内税 ○○円)」「10%内税」などの行の金額
      
      4. **合計**（税込支払額）
         - 「合計」「お支払」などの行
      
      #### 共通項目
      - お預かり（記載されていれば）
      - お釣り（記載されていれば）
      
      **数値の読み取りに注意：**
      - 右寄せの数値は、¥マークの後ろの数字を正確に読み取る
      - カンマ区切りの数値もそのまま読み取る
      - 「¥55」は55、「¥68」は68と読み取る（4や118と誤読しない）
      
      ### 5. 支払情報
      - 支払方法（現金/カード/電子マネー等）
      - カード情報（記載されていれば）
      
      ### 6. その他情報
      - ポイント情報
      - キャンペーン情報
      - バーコード番号
      - その他の特記事項
      
      ## 出力形式
      
      以下のJSON形式で出力してください。
      
      ### 外税レシートの例：
      
      ```json
      {
        "shop_info": {
          "name": "店舗名",
          "address": "住所（記載があれば）",
          "phone": "電話番号（記載があれば）",
          "store_code": "店舗コード（記載があれば）"
        },
        "transaction_info": {
          "date": "YYYY-MM-DD",
          "time": "HH:MM:SS（記載があれば）",
          "register_number": "レジ番号（記載があれば）",
          "receipt_number": "レシート番号（記載があれば）",
          "transaction_number": "取引番号（記載があれば）"
        },
        "items": [
          {
            "line_number": 1,
            "line_type": "ITEM",
            "line_text": "レシートのこの行のテキストそのまま",
            "product_name": "商品名",
            "quantity": 1,
            "unit_price": 100,
            "amount": 100,
            "tax_mark": "※または★またはなし",
            "discount_text": null,
            "discount_applied_to": null
          },
          {
            "line_number": 2,
            "line_type": "DISCOUNT",
            "line_text": "▲値引 20%",
            "product_name": "値引",
            "quantity": 1,
            "unit_price": null,
            "amount": -20,
            "tax_mark": null,
            "discount_text": "20%",
            "discount_applied_to": 1
          }
        ],
        "amounts": {
          "subtotal": 1377,
          "tax_8_base": 0,
          "tax_8_amount": 0,
          "tax_10_base": 1377,
          "tax_10_amount": 123,
          "total_tax": 123,
          "total": 1500,
          "received": 2000,
          "change": 500,
          "tax_display_type": "excluded"
        },
        "payment": {
          "method": "現金",
          "card_info": null
        },
        "other_info": {
          "points": "ポイント情報",
          "campaign": "キャンペーン情報",
          "barcode": "バーコード番号",
          "notes": "その他特記事項"
        }
      }
      ```
      
      ### 内税レシートの例：
      
      ```json
      {
        "shop_info": {
          "name": "サイゼリヤ",
          "address": "イトーヨーカドー武蔵小杉駅前",
          "phone": "044-711-6451",
          "store_code": null
        },
        "transaction_info": {
          "date": "2025-11-01",
          "time": "18:13:00",
          "register_number": "001",
          "receipt_number": "0320",
          "transaction_number": "5264"
        },
        "items": [
          {
            "line_number": 1,
            "line_type": "ITEM",
            "line_text": "04633 チキンのサラダ",
            "product_name": "チキンのサラダ",
            "quantity": 1,
            "unit_price": 350,
            "amount": 350,
            "tax_mark": null,
            "discount_text": null,
            "discount_applied_to": null
          },
          {
            "line_number": 2,
            "line_type": "ITEM",
            "line_text": "02626 アロスティチーニ",
            "product_name": "アロスティチーニ",
            "quantity": 1,
            "unit_price": 400,
            "amount": 400,
            "tax_mark": null,
            "discount_text": null,
            "discount_applied_to": null
          }
        ],
        "amounts": {
          "subtotal": 3980,
          "tax_8_base": null,
          "tax_8_amount": null,
          "tax_10_base": 3980,
          "tax_10_amount": 361,
          "total_tax": 361,
          "total": 3980,
          "received": null,
          "change": null,
          "tax_display_type": "included"
        },
        "payment": {
          "method": "クレジット",
          "card_info": null
        },
        "other_info": {
          "points": null,
          "campaign": null,
          "barcode": null,
          "notes": "※印は軽減税率対象品目です"
        }
      }
      ```
      
      ## 重要な注意事項
      
      1. **数値は必ずレシート記載のまま**
         - 計算しない、推測しない
         - 記載がない項目は null にする
      
      2. **内税・外税の判別**
         - **外税レシート**: 「小計」+「消費税」=「合計」の形式。tax_display_type: "excluded"
         - **内税レシート**: 「合計」に税込で、「(内税額 ○○円)」と記載。tax_display_type: "included"
         - レシートに「内税額」「うち消費税」などの記載があれば内税レシート
         - 「○%対象計」という記載は税込額を指す（内税の場合）
      
      3. **8%/10%税率の区分**
         - レシートに税率の記載（※、★、8%、10%マーク）があればそれを使う
         - 記載がない場合は null にする（推測しない）
      
      4. **税額サマリーの抽出**
         - 外税：「8%対象 ○○円（税 △△円）」→ tax_8_base: ○○, tax_8_amount: △△
         - 内税：「8%対象計 ○○円 (内税額 △△円)」→ tax_8_base: ○○, tax_8_amount: △△
         - **重要**: 内税の場合、tax_8_base は税込額、tax_8_amount は内税額
         - 外税の場合、tax_8_base は税抜額、tax_8_amount は消費税額
      
      5. **記載がない項目**
         - 記載がない項目は null にする
         - 空文字列や0ではなく null を使う
      
      6. **値引きの取り扱い**
         - 値引き行（「▲値引」「割引」など）は line_type: "DISCOUNT" として別の明細行にする
         - 値引き金額は負の値（例：-20）で記録
         - 可能であれば discount_applied_to にどの商品の値引きかを記載（行番号）
         - 値引き率や割引内容は discount_text に記載（例：「20%」「半額」）
         - 値引き適用先が不明な場合は discount_applied_to: null にする
      
      ## エラー処理
      
      - OCR結果が不完全な場合：`{"error": "incomplete_ocr", "details": "不完全な箇所の説明"}`
      - レシートとして認識できない場合：`{"error": "not_a_receipt"}`
      

  stage_h:
    default: |
      # Stage H: 構造化（Google Classroom ドキュメント）
      
      あなたは Google Classroom のドキュメントから構造化データを抽出する専門家です。
      
      ## 入力情報
      
      - **ファイル名**: $file_name
      - **ドキュメントタイプ**: $doc_type
      - **ワークスペース**: $workspace
      - **現在日付**: $current_date
      
      ## テキスト
      
      ```
      $combined_text
      ```
      
      ## タスク
      
      このGoogle Classroomのテキストから、投稿文と添付ファイルの**全ての文章を余すところなく**抽出し、**text_blocks**と**表構造**に仕分けてJSON形式で出力してください。
      
      ## ⚠️ Stage Hの役割の明確化（最重要）
      
      **Stage Hの仕事は「振り分け」であり、「要約」でも「解釈」でも「選別」でもありません。**
      
      ### Stage Hの3つの原則:
      
      1. **全ての情報を集める**
         - combined_text（添付ファイルのテキスト）
         - 投稿者、件名、投稿日時などのメタデータ
         - **全ての情報源から、1文字も漏らさず収集**
      
      2. **適切に振り分ける**
         - 表データ → structured_tables, weekly_schedule
         - テキストブロック → text_blocks
         - 基本情報 → basic_info
         - その他 → other_text
         - **どこかに必ず振り分ける（捨てない）**
      
      3. **要約・解釈は一切しない**
         - ❌ 「保護者会が開催されます」（要約）
         - ✅ 「来週の木曜日、午後2時より体育館にて保護者会を開催いたします。ご多忙とは存じますが、ぜひご参加くださいますようお願い申し上げます。」（原文そのまま）
         - **原文を一字一句そのまま振り分ける**
      
      ### 振り分けの検証:
      
      **元のテキストの文字数 = 振り分け後の全文字数の合計**
      
      この等式が成立しない場合、情報が失われています。必ず再確認してください。
      
      ### 抽出項目
      
      1. **document_date** (文字列, YYYY-MM-DD形式, または null)
         - 投稿日時、または課題の期限日
         - 優先順位: 期限日 > 投稿日
      
      2. **tags** (文字列の配列)
         - 検索用のタグ 5-10個
         - 科目名、投稿タイプ、優先度、関連トピックなど
      
      3. **metadata** (オブジェクト)
         - 汎用スキーマに基づく構造化データ
         - Classroom固有の情報も含める
      
      ## metadata フィールドの構造
      
      ★★★ データ振り分けの基本原則 ★★★
      **投稿文と添付ファイルの全ての文章を余すところなく抽出し、articles と表構造に仕分けてください。**

      ⚠️ **重複禁止**: weekly_schedule, calendar_events, structured_tables に抽出した情報は、articles に含めないこと。
      ⚠️ **text_blocks は出力しない**: 代わりに articles を使用してください。
      
      ### metadataフィールドの構造:

      ```json
      {
        "basic_info": {
          "post_date": "投稿日時 (YYYY-MM-DD)",
          "author": "投稿者名",
          "subject": "件名",
          "post_type": "投稿タイプ（assignment/announcement/material/question）",
          "deadline": "期限（YYYY-MM-DD）",
          "priority": "優先度（high/medium/low）",
          "related_class": "関連する授業・科目名"
        },
        "articles": [
          {
            "title": "見出し（なければnull）",
            "body": "本文テキスト（挨拶文、説明、お知らせなど、読み物としての文章）"
          }
        ],
        "weekly_schedule": [
          {
            "date": "YYYY-MM-DD",
            "day_of_week": "曜日",
            "events": ["行事1", "行事2"],
            "note": "持ち物や連絡事項"
          }
        ],
        "structured_tables": [
          {
            "table_title": "表のタイトル",
            "table_type": "requirements/schedule/grades など",
            "headers": ["列1", "列2", "列3"],
            "rows": [
              {"列1": "値1", "列2": "値2", "列3": "値3"}
            ]
          }
        ],
        "special_events": ["特別イベント"],
        "attachments": ["添付ファイル名"],
        "other_text": [
          {
            "type": "greeting/contact_info/signature/note/footer/misc",
            "content": "その他のテキスト（時候の挨拶、連絡先、署名、注釈など）"
          }
        ]
      }
      ```
      
      ### データ振り分けルール（必ず守ること）

      1. **articles**: 読み物としての文章（挨拶文、説明、お知らせなど）
         - 課題の説明、お知らせ本文、連絡事項、コメント、質問など
         - title（見出し、なければnull）と body（本文全文）のペアで記録
         - **body は一切省略せず、原文そのまま全文を記録**
         - ⚠️ **重複禁止**: weekly_schedule, calendar_events, structured_tables に抽出済みの情報は含めない

         **【重要】articles の粒度ガイドライン（ベクトル検索精度向上のため）**
         - **原則: 1トピック = 1記事**
         - 長い説明文は、サブトピックごとに分割してください
         - 各記事は **100-300文字を目安** に（厳密でなくてもOK、トピックの境界を優先）
         - 例: 「課題の説明」が長い場合:
           - ✅ 「課題の目的」「提出方法」「評価基準」「注意事項」に分割
           - ❌ 全体を1つの記事にまとめる（500文字以上になる場合）
         - 理由: ベクトル検索では「提出方法は？」という質問に対して、該当記事のみがヒットする必要がある
      
      2. **weekly_schedule**: 日ごとの時間割・スケジュール（時間割表、週間予定表）
         - 日付、曜日、その日の行事・イベントが記載された表
         - 授業科目が時限ごとに記載された時間割
         - **【重要】表内の全ての日付行・時限行を抽出すること**
         - 【必須フィールド】: date, day_of_week
         - 【任意フィールド】: events (行事), class_schedules (クラス別時間割), note
         - クラス別時間割がある場合は class_schedules 配列を使用
         - **月間予定表も weekly_schedule へ**
      
      3. **structured_tables**: 上記1-2に当てはまらないその他の表データ
         - 成績表、提出物リスト、スケジュール表、ルーブリックなど
         - table_title（表のタイトル）、table_type（種類）、headers（列名）、rows（行データ）で構造化
         - **【重要】表内の全ての行を抽出すること**
      
      4. **basic_info**: Classroom固有の基本情報
         - 投稿日時、投稿者、件名、投稿タイプ、期限、優先度、関連科目
         - Classroom特有の情報を優先的に抽出
      
      5. **attachments**: 添付ファイル名の配列
      
      6. **other_text**: 上記1-5に該当しない、その他の全てのテキスト
         - 時候の挨拶（「いつもお世話になっております」等）
         - お問い合わせ窓口・連絡先（「お問い合わせ: 03-1234-5678」等）
         - 署名・落款（「○○学校 △△先生」等）
         - 注釈・補足（「※印の文章」「補足説明」等）
         - フッター情報（「本メールは自動送信です」等）
         - その他、分類しづらいが存在する全てのテキスト
         - **重要**: 「本題と関係ない」と判断して削除してはいけません
         - **理由**: 利用するかどうかの判断は人間が行います。AIは全ての情報を忠実に抽出することに専念してください
      
      ## 表構造抽出ガイドライン

      ### ⚠️ 最重要原則：表は必ず行データとして抽出（要約禁止）

      **表データは必ず `rows` 配列に1行ずつ抽出してください。テキスト要約は絶対に禁止です。**

      ❌ **絶対にやってはいけないこと（data_summary禁止）**:
      ```json
      {
        "table_title": "成績優秀者",
        "data_summary": "1位は山田太郎（520点）、2位は田中花子（515点）..."  // ← これは禁止！
      }
      ```

      ✅ **正しい抽出方法（rows配列に全行を展開）**:
      ```json
      {
        "table_title": "成績優秀者",
        "headers": ["順位", "氏名", "点数"],
        "rows": [
          {"順位": 1, "氏名": "山田太郎", "点数": 520},
          {"順位": 2, "氏名": "田中花子", "点数": 515},
          {"順位": 3, "氏名": "鈴木一郎", "点数": 510}
        ]
      }
      ```

      ### 表の2つの構造パターン

      **パターン1: リスト型（縦方向にデータが並ぶ）**
      - ランキング表、名簿、成績一覧、商品リストなど
      - 各行が1つのエントリ（人、商品、項目）を表す
      - 例: 成績優秀者リスト、提出物一覧、イベント参加者リスト

      **パターン2: マトリクス型（横軸に日付や項目が並ぶ）**
      - 時間割、月間予定表、週間スケジュールなど
      - 行と列の交差点にデータがある
      - 例: 週間時間割（行=時限、列=曜日）、月間カレンダー

      ### 表の検出（AIの腕の見せ所）

      文書内に以下のパターンがあれば**表として認識**してください:

      - **列区切り**: 空白またはタブで区切られた複数の列
      - **行区切り**: 改行で区切られた複数の行
      - **ヘッダー行**: 1行目または最初の数行が見出し
      - **データ行**: ヘッダー以降が実際のデータ
      - **罫線なしでもOK**: 視覚的な罫線がなくても、列区切りと行区切りがあれば表として扱う
      - **key-valueペア**: 「項目名: 値」の繰り返しも表として構造化
      - **カンマ・セミコロン区切り**: 「A, B, C」や「X; Y; Z」のような並列データも表に展開
      - **ランキング・順位表**: 「1位: ○○」「2位: △△」のようなリストも表として構造化
      
      **例: 罫線なしの表**:
      ```
      日付    曜日   1限      2限      3限
      11/18   月     国語     算数     理科
      11/19   火     算数     国語     社会
      ```
      
      **例: key-valueペアを表組に**:
      ```
      提出期限: 2025-01-15
      提出方法: Classroom
      評価配分: 50点
      注意事項: 解答過程も記載すること
      ```
      → structured_tables で以下のように構造化:
      ```json
      {
        "table_title": "課題詳細",
        "table_type": "requirements",
        "headers": ["項目", "内容"],
        "rows": [
          {"項目": "提出期限", "内容": "2025-01-15"},
          {"項目": "提出方法", "内容": "Classroom"},
          {"項目": "評価配分", "内容": "50点"},
          {"項目": "注意事項", "内容": "解答過程も記載すること"}
        ]
      }
      ```

      **例: ランキング・順位表を表組に**:
      ```
      4科 公開組分けテスト 成績優秀者
      1位 新宿校 山本 直生子 518点
      2位 田町校 岸本 拓真 515点
      3位 渋谷校 佐藤 美咲 512点
      ```
      → structured_tables で以下のように構造化（**全員を1行ずつ抽出**）:
      ```json
      {
        "table_title": "4科 公開組分けテスト 成績優秀者",
        "table_type": "ranking",
        "headers": ["順位", "校舎名", "氏名", "点数"],
        "rows": [
          {"順位": 1, "校舎名": "新宿校", "氏名": "山本 直生子", "点数": 518},
          {"順位": 2, "校舎名": "田町校", "氏名": "岸本 拓真", "点数": 515},
          {"順位": 3, "校舎名": "渋谷校", "氏名": "佐藤 美咲", "点数": 512}
        ]
      }
      ```
      ⚠️ **重要**: ランキング表は全員分を抽出すること。「1位〜3位のみ抽出」は禁止！

      **例: カンマ・セミコロン区切りデータを展開**:

      元のテキスト: 「参加者: 山田, 田中, 鈴木, 佐藤」

      ❌ **NG（1セルにカンマ区切りで入れる）**:
      ```json
      {"項目": "参加者", "内容": "山田, 田中, 鈴木, 佐藤"}
      ```

      ✅ **OK（リスト型の表に展開）**:
      ```json
      {
        "table_title": "参加者リスト",
        "headers": ["氏名"],
        "rows": [
          {"氏名": "山田"},
          {"氏名": "田中"},
          {"氏名": "鈴木"},
          {"氏名": "佐藤"}
        ]
      }
      ```

      **セル内にカンマやセミコロンが残っている = 構造化が不十分**
      → 並列データは必ず別々の行または列に展開すること

      ### データの正規化ルール
      
      #### ケース1: 時間割表（weekly_schedule の periods 配列）
      
      **元のテキスト:** "1-2限: 体育"
      
      **✅ 正解: 時限ごとに展開**
      ```json
      {
        "class_schedules": [{
          "class": "5A",
          "periods": [
            {"period": 1, "subject": "体育"},
            {"period": 2, "subject": "体育"}
          ]
        }]
      }
      ```
      
      **❌ 誤り: "1-2限"を文字列として保持**
      ```json
      {
        "periods": [
          {"period": "1-2限", "subject": "体育"}  // NG: periodは数値であるべき
        ]
      }
      ```
      
      #### ケース2: イベント名や連絡事項（text_blocks, note フィールド）
      
      **元のテキスト:** "1-2限は体育館で集会"
      
      **✅ 正解: 原文のまま保持**
      ```json
      {
        "text_blocks": [
          {"title": "連絡事項", "content": "1-2限は体育館で集会"}
        ]
      }
      ```
      
      **❌ 誤り: 不必要に分解**
      ```json
      {
        "text_blocks": [
          {"title": "連絡事項", "content": "1限は体育館で集会"},
          {"title": "連絡事項", "content": "2限は体育館で集会"}
        ]
      }
      ```
      
      ### 重要な注意事項
      
      **✅ すべきこと:**
      1. **原文を尊重**: 文書に書かれている通りに抽出
      2. **構造を明示**: JSON形式で構造化
      3. **全量抽出**: 表の全ての行、テキストの全量を抽出
      
      **❌ してはいけないこと:**
      1. **推測**: 記載されていない情報を補完しない
      2. **分解**: "1-2限" を "1限", "2限" に分けない
      3. **省略**: 一部だけを代表例として抽出し、残りを省略する
      4. **要約**: テキストを要約したり言い換えたりしない
      
      ## ⚠️ 絶対原則：全量抽出
      
      **文書内の全てのテキストを、必ずどこかに分類してください**
      
      ### 分類フロー:
      
      1. text_blocks に該当する → text_blocks へ
      2. 表として構造化できる → structured_tables へ
      3. スケジュール情報 → weekly_schedule へ
      4. **上記のどれにも該当しない** → other_text へ
      
      ### 重要事項:
      
      - **情報の欠損・省略は一切禁止**
      - 投稿文と添付ファイルの**全ての文章を余すところなく**抽出
      - **要約・言い換えは厳禁**（特に text_blocks の content、note フィールド）
      - **【配列フィールドの完全抽出】**: text_blocks, structured_tables などの配列フィールドは、**全ての行**を抽出すること
      - 日付は必ず YYYY-MM-DD 形式で統一
      - 見つからない情報は null または空のリスト [] を設定
      - **表にできるものは表に仕立てる**（AIの腕の見せ所）
      
      ### 検証ステップ（必須）
      
      抽出後、以下を確認してください：
      
      1. **元のテキストを読み直す**
      2. **抽出結果に含まれていないテキストがないか確認**
      3. **漏れがあれば、適切なカテゴリ（またはother_text）に追加**
      4. **文字数の合計がほぼ一致するまで繰り返す**
      
      例：
      - 元のテキスト: 1500文字
      - 抽出結果の合計: 1480文字 → ✅ 許容範囲（98%以上）
      - 抽出結果の合計: 1200文字 → ❌ 300文字（20%）漏れている！再確認必須
      
      **全てのテキストが、最終的にどこかのチャンク（text_blocks, structured_tables, weekly_schedule, other_text のいずれか）に含まれていることを保証してください。**
      
      ## 出力形式
      
      ```json
      {
        "document_date": "2025-03-20",
        "tags": ["数学", "課題", "期限あり", "高優先度"],
        "metadata": {
          "basic_info": {
            "post_date": "2025-03-15",
            "author": "田中先生",
            "subject": "第5回課題：微分の応用",
            "post_type": "assignment",
            "deadline": "2025-03-20",
            "priority": "high",
            "related_class": "数学"
          },
          "text_blocks": [
            {"title": "課題の目的", "content": "今回の課題では...（100-300文字程度）"},
            {"title": "提出方法", "content": "Classroomから提出してください..."},
            {"title": "評価基準", "content": "以下の基準で評価します..."}
          ],
          "weekly_schedule": [],
          "structured_tables": [],
          "special_events": [],
          "attachments": ["課題5.pdf"],
          "other_text": [
            {"type": "greeting", "content": "いつもお世話になっております"},
            {"type": "signature", "content": "数学科 田中太郎"}
          ]
        }
      }
      ```
      
      **重要:**
      - **必ずJSON形式で出力してください**（```json ブロック内に記述）
      - document_date は期限日を優先、なければ投稿日、それも不明なら null
      - JSON構文エラー（カンマ、括弧、引用符の不一致）に十分注意してください
      
      ## ⚠️ Gemini特有の注意事項（必ず守ること）
      
      ### 推測・補完の厳禁（AI推論エンジンよりも厳格）
      - **原文に記載されていない情報は、一切推測・補完しないこと**
      - 確信がない場合は、必ず null または空配列 [] を使用
      - 「おそらく〜」「〜と思われる」といった推測は一切行わない
      - **Geminiは文脈から情報を補完する傾向があるため、特に注意**
      
      ### 要約・言い換えの厳禁（学年便り等の文章系ドキュメント）
      - **学年便り、連絡事項、お知らせなどの文章は、一切要約せず原文のまま全文を抽出**
      - content フィールドには、**原文をそのまま一字一句正確に記録**
      - **Geminiは文章を要約・言い換える傾向があるため、これを厳重に禁止**
      - 例：
        - ❌ 「保護者会が開催されます」（要約）
        - ✅ 「来週の木曜日、午後2時より体育館にて保護者会を開催いたします。ご多忙とは存じますが、ぜひご参加くださいますようお願い申し上げます。」（原文そのまま）
      
      ### 論理的処理の活用（スケジュール・時間割等）
      - スケジュール抽出時は、日付・時限の整合性を論理的に検証
      - 時間割の時限数が正しいか確認（例：6時限制なのに7限目があればエラー）
      - 曜日と日付の整合性を確認（例：2025-01-06は月曜日）
      - **Geminiの論理的思考能力を活用し、データの整合性を保証**
      

    flyer: |
      # Stage H: 構造化（チラシ商品情報抽出）
      
      あなたはチラシから商品情報を構造化して抽出する専門家です。
      
      ## 入力情報
      
      - **ファイル名**: $file_name
      - **ドキュメントタイプ**: $doc_type
      - **ワークスペース**: $workspace
      - **現在日付**: $current_date
      
      ## テキスト
      
      ```
      $combined_text
      ```
      
      ## タスク
      
      整形されたチラシテキストから、商品情報を構造化して抽出してJSON形式で出力してください。
      
      ### 抽出項目
      
      1. **document_date** (文字列, YYYY-MM-DD形式, または null)
         - チラシの有効期間開始日、またはセール開始日
         - 例: "2025-03-15"
      
      2. **tags** (文字列の配列)
         - 検索用のタグ 5-10個
         - 店舗名、商品カテゴリ、セール情報など
         - 例: ["XXXスーパー", "野菜", "特価", "ポイント5倍"]
      
      3. **metadata** (オブジェクト)
         - **store_name**: 店舗名
         - **valid_period**: チラシ有効期間 {{"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"}}
         - **products**: 商品情報の配列
           - name: 商品名
           - price: 価格（数値）
           - unit: 単位
           - category: カテゴリ
           - notes: 備考（特価、産地など）
         - **sale_info**: セール情報の配列
         - その他、テキストから抽出できる有用な情報
      
      ## 出力形式
      
      ```json
      {{
        "document_date": "2025-03-15",
        "tags": ["XXXスーパー", "野菜・果物", "精肉", "特価セール", "ポイント5倍"],
        "metadata": {{
          "store_name": "XXXスーパー",
          "valid_period": {{
            "start": "2025-03-15",
            "end": "2025-03-20"
          }},
          "products": [
            {{
              "name": "キャベツ",
              "price": 98,
              "unit": "1玉",
              "category": "野菜・果物",
              "notes": "国産"
            }},
            {{
              "name": "豚バラ肉",
              "price": 198,
              "unit": "100g",
              "category": "精肉",
              "notes": "特価"
            }}
          ],
          "sale_info": [
            "ポイント5倍デー: 3/17",
            "数量限定商品あり"
          ]
        }}
      }}
      ```
      
      ## ⚠️ 絶対原則：全量抽出
      
      **チラシ内の全ての商品情報を、必ず抽出してください**
      
      ### 検証ステップ（必須）
      
      抽出後、以下を確認してください：
      
      1. **元のチラシを読み直す**
      2. **抽出結果に含まれていない商品がないか確認**
      3. **漏れがあれば products 配列に追加**
      4. **商品数が一致するまで繰り返す**
      
      例：
      - 元のチラシ: 25商品掲載
      - 抽出結果: 25商品 → ✅ 完璧
      - 抽出結果: 20商品 → ❌ 5商品漏れている！再確認必須
      
      **全ての商品が products 配列に含まれていることを保証してください。**
      
      ## 重要な注意事項
      
      - **必ずJSON形式で出力してください**（```json ブロック内に記述）
      - document_date は有効期間の開始日を使用、不明なら null
      - tags は必ず配列形式で出力（店舗名や主要商品カテゴリを含める）
      - metadata には、商品情報を詳細に含める
      - **商品の省略は厳禁**：全ての商品を products 配列に含めてください
      
      ## ⚠️ Gemini特有の注意事項（必ず守ること）
      
      ### 推測・補完の厳禁（AI推論エンジンよりも厳格）
      - **原文（チラシ）に記載されていない情報は、一切推測・補完しないこと**
      - 価格が不明な商品は price: null とする
      - 産地が不明な商品は notes に産地情報を含めない
      - 確信がない場合は、必ず null を使用
      - **Geminiは文脈から情報を補完する傾向があるため、特に注意**
      
      ### 論理的処理の活用（商品データ検証）
      - **Geminiの論理的思考能力を活用し、以下を検証**
      - チラシに記載された商品総数と、抽出した products 配列の要素数が一致するか確認
      - 同じ商品が重複して抽出されていないか確認
      - カテゴリ分類が論理的に正しいか確認（例：キャベツは「野菜・果物」）
      - 価格の単位（円、g、個）が正しく抽出されているか確認
      

    kakeibo: |
      あなたは家計簿の商品をカテゴリ分類する専門家です。
      
      以下の商品名をカテゴリ分類してください。
      
      ---
      商品名：{product_name}
      ---
      
      ## 分類基準
      
      ### 食品（軽減税率8%対象）
      - 生鮮食品（肉、魚、野菜、果物）
      - 加工食品（パン、麺、冷凍食品、調味料）
      - 飲料（水、お茶、ジュース、牛乳）
      - 菓子類
      
      ### 日用品（標準税率10%）
      - 洗剤、掃除用品
      - ティッシュ、トイレットペーパー
      - シャンプー、石鹸、歯磨き粉
      - ゴミ袋、ラップ、アルミホイル
      - 電池、電球
      - 文房具
      
      ### 医薬品・衛生用品（標準税率10%）
      - 医薬品、サプリメント
      - マスク、消毒液
      - 生理用品、おむつ
      
      ### 酒類（標準税率10%）
      - ビール、日本酒、ワイン、焼酎
      - チューハイ、ハイボール
      
      ### 外食（標準税率10%）
      - 店内飲食
      - イートインスペース利用
      
      ### その他
      - 上記に該当しないもの
      
      ## 出力形式
      
      以下のJSON形式で出力してください：
      
      ```json
      {
        "category": "食品/日用品/医薬品/酒類/外食/その他",
        "subcategory": "具体的な分類（例：生鮮食品、洗剤、等）",
        "tax_rate": 8 or 10,
        "confidence": "high/medium/low"
      }
      ```
      
      ## ⚠️ 絶対原則：全量抽出
      
      **レシート内の全ての商品を、必ず分類してください**
      
      ### 検証ステップ（必須）
      
      1. **元のレシートを読み直す**
      2. **分類結果に含まれていない商品がないか確認**
      3. **漏れがあれば、該当する商品を分類**
      4. **商品数が一致するまで繰り返す**
      
      **全ての商品が分類されていることを保証してください。**
      
      **重要：**
      - レシートに税率マーク（※、★、8%、10%）がある場合、それを優先
      - 食品は基本的に8%、日用品・酒類は10%
      - みりん風調味料は10%（酒類扱い）
      - 本みりん（酒類）は10%
      - 迷った場合は confidence: "low" にする
      - **商品の省略は厳禁**：全ての商品を分類してください
      
      ## ⚠️ Gemini特有の注意事項（必ず守ること）
      
      ### 推測・補完の厳禁（AI推論エンジンよりも厳格）
      - **レシートに記載されていない情報は、一切推測・補完しないこと**
      - 税率マークがない場合、商品名から論理的に判断（食品=8%、日用品=10%）
      - 判断が困難な場合は confidence: "low" とし、推測はしない
      - **Geminiは文脈から情報を補完する傾向があるため、特に注意**
      
      ### 論理的処理の活用（金額検証）
      - **Geminiの計算能力を活用し、以下を必ず検証**
      - **全ての商品の金額を合計し、レシートの合計金額（Total）と一致するか確認**
      - 計算結果が一致しない場合、以下を再確認：
        1. 商品の抽出漏れがないか
        2. 金額の読み取りミスがないか
        3. 税込・税抜の解釈が正しいか
      - 検証ステップ例：
        - 商品1: 198円
        - 商品2: 298円
        - 商品3: 150円
        - 合計計算: 198 + 298 + 150 = 646円
        - レシート記載の合計: 646円
        - ✅ 一致確認 → 抽出完了
      - **計算が一致するまで抽出結果を見直すこと**
      

  stage_i:
    default: |
      # Stage I: Synthesis - Classroom Documents

      あなたはGoogle Classroom課題ドキュメントの要約とタグ生成を専門とするAIアシスタントです。
      
      ## 入力情報
      
      ### Stage H の構造化結果
      
      ```json
      {$stageH_result}
      ```
      
      ### 元のテキスト
      
      ```
      $combined_text
      ```
      
      ## タスク

      上記の情報を統合し、以下を生成してください：

      ### 1. タイトル (title)

      以下の優先順位でタイトルを生成：

      **優先順位1**: 添付ファイル名がある場合
      - Stage H の attachments 配列にファイル名がある場合、そのファイル名を元にテキスト整形
      - 拡張子を除去し、数字表記を適正化（例: "2025年12月19日" など）
      - 例: "ウインターコンサート日程のお知らせ.pdf" → "ウインターコンサート日程のお知らせ"

      **優先順位2**: 添付ファイル名が内容を反映していない場合（ファイルIDなど）
      - Stage H の text_blocks の最初の要素にタイトルらしき内容があれば、それを使用
      - なければ、ドキュメント全体を表す1行要約を生成（10-30文字）

      **優先順位3**: 添付ファイルがない場合（text_only など）
      - Stage H の basic_info.subject があれば、それを使用
      - なければ、投稿文のトップから1行で内容を表すタイトルを生成（10-30文字）

      ### タイトルに日付サフィックスを追加

      タイトル生成後、以下の優先順位で**書類の発行日・配布日**を抽出し、タイトルに追加：

      **日付抽出の優先順位**:
      1. **sended_date** (Stage H の metadata に含まれる場合): この日付を使用
      2. **本文ヘッダー部分の明示的な日付**: "発行日", "配布日", "作成日", "○○年○○月配布" などのラベル付き日付表記のみ
      3. **それ以外の場合**: 日付サフィックスを付けない（推測・捏造は絶対に禁止）

      **重要な制約**:
      - **推測や捏造は絶対に禁止**: 明示的な発行日・配布日の表記がない場合、日付を推測してはいけない
      - **文書の処理日を使用してはいけない**: ファイルの処理日や現在日は文書の内容と無関係
      - **イベント日・期限日は除外**: 以下は発行日ではないため使用しない
        - イベント日（「コンサート: 2025-03-15」など）
        - 提出期限（「提出期限: 2025-01-20」など）
        - テスト日（「テスト: 2025-02-10」など）
        - 保護者会・行事の開催日

      **日付サフィックスの書式**:
      - 年月日が分かる場合: `_(YYYY_MM_DD)`
      - 年月のみ分かる場合: `_(YYYY_MM)`
      - 年のみ分かる場合: `_(YYYY)`
      - **日付が不明な場合: サフィックスなし**

      **例**:
      - sended_date が "2025-01-15" の場合: "数学課題5: 二次方程式の解法_(2025_01_15)"
      - 本文ヘッダーに「配布日: 2025年1月」とある場合: "数学課題5: 二次方程式の解法_(2025_01)"
      - 本文ヘッダーに「発行: 2025年」とある場合: "数学課題5: 二次方程式の解法_(2025)"
      - **日付が不明な場合**: "数学課題5: 二次方程式の解法"

      **判断基準**:
      - 「発行日: 2025-12-04」→ _(2025_12_04) ✅
      - 「2025年1月配布」→ _(2025_01) ✅
      - 「2025」とだけ書いてある → サフィックスなし ❌ 推測禁止
      - イベント日しかない → サフィックスなし ❌ イベント日は使用不可
      - 日付表記がない → サフィックスなし ❌ 捏造禁止

      ### 2. 要約 (summary)
      - 課題全体の簡潔な要約（2-3文、100-200文字程度）
      - 課題内容、提出期限、重要事項を含める

      ### 3. 重要ポイント (key_points)
      - 課題の重要なポイントを箇条書き（3-5個）
      - 提出物の形式、評価基準、注意事項など

      ### 4. タグ (tags)
      - 検索用のタグを5-10個生成
      - Stage H のタグと重複しても良い（後で統合されます）
      - 以下のカテゴリを含める

      ### 5. 基準日付 (relevant_date)
      - 提出期限または関連日付（YYYY-MM-DD形式）
      - Stage H の document_date を参照しつつ、より適切な日付があれば上書き
      - 不明な場合は null

      ### 6. カレンダーイベント (calendar_events)
      - マスターカレンダーに登録すべきイベントを抽出
      - テスト日、保護者会、学校行事、特別授業、遠足、修学旅行など
      - **課題の提出期限はタスクとして抽出（カレンダーには含めない）**
      - 各イベント:
        - `event_date`: イベント日（YYYY-MM-DD）
        - `event_time`: 開始時刻（HH:MM、不明なら null）
        - `event_name`: イベント名（簡潔に）
        - `location`: 場所（不明なら null）
        - `description`: 詳細説明（持ち物、注意事項など）
        - `participants`: 参加者（["育哉", "絵麻"] など、該当者のみ）

      ### 7. タスク (tasks)
      - マスタータスクリストに登録すべきタスクを抽出
      - 課題提出、テスト勉強、プリント提出、準備物など
      - 各タスク:
        - `task_name`: タスク名（簡潔に、例: "数学課題5 提出"）
        - `deadline`: 期限（YYYY-MM-DD HH:MM、時刻不明なら23:59）
        - `priority`: 優先度（"high", "medium", "low"）
        - `category`: カテゴリ（"課題", "テスト", "提出物", "準備", "その他"）
        - `description`: 詳細説明（提出方法、評価基準など）
        - `checklist`: チェックリスト（サブタスク、["問題1-5を解く", "解答をPDF化", "Classroomに提出"] など）
        - `assignee`: 担当者（"育哉", "絵麻", または null）
      
      ## タグ生成ルール
      
      以下のカテゴリからタグを生成：
      
      ### 科目タグ
      - 数学、国語、英語、理科、社会、体育、音楽、美術、技術・家庭
      
      ### 課題種別タグ
      - 課題、テスト、プリント、提出物、復習、予習、宿題
      
      ### 重要度タグ
      - 期限あり、期限間近、重要、緊急、優先度高
      
      ### 対象者タグ
      - 育哉、絵麻（該当する場合のみ）
      
      ### トピックタグ
      - 課題内容に関連するキーワード（例: 二次方程式、作文、実験レポート）
      
      ## 出力形式

      ```json
      {{
        "title": "数学課題5: 二次方程式の解法_(2025_01_10)",
        "summary": "数学の二次方程式の解法に関する課題。2問の方程式を解いて提出。期限は2025-01-15 23:59。",
        "key_points": [
          "提出期限: 2025-01-15 23:59",
          "提出形式: PDFまたはWord形式",
          "2問の二次方程式を解く",
          "解答過程も記載すること"
        ],
        "tags": ["数学", "課題", "二次方程式", "期限あり", "育哉", "PDF提出"],
        "relevant_date": "2025-01-15",
        "calendar_events": [
          {{
            "event_date": "2025-01-20",
            "event_time": "14:00",
            "event_name": "数学テスト",
            "location": "第1教室",
            "description": "二次方程式の単元テスト。計算機持参必須。",
            "participants": ["育哉"]
          }}
        ],
        "tasks": [
          {{
            "task_name": "数学課題5 提出",
            "deadline": "2025-01-15 23:59",
            "priority": "high",
            "category": "課題",
            "description": "二次方程式2問を解いてPDFまたはWord形式で提出。解答過程も記載すること。",
            "checklist": [
              "問題1を解く",
              "問題2を解く",
              "解答過程を記載",
              "PDFまたはWordに変換",
              "Classroomに提出"
            ],
            "assignee": "育哉"
          }}
        ]
      }}
      ```
      
      ## 重要な注意事項
      
      - **必ずJSON形式で出力してください**（```json ブロック内に記述）
      - 要約は簡潔かつ正確に（100-200文字）
      - key_points は具体的で実用的な情報を含める
      - タグは検索に役立つものを選択
      - relevant_date は最も重要な日付を1つ選択
      - 推測や想像で情報を追加しないこと（テキストに明記されている情報のみ抽出）


    flyer: |
      # Stage I: 統合・要約（チラシ）
      
      チラシの商品情報を統合し、検索に最適な形式に整形してください。
      
      ## タスク
      
      1. **要約生成**
         - チラシ全体の簡潔な要約
         - 主要商品カテゴリと目玉商品
         - セール情報
      
      2. **タグ生成**
         - 店舗名
         - 商品カテゴリ
         - 特売キーワード（特価、セールなど）
         - 期間（例: "3月中旬"）
      
      3. **基準日付抽出**
         - チラシ有効期間の開始日
      
      ## 出力形式
      
      ```json
      {{
        "summary": "XXXスーパーの3/15-3/20のチラシ。野菜・果物を中心に特価商品多数。",
        "tags": ["XXXスーパー", "野菜", "果物", "特価", "3月中旬"],
        "relevant_date": "2025-03-15",
        "key_products": [
          "キャベツ 98円",
          "りんご 198円"
        ],
        "sale_info": "ポイント5倍デー: 3/17"
      }}
      ```
      
      **重要:**
      - 要約には店舗名と期間を必ず含める
      - タグには商品カテゴリと特売キーワードを含める
      - relevant_date はチラシ開始日


  # ============================================
  # Stage H+I: 構造化 + 統合・要約（統合版）
  # ============================================
  # 役割: Stage G の整理済み出力を受け取り、1回のLLM呼び出しで
  #       構造化（旧Stage H）と統合・要約（旧Stage I）を同時に実行
  # 使用モデル: gemini-2.0-flash（コスト効率）
  # ============================================
  stage_hi:
    default: |
      # Stage H+I: 構造化 + 統合・要約（統合版）

      あなたはGoogle Classroom課題ドキュメントの構造化と要約を行う専門家です。
      1回の処理で、構造化データ抽出と要約・タイトル生成を同時に行ってください。

      ## 入力情報

      - **ファイル名**: $file_name
      - **ドキュメントタイプ**: $doc_type
      - **ワークスペース**: $workspace
      - **現在日付**: $current_date

      ## テキスト（Stage G で整理済み）

      ```
      $combined_text
      ```

      ## 参照元セグメント（REF_ID付き、$source_count 件）

      ```json
      $source_inventory_json
      ```

      ## 表データ（REF_ID付き、$table_count 件）

      ```json
      $table_inventory_json
      ```

      ## タスク

      上記の整理済みテキストから、以下の全てを1回で抽出・生成してください。

      ### 1. 構造化データ（旧Stage H）

      **document_date**: 基準日付（YYYY-MM-DD形式、または null）
      **tags**: 検索用タグ 5-10個
      **metadata**: 以下の構造:
        - basic_info: 投稿日、投稿者、件名、期限など
        - articles: 記事・お知らせ（1トピック1記事、100-300文字目安）
        - weekly_schedule: 週間予定・時間割
        - structured_tables: その他の表データ
        - calendar_events: カレンダー登録すべきイベント
        - other_text: その他のテキスト

      ### 2. 統合・要約（旧Stage I）

      **title**: ドキュメントタイトル（10-50文字）
        - 添付ファイル名があればそれを整形
        - なければ内容を表す1行タイトルを生成
        - 発行日・配布日があれば末尾に _(YYYY_MM_DD) を追加

      **summary**: 要約（100-200文字）
        - 内容の簡潔な要約
        - 期限や重要事項を含める

      **calendar_events**: カレンダーイベント（配列）
        - テスト日、保護者会、学校行事など
        - 課題提出期限はタスクに分類

      **tasks**: タスクリスト（配列）
        - 課題提出、テスト勉強、準備物など
        - deadline, priority, category を含める

      ## ⚠️ 重要ルール

      1. **情報の完全維持**: 入力テキストの情報を1文字も削除しない
      2. **重複禁止**: calendar_events, weekly_schedule, structured_tables に抽出した情報は articles に含めない
      3. **REF_ID参照**: 可能な場合、元データの REF_ID を記録（トレーサビリティ）
      4. **推測禁止**: テキストに明記されていない情報は抽出しない

      ## ⚠️ 表データ抽出の絶対ルール（最重要）

      **表データは必ず `headers` と `rows` で構造化。テキスト要約は絶対禁止！**

      ❌ **禁止（data_summary でテキスト要約）**:
      ```json
      {"table_title": "成績優秀者", "data_summary": "1位は山田（520点）、2位は田中..."}
      ```

      ✅ **正解（rows に全行を展開）**:
      ```json
      {
        "table_title": "成績優秀者",
        "headers": ["順位", "氏名", "点数"],
        "rows": [
          {"順位": 1, "氏名": "山田太郎", "点数": 520},
          {"順位": 2, "氏名": "田中花子", "点数": 515}
        ]
      }
      ```

      **表として構造化すべきデータ**:
      - ランキング・順位表（全員分を rows に）
      - 名簿・リスト（全項目を rows に）
      - key-value ペア（項目名/値 の2列テーブルに）
      - カンマ区切りデータ（各要素を別々の行に展開）
      - マトリクス形式（時間割、予定表など）

      **セル内にカンマやセミコロンが残っている = 構造化が不十分**

      ## 出力形式

      ```json
      {
        "document_date": "YYYY-MM-DD または null",
        "tags": ["タグ1", "タグ2", "タグ3"],
        "metadata": {
          "basic_info": {
            "post_date": "YYYY-MM-DD",
            "author": "投稿者名",
            "subject": "件名",
            "deadline": "YYYY-MM-DD",
            "related_class": "科目名"
          },
          "articles": [
            {"title": "見出し", "body": "本文テキスト（原文そのまま）", "ref_ids": ["REF_001"]}
          ],
          "weekly_schedule": [],
          "structured_tables": [
            {
              "table_title": "表のタイトル",
              "table_type": "ranking/schedule/requirements/list",
              "headers": ["列1", "列2", "列3"],
              "rows": [
                {"列1": "値1", "列2": "値2", "列3": "値3"},
                {"列1": "値4", "列2": "値5", "列3": "値6"}
              ],
              "ref_ids": ["TBL_001"]
            }
          ],
          "other_text": []
        },
        "title": "ドキュメントタイトル_(YYYY_MM_DD)",
        "summary": "内容の要約（100-200文字）",
        "calendar_events": [
          {
            "event_date": "YYYY-MM-DD",
            "event_time": "HH:MM",
            "event_name": "イベント名",
            "location": "場所",
            "description": "詳細",
            "participants": ["育哉", "絵麻"]
          }
        ],
        "tasks": [
          {
            "task_name": "タスク名",
            "deadline": "YYYY-MM-DD HH:MM",
            "priority": "high/medium/low",
            "category": "課題/テスト/提出物/準備",
            "description": "詳細説明",
            "checklist": ["サブタスク1", "サブタスク2"],
            "assignee": "担当者"
          }
        ]
      }
      ```

      **必ずJSON形式で出力してください。**

    flyer: |
      # Stage H+I: チラシ構造化 + 統合・要約（統合版）

      チラシの商品情報を構造化し、検索に最適な形式に整形してください。

      ## 入力

      $combined_text

      ## タスク

      1. **構造化**: 商品リスト、価格、カテゴリを抽出
      2. **要約**: チラシ全体の簡潔な要約を生成
      3. **タグ**: 検索用タグを生成

      ## 出力形式

      ```json
      {
        "document_date": "YYYY-MM-DD",
        "tags": ["店舗名", "野菜", "特価"],
        "metadata": {
          "store_name": "店舗名",
          "valid_period": {"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"},
          "products": [{"name": "商品名", "price": 価格, "category": "カテゴリ"}]
        },
        "title": "店舗名チラシ_(YYYY_MM_DD)",
        "summary": "要約",
        "calendar_events": [],
        "tasks": []
      }
      ```

