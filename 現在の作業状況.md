# 現在の作業状況（2025-12-22）

## 作業中のタスク

### カテゴリシステムの再構築検討

**問題点:**
- 現在の`60_ms_categories`テーブルが2次分類（食費、交通費、娯楽費など）になっている
- 本来は1次分類（野菜、文具、ゲームソフトなど）の商品カテゴリであるべき
- ユーザーの要求: 「ブロッコリーが、食料品の野菜だという分類はできて欲しい。それが食費かどうかは、その後の判断」

**背景:**
- 2段階の分類が必要:
  - **1次分類**: 商品の性質（客観的）- 例: ブロッコリー → 野菜 → 食料品
  - **2次分類**: 使用目的（主観的）- 例: 食費、誕生日プレゼント、教育費
- **このシステムでは1次分類のみを扱う**

**検討中の再構築オプション:**

両オプションとも最終的に2つのテーブルになる:

1. **オプション1**: 既存の`60_ms_categories`を商品カテゴリに転用
   - `60_ms_categories` → 商品カテゴリ（1次分類）に変更
   - 新テーブル作成 → 費用カテゴリ（2次分類）用

2. **オプション2**: 既存の`60_ms_categories`を費用カテゴリとして保持
   - `60_ms_categories` → 費用カテゴリ（2次分類）のまま維持
   - 新テーブル作成 → 商品カテゴリ（1次分類）用

**次のステップ:**
- `60_ms_categories`の現在のデータを確認（中断時点で未実行）
- 影響範囲の詳細分析
- どちらのオプションが影響が少ないか判断

---

## 最近完了したタスク

### 1. 不要カラムの削除
- `80_rd_products`テーブルから`display_sender`と`display_subject`を削除
- 理由: `display_sender`は`organization`と重複、`display_subject`は動的生成可能
- ファイル: `database/migrations/drop_redundant_display_columns_from_products.sql`

### 2. 自動承認の無効化
- ユーザーが承認していないのに19件が自動承認されていた問題を修正
- 全183商品を`needs_approval=True`にリセット
- `L_product_classification/daily_auto_classifier.py` (Line 257)で自動承認ロジックを無効化
- 精度が確立するまで手動承認必須

### 3. 日次承認インボックスUIの更新
- 表示カラムを指定順に変更: 承認, product_name, product_name_normalized, general_name, 店舗, 信頼度
- インライン編集機能を追加
- ボタンを2つに分離:
  - **✏️ 修正を反映**: 編集内容を保存（未承認のまま）
  - **✅ 修正して承認**: 編集内容を保存して承認
- ファイル: `K_kakeibo/review_ui.py` (Lines 1024-1084)

### 4. 承認済み商品の検索・編集機能追加
- 3つのフィルター: 店舗、商品名（部分一致）、カテゴリ
- 最大100件表示
- 承認済み商品も後から修正可能に
- ファイル: `K_kakeibo/review_ui.py` (Lines 1283-1384)

---

## コード参照状況

### `60_ms_categories`を参照しているファイル:

1. **K_kakeibo/transaction_processor.py** (Line 518-520)
   - カテゴリマスタを読み込み
   - 用途: 商品辞書の`category_id`を解決するため（直接使用は少ない）

2. **G_unified_pipeline/stage_h_kakeibo.py** (Line 341-344)
   - カテゴリマスタを読み込み
   - 用途: 読み込んでいるが実際には使われていない（self.categoriesの参照なし）

3. **L_product_classification/approve_clusters_cli.py** (Line 57-67)
   - 「食材」カテゴリを検索
   - 用途: クラスタ承認時に`category_id`を設定

4. **K_kakeibo/review_ui.py**
   - カテゴリ管理UI
   - カテゴリ選択ドロップダウン

5. **L_product_classification/ui_category_tree.py**
   - カテゴリツリー表示UI

6. **L_product_classification/ui_bulk_clustering.py**
   - バッチクラスタリングUI

---

## 重要な設計原則

### 2層辞書アーキテクチャ
- **Tier 1**: 名称正規化（N:1マッピング）
  - `raw_keyword` → `general_name`
  - テーブル: `70_ms_product_normalization`
- **Tier 2**: 分類（1:1マッピング）
  - `general_name` + context → `category_id`
  - テーブル: `70_ms_product_classification`

### 3層フォールバック分類
1. Tier 1辞書ルックアップ
2. Tier 2辞書ルックアップ
3. Gemini few-shot推論（辞書に未登録の場合）

---

## Windowsで作業再開する際の確認事項

1. データベースのカテゴリデータを確認:
   ```python
   from A_common.database.client import DatabaseClient
   db = DatabaseClient(use_service_role=True)
   result = db.client.table('60_ms_categories').select('*').order('name').execute()
   for cat in result.data:
       print(f'{cat["id"][:8]}... | {cat["name"]:<20}')
   ```

2. カテゴリ再構築の影響範囲を完全に把握

3. ユーザーに再構築方針を確認

---

## データベーステーブル構造

### 商品関連
- `80_rd_products`: 商品マスタ（レシート・オンラインショップから収集）
- `70_ms_product_normalization`: Tier 1辞書（商品名正規化）
- `70_ms_product_classification`: Tier 2辞書（商品分類）
- `60_ms_categories`: カテゴリマスタ（**再構築検討中**）

### 家計簿関連
- `60_rd_receipts`: レシート親テーブル
- `60_rd_transactions`: トランザクション子テーブル（OCR明細行）
- `60_rd_standardized_items`: 正規化アイテム孫テーブル（家計簿情報）

### マスタデータ
- `60_ms_ocr_aliases`: OCRエイリアステーブル
- `60_ms_product_dict`: 商品辞書（旧方式、段階的に廃止予定）
- `60_ms_situations`: シチュエーションマスタ

---

## 関連ドキュメント

プロジェクト設計図は以下に分散:
- `README.md`: プロジェクト概要
- `K_kakeibo/README.md`: 家計簿システム説明
- `L_product_classification/README.md`: 商品分類システム説明
- `database/migrations/PLAN_kakeibo_3table_split.md`: 3層テーブル分割計画
- `database/migrations/README_MIGRATION.md`: マイグレーション手順
- `G_unified_pipeline/README.md`: 統合パイプライン説明
- `G_unified_pipeline/config/ARCHITECTURE.md`: アーキテクチャ設計

---

## 次回作業時の優先順位

1. **最優先**: カテゴリシステムの再構築方針決定
   - 現在のカテゴリデータを確認
   - 影響範囲を完全に把握
   - どちらのオプションを選ぶか決定

2. **その後**: 選択したオプションで実装
   - マイグレーションスクリプト作成
   - コード修正
   - テスト

3. **将来タスク**: クラスタ承認の重複作業問題を解決
   - ユーザーが指摘: 「一般名詞があるのに、クラスタ承認って、２重作業じゃないの？」
   - システム設計の見直しが必要かもしれない
