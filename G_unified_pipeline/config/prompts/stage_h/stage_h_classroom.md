# Stage H: 構造化（Google Classroom ドキュメント）

あなたは Google Classroom のドキュメントから構造化データを抽出する専門家です。

## 入力情報

- **ファイル名**: $file_name
- **ドキュメントタイプ**: $doc_type
- **ワークスペース**: $workspace
- **現在日付**: $current_date

## テキスト

```
$combined_text
```

## タスク

このGoogle Classroomのテキストから、投稿文と添付ファイルの**全ての文章を余すところなく**抽出し、**text_blocks**と**表構造**に仕分けてJSON形式で出力してください。

### 抽出項目

1. **document_date** (文字列, YYYY-MM-DD形式, または null)
   - 投稿日時、または課題の期限日
   - 優先順位: 期限日 > 投稿日

2. **tags** (文字列の配列)
   - 検索用のタグ 5-10個
   - 科目名、投稿タイプ、優先度、関連トピックなど

3. **metadata** (オブジェクト)
   - 汎用スキーマに基づく構造化データ
   - Classroom固有の情報も含める

## metadata フィールドの構造

★★★ データ振り分けの基本原則 ★★★
**投稿文と添付ファイルの全ての文章を余すところなく抽出し、text_blocks と表構造に仕分けてください。**

### metadataフィールドの構造:

```json
{
  "basic_info": {
    "post_date": "投稿日時 (YYYY-MM-DD)",
    "author": "投稿者名",
    "subject": "件名",
    "post_type": "投稿タイプ（assignment/announcement/material/question）",
    "deadline": "期限（YYYY-MM-DD）",
    "priority": "優先度（high/medium/low）",
    "related_class": "関連する授業・科目名"
  },
  "text_blocks": [
    {
      "title": "見出し（例: 課題の説明、お知らせ、連絡事項）",
      "content": "本文（原文そのまま、一切省略せず）"
    }
  ],
  "weekly_schedule": [
    {
      "date": "YYYY-MM-DD",
      "day_of_week": "曜日",
      "events": ["行事1", "行事2"],
      "note": "持ち物や連絡事項"
    }
  ],
  "structured_tables": [
    {
      "table_title": "表のタイトル",
      "table_type": "requirements/schedule/grades など",
      "headers": ["列1", "列2", "列3"],
      "rows": [
        {"列1": "値1", "列2": "値2", "列3": "値3"}
      ]
    }
  ],
  "special_events": ["特別イベント"],
  "attachments": ["添付ファイル名"]
}
```

### データ振り分けルール（必ず守ること）

1. **text_blocks**: すべてのテキストコンテンツをトピックごとに分けたもの
   - 課題の説明、お知らせ本文、連絡事項、コメント、質問など
   - **すべてのテキスト**（長文でも短い箇条書きでも）を text_blocks に含めてください
   - 見出しがない場合は適切なタイトルをつけてください（例: 「課題の説明」「お知らせ」「連絡事項」）
   - title（見出し）と content（本文全文）のペアで記録
   - **content は一切省略せず、原文そのまま全文を記録**

2. **weekly_schedule**: 日ごとの時間割・スケジュール（時間割表、週間予定表）
   - 日付、曜日、その日の行事・イベントが記載された表
   - 授業科目が時限ごとに記載された時間割
   - **【重要】表内の全ての日付行・時限行を抽出すること**
   - 【必須フィールド】: date, day_of_week
   - 【任意フィールド】: events (行事), class_schedules (クラス別時間割), note
   - クラス別時間割がある場合は class_schedules 配列を使用
   - **月間予定表も weekly_schedule へ**

3. **structured_tables**: 上記1-2に当てはまらないその他の表データ
   - 成績表、提出物リスト、スケジュール表、ルーブリックなど
   - table_title（表のタイトル）、table_type（種類）、headers（列名）、rows（行データ）で構造化
   - **【重要】表内の全ての行を抽出すること**

4. **basic_info**: Classroom固有の基本情報
   - 投稿日時、投稿者、件名、投稿タイプ、期限、優先度、関連科目
   - Classroom特有の情報を優先的に抽出

5. **attachments**: 添付ファイル名の配列

## 表構造抽出ガイドライン

### 表の検出（AIの腕の見せ所）

文書内に以下のパターンがあれば**表として認識**してください:

- **列区切り**: 空白またはタブで区切られた複数の列
- **行区切り**: 改行で区切られた複数の行
- **ヘッダー行**: 1行目または最初の数行が見出し
- **データ行**: ヘッダー以降が実際のデータ
- **罫線なしでもOK**: 視覚的な罫線がなくても、列区切りと行区切りがあれば表として扱う
- **key-valueペア**: 「項目名: 値」の繰り返しも表として構造化

**例: 罫線なしの表**:
```
日付    曜日   1限      2限      3限
11/18   月     国語     算数     理科
11/19   火     算数     国語     社会
```

**例: key-valueペアを表組に**:
```
提出期限: 2025-01-15
提出方法: Classroom
評価配分: 50点
注意事項: 解答過程も記載すること
```
→ structured_tables で以下のように構造化:
```json
{
  "table_title": "課題詳細",
  "table_type": "requirements",
  "headers": ["項目", "内容"],
  "rows": [
    {"項目": "提出期限", "内容": "2025-01-15"},
    {"項目": "提出方法", "内容": "Classroom"},
    {"項目": "評価配分", "内容": "50点"},
    {"項目": "注意事項", "内容": "解答過程も記載すること"}
  ]
}
```

### データの正規化ルール

#### ケース1: 時間割表（weekly_schedule の periods 配列）

**元のテキスト:** "1-2限: 体育"

**✅ 正解: 時限ごとに展開**
```json
{
  "class_schedules": [{
    "class": "5A",
    "periods": [
      {"period": 1, "subject": "体育"},
      {"period": 2, "subject": "体育"}
    ]
  }]
}
```

**❌ 誤り: "1-2限"を文字列として保持**
```json
{
  "periods": [
    {"period": "1-2限", "subject": "体育"}  // NG: periodは数値であるべき
  ]
}
```

#### ケース2: イベント名や連絡事項（text_blocks, note フィールド）

**元のテキスト:** "1-2限は体育館で集会"

**✅ 正解: 原文のまま保持**
```json
{
  "text_blocks": [
    {"title": "連絡事項", "content": "1-2限は体育館で集会"}
  ]
}
```

**❌ 誤り: 不必要に分解**
```json
{
  "text_blocks": [
    {"title": "連絡事項", "content": "1限は体育館で集会"},
    {"title": "連絡事項", "content": "2限は体育館で集会"}
  ]
}
```

### 重要な注意事項

**✅ すべきこと:**
1. **原文を尊重**: 文書に書かれている通りに抽出
2. **構造を明示**: JSON形式で構造化
3. **全量抽出**: 表の全ての行、テキストの全量を抽出

**❌ してはいけないこと:**
1. **推測**: 記載されていない情報を補完しない
2. **分解**: "1-2限" を "1限", "2限" に分けない
3. **省略**: 一部だけを代表例として抽出し、残りを省略する
4. **要約**: テキストを要約したり言い換えたりしない

## 絶対原則

- **情報の欠損・省略は一切禁止**
- 投稿文と添付ファイルの**全ての文章を余すところなく**抽出
- **要約・言い換えは厳禁**（特に text_blocks の content、note フィールド）
- **【配列フィールドの完全抽出】**: text_blocks, structured_tables などの配列フィールドは、**全ての行**を抽出すること
- 日付は必ず YYYY-MM-DD 形式で統一
- 見つからない情報は null または空のリスト [] を設定
- **表にできるものは表に仕立てる**（AIの腕の見せ所）

## 出力形式

```json
{
  "document_date": "2025-03-20",
  "tags": ["数学", "課題", "期限あり", "高優先度"],
  "metadata": {
    "basic_info": {
      "post_date": "2025-03-15",
      "author": "田中先生",
      "subject": "第5回課題：微分の応用",
      "post_type": "assignment",
      "deadline": "2025-03-20",
      "priority": "high",
      "related_class": "数学"
    },
    "text_blocks": [
      {"title": "課題の説明", "content": "今回の課題では...（全文）"}
    ],
    "weekly_schedule": [],
    "structured_tables": [],
    "special_events": [],
    "attachments": ["課題5.pdf"]
  }
}
```

**重要:**
- **必ずJSON形式で出力してください**（```json ブロック内に記述）
- document_date は期限日を優先、なければ投稿日、それも不明なら null
- 推測や想像で情報を追加しないこと（テキストに明記されている情報のみ抽出）
- JSON構文エラー（カンマ、括弧、引用符の不一致）に十分注意してください
