# Stage H: 構造化（Structuring）

あなたは非構造化テキストから構造化データを抽出する専門家です。

## 入力情報

- **ファイル名**: $file_name
- **ドキュメントタイプ**: $doc_type
- **ワークスペース**: $workspace
- **現在日付**: $current_date

## テキスト

```
$combined_text
```

## タスク

このテキストから、投稿文と添付ファイルの**全ての文章を余すところなく**抽出し、**text_blocks**と**表構造**に仕分けてJSON形式で出力してください。

### 抽出項目

1. **document_date** (文字列, YYYY-MM-DD形式, または null)
   - ドキュメントの基準日（作成日、発行日、イベント日など）

2. **tags** (文字列の配列)
   - 検索用のタグ 5-10個
   - カテゴリ、トピック、キーワードなど

3. **metadata** (オブジェクト)
   - 汎用スキーマに基づく構造化データ
   - 以下の構造に従ってください

## metadata フィールドの構造

★★★ データ振り分けの基本原則 ★★★
**投稿文と添付ファイルの全ての文章を余すところなく抽出し、text_blocks と表構造に仕分けてください。**

### metadataフィールドの構造:

```json
{
  "basic_info": {
    "document_title": "文書タイトル",
    "issue_date": "発行日（YYYY-MM-DD）",
    "period": "対象期間（例: 2024年11月18日-21日）",
    "document_number": "文書番号（例: 第12号）"
  },
  "text_blocks": [
    {
      "title": "見出し（例: 朝会「マナーとルールについて」）",
      "content": "本文（原文そのまま、一切省略せず）"
    }
  ],
  "weekly_schedule": [
    {
      "date": "YYYY-MM-DD",
      "day": "曜日（月、火など）",
      "day_of_week": "曜日フル（月曜日など）",
      "events": ["行事1", "行事2"],
      "class_schedules": [
        {
          "class": "5A",
          "subjects": ["1限:国語", "2限:算数", "3限:理科"],
          "periods": [
            {"period": 1, "subject": "国語", "time": "8:45-9:30"},
            {"period": 2, "subject": "算数", "time": "9:40-10:25"}
          ]
        }
      ],
      "note": "持ち物や連絡事項（原文そのまま）"
    }
  ],
  "structured_tables": [
    {
      "table_title": "表のタイトル",
      "table_type": "requirements/events/scores/contacts など",
      "headers": ["列1", "列2", "列3"],
      "rows": [
        {"列1": "値1", "列2": "値2", "列3": "値3"}
      ]
    }
  ],
  "special_events": [
    "特別イベント1"
  ],
  "other_text": [
    {
      "type": "greeting/contact_info/signature/note/footer/misc",
      "content": "その他のテキスト（時候の挨拶、連絡先、署名、注釈など）"
    }
  ]
}
```

### データ振り分けルール（必ず守ること）

1. **text_blocks**: すべてのテキストコンテンツをトピックごとに分けたもの
   - 朝会の話、今日のふりかえり、道徳の内容、先生からのメッセージ、連絡事項、お知らせなど
   - 学級通信や学年通信の記事、お知らせ本文、箇条書きの連絡事項など
   - **すべてのテキスト**（長文でも短い箇条書きでも）を text_blocks に含めてください
   - 見出しがない場合は適切なタイトルをつけてください（例: 「連絡事項」「お知らせ」「持ち物について」）
   - title（見出し）と content（本文全文）のペアで記録
   - **content は一切省略せず、原文そのまま全文を記録**

   **【重要】text_blocks の粒度ガイドライン（ベクトル検索精度向上のため）**
   - **原則: 1トピック = 1ブロック**
   - 長い説明文は、サブトピックごとに分割してください
   - 各ブロックは **100-300文字を目安** に（厳密でなくてもOK、トピックの境界を優先）
   - 例: 「お知らせ」が長い場合:
     - ✅ 「イベント概要」「参加方法」「注意事項」「持ち物」に分割
     - ❌ 全体を1つのブロックにまとめる（500文字以上になる場合）
   - 理由: ベクトル検索では「持ち物は？」という質問に対して、該当ブロックのみがヒットする必要がある

2. **weekly_schedule**: 日ごとの時間割・スケジュール（時間割表、週間予定表）
   - 日付、曜日、その日の行事・イベントが記載された表
   - 授業科目が時限ごとに記載された時間割
   - **【重要】表内の全ての日付行・時限行を抽出すること**
   - 【必須フィールド】: date, day_of_week
   - 【任意フィールド】: events (行事), class_schedules (クラス別時間割), note
   - クラス別時間割がある場合は class_schedules 配列を使用
   - **月間予定表も weekly_schedule へ**

3. **structured_tables**: 上記1-2に当てはまらないその他の表データ
   - 持ち物リスト、成績表、提出物リスト、制服価格表、給食献立、会場一覧など
   - 時間割・予定表でない汎用的な表はすべてこちら
   - table_title（表のタイトル）、table_type（種類）、headers（列名）、rows（行データ）で構造化
   - **【重要】表内の全ての行を抽出すること**

4. **basic_info**: 文書の基本情報
   - 文書タイトル、発行日、対象期間などの基本情報を抽出
   - **注意**: basic_infoの中身は文書の種類に応じて柔軟に設定してください
   - 固定フィールド（school_name, gradeなど）にこだわらず、ドキュメントに適したフィールドを使用

5. **special_events**: 特別イベント・行事
   - 通常授業以外の特別な予定

6. **other_text**: 上記1-5に該当しない、その他の全てのテキスト
   - 時候の挨拶（「いつもお世話になっております」等）
   - お問い合わせ窓口・連絡先（「お問い合わせ: 03-1234-5678」等）
   - 署名・落款（「○○学校 △△先生」等）
   - 注釈・補足（「※印の文章」「補足説明」等）
   - フッター情報（「本メールは自動送信です」等）
   - その他、分類しづらいが存在する全てのテキスト
   - **重要**: 「本題と関係ない」と判断して削除してはいけません
   - **理由**: 利用するかどうかの判断は人間が行います。AIは全ての情報を忠実に抽出することに専念してください

## 表構造抽出ガイドライン

### 表の検出（AIの腕の見せ所）

文書内に以下のパターンがあれば**表として認識**してください:

- **列区切り**: 空白またはタブで区切られた複数の列
- **行区切り**: 改行で区切られた複数の行
- **ヘッダー行**: 1行目または最初の数行が見出し
- **データ行**: ヘッダー以降が実際のデータ
- **罫線なしでもOK**: 視覚的な罫線がなくても、列区切りと行区切りがあれば表として扱う
- **key-valueペア**: 「項目名: 値」の繰り返しも表として構造化

**例: 罫線なしの表**:
```
日付    曜日   1限      2限      3限
11/18   月     国語     算数     理科
11/19   火     算数     国語     社会
```

**例: key-valueペアを表組に**:
```
連絡方法: 早稲田アカデミーOnline
電話番号: 03-1234-5678
受付時間: 平日9:00-17:00
会場数: 44会場
```
→ structured_tables で以下のように構造化:
```json
{
  "table_title": "連絡先情報",
  "table_type": "contact_info",
  "headers": ["項目", "内容"],
  "rows": [
    {"項目": "連絡方法", "内容": "早稲田アカデミーOnline"},
    {"項目": "電話番号", "内容": "03-1234-5678"},
    {"項目": "受付時間", "内容": "平日9:00-17:00"},
    {"項目": "会場数", "内容": "44会場"}
  ]
}
```

### データの正規化ルール

#### ケース1: 時間割表（weekly_schedule の periods 配列）

**元のテキスト:** "1-2限: 体育"

**✅ 正解: 時限ごとに展開**
```json
{
  "class_schedules": [{
    "class": "5A",
    "periods": [
      {"period": 1, "subject": "体育"},
      {"period": 2, "subject": "体育"}
    ]
  }]
}
```

**❌ 誤り: "1-2限"を文字列として保持**
```json
{
  "periods": [
    {"period": "1-2限", "subject": "体育"}  // NG: periodは数値であるべき
  ]
}
```

#### ケース2: イベント名や連絡事項（text_blocks, note フィールド）

**元のテキスト:** "1-2限は体育館で集会"

**✅ 正解: 原文のまま保持**
```json
{
  "text_blocks": [
    {"title": "連絡事項", "content": "1-2限は体育館で集会"}
  ]
}
```

**❌ 誤り: 不必要に分解**
```json
{
  "text_blocks": [
    {"title": "連絡事項", "content": "1限は体育館で集会"},
    {"title": "連絡事項", "content": "2限は体育館で集会"}
  ]
}
```

### 重要な注意事項

**✅ すべきこと:**
1. **原文を尊重**: 文書に書かれている通りに抽出
2. **構造を明示**: JSON形式で構造化
3. **全量抽出**: 表の全ての行、テキストの全量を抽出

**❌ してはいけないこと:**
1. **推測**: 記載されていない情報を補完しない
2. **分解**: "1-2限" を "1限", "2限" に分けない
3. **省略**: 一部だけを代表例として抽出し、残りを省略する
4. **要約**: テキストを要約したり言い換えたりしない

## ⚠️ 絶対原則：全量抽出

**文書内の全てのテキストを、必ずどこかに分類してください**

### 分類フロー:

1. text_blocks に該当する → text_blocks へ
2. 表として構造化できる → structured_tables へ
3. スケジュール情報 → weekly_schedule へ
4. **上記のどれにも該当しない** → other_text へ

### 重要事項:

- **情報の欠損・省略は一切禁止**
- 投稿文と添付ファイルの**全ての文章を余すところなく**抽出
- **要約・言い換えは厳禁**（特に text_blocks の content、note フィールド）
- **【配列フィールドの完全抽出】**: text_blocks, structured_tables などの配列フィールドは、**全ての行**を抽出すること
- 日付は必ず YYYY-MM-DD 形式で統一
- 見つからない情報は null または空のリスト [] を設定
- **表にできるものは表に仕立てる**（AIの腕の見せ所）

### 検証ステップ（必須）

抽出後、以下を確認してください：

1. **元のテキストを読み直す**
2. **抽出結果に含まれていないテキストがないか確認**
3. **漏れがあれば、適切なカテゴリ（またはother_text）に追加**
4. **文字数の合計がほぼ一致するまで繰り返す**

例：
- 元のテキスト: 1500文字
- 抽出結果の合計: 1480文字 → ✅ 許容範囲（98%以上）
- 抽出結果の合計: 1200文字 → ❌ 300文字（20%）漏れている！再確認必須

**全てのテキストが、最終的にどこかのチャンク（text_blocks, structured_tables, weekly_schedule, other_text のいずれか）に含まれていることを保証してください。**

## 出力形式

```json
{
  "document_date": "YYYY-MM-DD",
  "tags": ["タグ1", "タグ2", "タグ3"],
  "metadata": {
    "basic_info": {
      "document_title": "◯◯のご案内",
      "issue_date": "YYYY-MM-DD"
    },
    "text_blocks": [
      {"title": "イベント概要", "content": "今週は...（100-300文字程度）"},
      {"title": "参加方法", "content": "参加を希望される方は..."},
      {"title": "持ち物", "content": "当日は以下をご持参ください..."}
    ],
    "weekly_schedule": [],
    "structured_tables": [],
    "special_events": [],
    "other_text": [
      {"type": "greeting", "content": "いつもお世話になっております"},
      {"type": "contact_info", "content": "お問い合わせ: 03-1234-5678"}
    ]
  }
}
```

**重要:**
- **必ずJSON形式で出力してください**（```json ブロック内に記述）
- 推測や想像で情報を追加しないこと（テキストに明記されている情報のみ抽出）
- JSON構文エラー（カンマ、括弧、引用符の不一致）に十分注意してください
