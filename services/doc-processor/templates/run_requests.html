<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run Requests - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1em;
        }

        .nav-links {
            margin-top: 15px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
            padding: 5px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .main-content {
            padding: 30px;
        }

        .form-section {
            background: #f9fafb;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .requests-list {
            margin-top: 30px;
        }

        .request-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #2563eb;
        }

        .request-card.completed {
            border-left-color: #10b981;
        }

        .request-card.failed {
            border-left-color: #ef4444;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .request-id {
            font-family: monospace;
            background: #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .request-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .request-status.queued {
            background: #fef3c7;
            color: #92400e;
        }

        .request-status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .request-status.processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .request-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .request-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            font-size: 0.9em;
        }

        .info-item .label {
            color: #6b7280;
            margin-bottom: 4px;
        }

        .info-item .value {
            font-weight: 600;
            color: #1f2937;
        }

        .execution-history {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .execution-history h4 {
            color: #374151;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .execution-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .command-box {
            background: #1f2937;
            color: #d1d5db;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 15px;
            overflow-x: auto;
        }

        .command-box code {
            color: #10b981;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-execute {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-execute:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-execute:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-execute.processing {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .btn-retry {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-retry:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-delete {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-delete:hover:not(:disabled) {
            background: #ef4444;
            transform: translateY(-2px);
        }

        .doc-titles {
            margin-top: 10px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 0.85em;
            color: #4b5563;
        }

        .doc-titles-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .doc-titles-list {
            word-break: break-all;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            display: block;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #1e40af;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state p {
            margin-bottom: 10px;
        }

        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .dashboard-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-panel {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
        }

        .dashboard-panel h3 {
            color: #1f2937;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }

        .queue-item {
            text-align: center;
            padding: 12px 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .queue-item .count {
            font-size: 1.8em;
            font-weight: 700;
            line-height: 1;
        }

        .queue-item .label {
            font-size: 0.75em;
            color: #6b7280;
            margin-top: 4px;
        }

        .queue-item.pending .count { color: #f59e0b; }
        .queue-item.queued .count { color: #8b5cf6; }
        .queue-item.processing .count { color: #3b82f6; }
        .queue-item.completed .count { color: #10b981; }
        .queue-item.failed .count { color: #ef4444; }

        .worker-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .worker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 6px;
            border: 1px solid #e5e7eb;
        }

        .worker-item .worker-id {
            font-family: monospace;
            font-size: 0.8em;
            color: #374151;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .worker-item .worker-count {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .worker-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #eff6ff;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .worker-summary .total {
            font-size: 1.5em;
            font-weight: 700;
            color: #2563eb;
        }

        .worker-summary .label {
            font-size: 0.85em;
            color: #1e40af;
        }

        .dashboard-updated {
            font-size: 0.75em;
            color: #9ca3af;
            text-align: right;
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
        }

        .btn-refresh {
            background: #e5e7eb;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-refresh:hover {
            background: #d1d5db;
        }

        .no-workers {
            text-align: center;
            color: #9ca3af;
            padding: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ Processing Queue</h1>
            <p>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ã‚­ãƒ¥ãƒ¼ã®ç®¡ç†</p>
            <div class="nav-links">
                <a href="/">Run Requests</a>
            </div>
        </div>

        <div class="main-content">
            <!-- æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ -->
            <div class="info-box">
                <p><strong>è¨­è¨ˆåŸå‰‡:</strong> pending â†’ queued â†’ processing â†’ completed/failed</p>
                <p><strong>ä½¿ã„æ–¹:</strong> ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã§ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã€‚Worker ãŒè‡ªå‹•çš„ã« queued ã‚’æ¶ˆåŒ–ã—ã¾ã™ã€‚</p>
            </div>

            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div class="dashboard-section" id="dashboard-section">
                <!-- Queue ãƒ‘ãƒãƒ« -->
                <div class="dashboard-panel">
                    <h3>ğŸ“Š Queue çŠ¶æ…‹</h3>
                    <div class="queue-grid" id="queue-grid">
                        <div class="queue-item pending">
                            <div class="count" id="q-pending">-</div>
                            <div class="label">Pending</div>
                        </div>
                        <div class="queue-item queued">
                            <div class="count" id="q-queued">-</div>
                            <div class="label">Queued</div>
                        </div>
                        <div class="queue-item processing">
                            <div class="count" id="q-processing">-</div>
                            <div class="label">Processing</div>
                        </div>
                        <div class="queue-item completed">
                            <div class="count" id="q-completed">-</div>
                            <div class="label">Completed</div>
                        </div>
                        <div class="queue-item failed">
                            <div class="count" id="q-failed">-</div>
                            <div class="label">Failed</div>
                        </div>
                    </div>
                    <div class="dashboard-updated">
                        <span id="dashboard-updated">æ›´æ–°ä¸­...</span>
                        <button class="btn-refresh" onclick="loadDashboard()">ğŸ”„</button>
                    </div>
                </div>

                <!-- Workers ãƒ‘ãƒãƒ« -->
                <div class="dashboard-panel">
                    <h3>ğŸ‘· Workers</h3>
                    <div class="worker-summary">
                        <div>
                            <div class="total" id="w-active">-</div>
                            <div class="label">ä¸¦åˆ—å‡¦ç†ä¸­</div>
                        </div>
                    </div>
                    <div class="worker-list" id="worker-list">
                        <div class="no-workers">ãƒ¯ãƒ¼ã‚«ãƒ¼æƒ…å ±ãªã—</div>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="status-message" id="status-message"></div>

            <!-- ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
            <h2 style="margin-bottom: 20px; color: #1f2937;">â• ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ </h2>
            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="max-items">è¿½åŠ ä»¶æ•°ï¼ˆpending â†’ queuedï¼‰</label>
                        <input type="number" id="max-items" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="workspace">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆçœç•¥å¯ï¼‰</label>
                        <select id="workspace">
                            <option value="">å…¨ä½“ï¼ˆæŒ‡å®šãªã—ï¼‰</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="doc-id">ç‰¹å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆçœç•¥å¯ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å¯ï¼‰</label>
                    <input type="text" id="doc-id" placeholder="UUID ã‚’å…¥åŠ›ï¼ˆçœç•¥æ™‚ã¯ pending ã‹ã‚‰è‡ªå‹•é¸æŠï¼‰">
                </div>
                <button class="btn btn-primary" onclick="enqueueDocuments()">
                    â• ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
                </button>
                <button class="btn" id="btn-execute" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-left: 10px;" onclick="executeQueue()">
                    â–¶ å®Ÿè¡Œ
                </button>
                <button class="btn btn-secondary" onclick="refreshQueue()">
                    ğŸ”„ ä¸€è¦§ã‚’æ›´æ–°
                </button>
                <button class="btn" style="background: #ef4444; color: white; margin-left: 10px;" onclick="clearQueue()">
                    ğŸ—‘ ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                </button>
                <button class="btn" style="background: #f59e0b; color: white; margin-left: 10px;" onclick="clearLock()">
                    ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤
                </button>
                <button class="btn" style="background: #8b5cf6; color: white; margin-left: 10px;" onclick="retryFailed()">
                    ğŸ”„ å¤±æ•—ã‚’å†å®Ÿè¡Œ
                </button>
            </div>

            <!-- ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
            <h2 style="margin-bottom: 20px; color: #1f2937;">ğŸš« Gatekeeper ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå‡¦ç†å¯¾è±¡å¤–ï¼‰</h2>
            <div class="requests-list" id="blocked-list" style="margin-bottom: 40px;">
                <div class="empty-state">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- å‡¦ç†å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
            <h2 style="margin-bottom: 20px; color: #1f2937;">âŒ å‡¦ç†å¤±æ•—</h2>
            <div class="requests-list" id="failed-list" style="margin-bottom: 40px;">
                <div class="empty-state">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- ã‚­ãƒ¥ãƒ¼ä¸€è¦§ -->
            <h2 style="margin-bottom: 20px; color: #1f2937;">ğŸ“‹ ã‚­ãƒ¥ãƒ¼å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>
            <div class="requests-list" id="queue-list">
                <div class="empty-state">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
        const POLLING_INTERVAL = 5000;
        let pollingTimer = null;
        let hasProcessing = false;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('load', function() {
            loadWorkspaces();
            refreshQueue();
            loadBlockedDocuments();
            loadFailedDocuments();
            loadDashboard();
            startPolling();
        });

        // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        function startPolling() {
            if (pollingTimer) return;
            pollingTimer = setInterval(() => {
                refreshQueue();
                loadBlockedDocuments();
                loadFailedDocuments();
                loadDashboard();
            }, POLLING_INTERVAL);
        }

        // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å¤‰æ›´æ™‚ã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚‚æ›´æ–°
        document.getElementById('workspace').addEventListener('change', function() {
            loadDashboard();
            refreshQueue();
            loadBlockedDocuments();
            loadFailedDocuments();
        });

        // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadWorkspaces() {
            try {
                const response = await fetch('/internal/workspaces');
                const data = await response.json();

                if (data.success && data.workspaces) {
                    const select = document.getElementById('workspace');
                    data.workspaces.forEach(workspace => {
                        const option = document.createElement('option');
                        option.value = workspace;
                        option.textContent = workspace;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
        async function loadDashboard() {
            try {
                const workspace = document.getElementById('workspace').value || '';
                const url = workspace
                    ? `/internal/dashboard?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/dashboard';

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    // Queue çŠ¶æ…‹ã‚’æ›´æ–°
                    document.getElementById('q-pending').textContent = data.queue.pending || 0;
                    document.getElementById('q-queued').textContent = data.queue.queued || 0;
                    document.getElementById('q-processing').textContent = data.queue.processing || 0;
                    document.getElementById('q-completed').textContent = data.queue.completed || 0;
                    document.getElementById('q-failed').textContent = data.queue.failed || 0;

                    // Workers çŠ¶æ…‹ã‚’æ›´æ–°
                    document.getElementById('w-active').textContent = data.workers.active_processing;

                    const workerList = document.getElementById('worker-list');
                    if (data.workers.by_worker && data.workers.by_worker.length > 0) {
                        workerList.innerHTML = data.workers.by_worker.map(w => `
                            <div class="worker-item">
                                <span class="worker-id" title="${w.worker_id}">${w.worker_id}</span>
                                <span class="worker-count">${w.count} ä»¶</span>
                            </div>
                        `).join('');
                    } else {
                        workerList.innerHTML = '<div class="no-workers">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¯ãƒ¼ã‚«ãƒ¼ãªã—</div>';
                    }

                    // æ›´æ–°æ™‚åˆ»
                    const now = new Date();
                    document.getElementById('dashboard-updated').textContent =
                        `æœ€çµ‚æ›´æ–°: ${now.toLocaleTimeString('ja-JP')} (${data.workspace})`;
                }
            } catch (error) {
                console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('dashboard-updated').textContent = 'æ›´æ–°ã‚¨ãƒ©ãƒ¼';
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        async function enqueueDocuments() {
            const limit = parseInt(document.getElementById('max-items').value) || 10;
            const workspace = document.getElementById('workspace').value || null;
            const docIdInput = document.getElementById('doc-id').value.trim();

            try {
                const body = { limit: limit };
                if (workspace) body.workspace = workspace;
                if (docIdInput) {
                    // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°IDã«å¯¾å¿œ
                    body.doc_ids = docIdInput.split(',').map(id => id.trim()).filter(id => id);
                }

                const response = await fetch('/internal/run-requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('success', `âœ… ${data.enqueued_count}ä»¶ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸ`);
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œï¼ˆWorker ã‚’èµ·å‹•ï¼‰
        let isExecuting = false;
        let executionMonitorTimer = null;

        async function executeQueue() {
            if (isExecuting) return;

            const btn = document.getElementById('btn-execute');
            const workspace = document.getElementById('workspace').value || 'all';
            const limit = parseInt(document.getElementById('max-items').value) || 10;

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            isExecuting = true;
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.innerHTML = 'â³ å®Ÿè¡Œä¸­...';

            try {
                showMessage('info', 'â³ Worker ã‚’èµ·å‹•ä¸­...');

                const response = await fetch('/internal/queue/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace: workspace,
                        limit: limit
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let msg = `âœ… ${data.message}`;
                    if (data.log_file) {
                        msg += `\nãƒ­ã‚°: ${data.log_file}`;
                    }
                    showMessage('success', msg);

                    // å‡¦ç†å®Œäº†ã‚’ç›£è¦–
                    startExecutionMonitor();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                    resetExecuteButton();
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                resetExecuteButton();
            }
        }

        function startExecutionMonitor() {
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (executionMonitorTimer) {
                clearInterval(executionMonitorTimer);
            }

            // 3ç§’ã”ã¨ã«ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’ç¢ºèª
            executionMonitorTimer = setInterval(async () => {
                try {
                    const response = await fetch('/internal/dashboard');
                    const data = await response.json();

                    if (data.success) {
                        const queue = data.queue;
                        const queued = queue.queued || 0;
                        const processing = queue.processing || 0;

                        // æ›´æ–°
                        refreshQueue();
                        loadDashboard();

                        // queued ã‚‚ processing ã‚‚ 0 ãªã‚‰å®Œäº†
                        if (queued === 0 && processing === 0) {
                            clearInterval(executionMonitorTimer);
                            executionMonitorTimer = null;
                            showMessage('success', 'âœ… å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
                            resetExecuteButton();
                        }
                    }
                } catch (error) {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç›£è¦–ã‚’åœæ­¢ã—ã¦ãƒœã‚¿ãƒ³ã‚’æˆ»ã™
                    clearInterval(executionMonitorTimer);
                    executionMonitorTimer = null;
                    resetExecuteButton();
                }
            }, 3000);
        }

        function resetExecuteButton() {
            const btn = document.getElementById('btn-execute');
            isExecuting = false;
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.innerHTML = 'â–¶ å®Ÿè¡Œ';
        }

        // å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å†ã‚­ãƒ¥ãƒ¼
        async function retryFailed() {
            if (!confirm('å¤±æ•—ï¼ˆfailedï¼‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\n\nå†ã‚­ãƒ¥ãƒ¼å¾Œã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã§å‡¦ç†ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚')) {
                return;
            }

            const workspace = document.getElementById('workspace').value || 'all';

            try {
                const response = await fetch('/internal/queue/retry-failed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace: workspace
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.retry_count > 0) {
                        showMessage('success', `ğŸ”„ ${data.message}`);
                    } else {
                        showMessage('info', 'â„¹ï¸ å†ã‚­ãƒ¥ãƒ¼å¯¾è±¡ã®å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒ­ãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢
        async function clearLock() {
            if (!confirm('å‡¦ç†ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã€æ³¨æ„ã€‘\n- Worker ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ãƒ­ãƒƒã‚¯ãŒæ®‹ã£ãŸå ´åˆã«ä½¿ç”¨\n- å®Ÿè¡Œä¸­ã® Worker ãŒã‚ã‚‹å ´åˆã¯é‡è¤‡å‡¦ç†ã®ãƒªã‚¹ã‚¯ã‚ã‚Š')) {
                return;
            }

            try {
                const response = await fetch('/internal/queue/clear-lock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (data.was_locked) {
                        showMessage('success', `ğŸ”“ ${data.message}\nï¼ˆä»¥å‰: ${data.previous_state.locked_by || 'ä¸æ˜'}ï¼‰`);
                    } else {
                        showMessage('info', `â„¹ï¸ ${data.message}`);
                    }
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆqueued â†’ pending ã«æˆ»ã™ï¼‰
        async function clearQueue() {
            if (!confirm('ã‚­ãƒ¥ãƒ¼å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã™ã¹ã¦ pending ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆprocessing ä¸­ã®ã‚‚ã®ã¯è‡ªç„¶å®Œäº†ã—ã¾ã™ï¼‰')) {
                return;
            }

            const workspace = document.getElementById('workspace').value || null;

            try {
                const url = workspace
                    ? `/internal/queue/clear?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/queue/clear';

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('success', `âœ… ${data.cleared_count}ä»¶ã‚’ pending ã«æˆ»ã—ã¾ã—ãŸ`);
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚­ãƒ¥ãƒ¼ä¸€è¦§ã‚’æ›´æ–°
        async function refreshQueue() {
            try {
                const workspace = document.getElementById('workspace').value || '';
                const url = workspace
                    ? `/internal/run-requests?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/run-requests';

                const response = await fetch(url);
                const data = await response.json();

                const listEl = document.getElementById('queue-list');

                if (!data.success) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                    return;
                }

                const queuedDocs = data.queued_docs || [];
                const status = data.status || {};

                if (queuedDocs.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>ğŸ“­ ã‚­ãƒ¥ãƒ¼ï¼ˆqueuedï¼‰ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <p>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã§ pending ã‹ã‚‰ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦ãã ã•ã„</p>
                            <p style="margin-top: 10px; font-size: 0.9em; color: #6b7280;">
                                pending: ${status.pending || 0} / processing: ${status.processing || 0} / completed: ${status.completed || 0}
                            </p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = queuedDocs.map(doc => {
                    const title = doc.title || doc.file_name || '(ç„¡é¡Œ)';
                    const shortId = doc.id.substring(0, 8);

                    return `
                        <div class="request-card">
                            <div class="request-header">
                                <span class="request-id" title="${doc.id}">${shortId}...</span>
                                <span class="request-status queued">â³ queued</span>
                            </div>
                            <div class="doc-titles">
                                <div class="doc-titles-label">ğŸ“„ ${title}</div>
                            </div>
                            <div class="request-info">
                                <div class="info-item">
                                    <div class="label">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</div>
                                    <div class="value">${doc.workspace || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¨®åˆ¥</div>
                                    <div class="value">${doc.doc_type || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">è©¦è¡Œå›æ•°</div>
                                    <div class="value">${doc.attempt_count || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä½œæˆæ—¥æ™‚</div>
                                    <div class="value">${formatDate(doc.created_at)}</div>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn-delete" onclick="removeFromQueue('${doc.id}')" title="ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ï¼ˆpending ã«æˆ»ã™ï¼‰">
                                    ğŸ—‘ ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('ã‚­ãƒ¥ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('queue-list').innerHTML = `
                    <div class="empty-state">
                        <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    </div>
                `;
            }
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadBlockedDocuments() {
            try {
                const workspace = document.getElementById('workspace').value || '';
                const url = workspace
                    ? `/internal/blocked-documents?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/blocked-documents';

                const response = await fetch(url);
                const data = await response.json();

                const listEl = document.getElementById('blocked-list');

                if (!data.success) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                    return;
                }

                const blockedDocs = data.blocked_docs || [];
                const blockStats = data.block_stats || {};

                if (blockedDocs.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âœ… ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                            <p style="font-size: 0.9em; color: #6b7280;">ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒ Gatekeeper ã‚’é€šéã—ã¦ã„ã¾ã™</p>
                        </div>
                    `;
                    return;
                }

                // ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±åˆ¥ã®çµ±è¨ˆã‚’è¡¨ç¤º
                const statsHtml = Object.entries(blockStats)
                    .map(([code, count]) => `<span style="margin-right: 15px; color: #ef4444;">${code}: ${count}ä»¶</span>`)
                    .join('');

                const statsBar = `
                    <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 8px;">ğŸ“Š ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±åˆ¥é›†è¨ˆ</div>
                        <div style="font-size: 0.95em;">${statsHtml}</div>
                    </div>
                `;

                const docsHtml = blockedDocs.map(doc => {
                    const title = doc.title || doc.file_name || '(ç„¡é¡Œ)';
                    const shortId = doc.id.substring(0, 8);
                    const blockCode = doc.gate_block_code || 'UNKNOWN';
                    const blockReason = doc.gate_block_reason || 'ç†ç”±ä¸æ˜';

                    return `
                        <div class="request-card" style="border-left: 4px solid #ef4444;">
                            <div class="request-header">
                                <span class="request-id" title="${doc.id}">${shortId}...</span>
                                <span class="request-status failed" style="background: #fef2f2; color: #991b1b;">ğŸš« BLOCK</span>
                            </div>
                            <div class="doc-titles">
                                <div class="doc-titles-label">ğŸ“„ ${title}</div>
                            </div>
                            <div style="background: #fef2f2; padding: 12px; border-radius: 6px; margin: 10px 0;">
                                <div style="font-weight: 600; color: #991b1b; margin-bottom: 5px;">
                                    âŒ ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±: ${blockCode}
                                </div>
                                <div style="color: #7f1d1d; font-size: 0.9em;">
                                    ${blockReason}
                                </div>
                            </div>
                            <div class="request-info">
                                <div class="info-item">
                                    <div class="label">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</div>
                                    <div class="value">${doc.workspace || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä½œæˆã‚½ãƒ•ãƒˆ</div>
                                    <div class="value">${doc.origin_app || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä¿¡é ¼åº¦</div>
                                    <div class="value">${doc.origin_confidence || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</div>
                                    <div class="value">${doc.layout_profile || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ãƒãƒªã‚·ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                                    <div class="value">${doc.gate_policy_version || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">æ›´æ–°æ—¥æ™‚</div>
                                    <div class="value">${formatDate(doc.updated_at)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                listEl.innerHTML = statsBar + docsHtml;

            } catch (error) {
                console.error('ãƒ–ãƒ­ãƒƒã‚¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('blocked-list').innerHTML = `
                    <div class="empty-state">
                        <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    </div>
                `;
            }
        }

        // å‡¦ç†å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadFailedDocuments() {
            try {
                const workspace = document.getElementById('workspace').value || '';
                const url = workspace
                    ? `/internal/failed-documents?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/failed-documents';

                const response = await fetch(url);
                const data = await response.json();

                const listEl = document.getElementById('failed-list');

                if (!data.success) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                    return;
                }

                const failedDocs = data.failed_docs || [];
                const errorStats = data.error_stats || {};

                if (failedDocs.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âœ… å‡¦ç†å¤±æ•—ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                            <p style="font-size: 0.9em; color: #6b7280;">ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™</p>
                        </div>
                    `;
                    return;
                }

                // ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã®çµ±è¨ˆã‚’è¡¨ç¤ºï¼ˆä¸Šä½5ä»¶ã®ã¿ï¼‰
                const topErrors = Object.entries(errorStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const statsHtml = topErrors
                    .map(([error, count]) => {
                        const shortError = error.length > 40 ? error.substring(0, 40) + '...' : error;
                        return `<div style="margin-bottom: 5px;"><span style="color: #ef4444; font-weight: 600;">${count}ä»¶:</span> ${shortError}</div>`;
                    })
                    .join('');

                const statsBar = `
                    <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 8px;">ğŸ“Š ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥é›†è¨ˆï¼ˆä¸Šä½5ä»¶ï¼‰</div>
                        <div style="font-size: 0.9em;">${statsHtml}</div>
                    </div>
                `;

                const docsHtml = failedDocs.map(doc => {
                    const title = doc.title || doc.file_name || '(ç„¡é¡Œ)';
                    const shortId = doc.id.substring(0, 8);
                    const errorMsg = doc.error_message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
                    const attemptCount = doc.attempt_count || 0;

                    // metadataã‹ã‚‰è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å–å¾—
                    let metadata = {};
                    try {
                        if (typeof doc.metadata === 'string') {
                            metadata = JSON.parse(doc.metadata);
                        } else {
                            metadata = doc.metadata || {};
                        }
                    } catch (e) {
                        metadata = {};
                    }
                    const lastError = metadata.last_error || errorMsg;

                    return `
                        <div class="request-card" style="border-left: 4px solid #f59e0b;">
                            <div class="request-header">
                                <span class="request-id" title="${doc.id}">${shortId}...</span>
                                <span class="request-status failed">âŒ FAILED</span>
                            </div>
                            <div class="doc-titles">
                                <div class="doc-titles-label">ğŸ“„ ${title}</div>
                            </div>
                            <div style="background: #fffbeb; padding: 12px; border-radius: 6px; margin: 10px 0; border: 1px solid #fbbf24;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 5px;">
                                    âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                                </div>
                                <div style="color: #78350f; font-size: 0.9em; font-family: monospace; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">
                                    ${lastError}
                                </div>
                            </div>
                            <div class="request-info">
                                <div class="info-item">
                                    <div class="label">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</div>
                                    <div class="value">${doc.workspace || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä½œæˆã‚½ãƒ•ãƒˆ</div>
                                    <div class="value">${doc.origin_app || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">è©¦è¡Œå›æ•°</div>
                                    <div class="value" style="color: ${attemptCount > 2 ? '#ef4444' : '#6b7280'}; font-weight: ${attemptCount > 2 ? '600' : 'normal'};">${attemptCount}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä¿¡é ¼åº¦</div>
                                    <div class="value">${doc.origin_confidence || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</div>
                                    <div class="value">${doc.layout_profile || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">æ›´æ–°æ—¥æ™‚</div>
                                    <div class="value">${formatDate(doc.updated_at)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                listEl.innerHTML = statsBar + docsHtml;

            } catch (error) {
                console.error('å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('failed-list').innerHTML = `
                    <div class="empty-state">
                        <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    </div>
                `;
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ï¼ˆqueued â†’ pending ã«æˆ»ã™ï¼‰
        async function removeFromQueue(docId) {
            if (!confirm('ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆpending ã«æˆ»ã‚Šã¾ã™ï¼‰')) {
                return;
            }

            try {
                const response = await fetch(`/internal/queue/remove/${docId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('success', 'ğŸ—‘ ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸï¼ˆpending ã«æˆ»ã‚Šã¾ã—ãŸï¼‰');
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ å‰Šé™¤å¤±æ•—: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('error', `âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«
        function getStatusLabel(status) {
            const labels = {
                'queued': 'â³ å¾…æ©Ÿä¸­',
                'processing': 'ğŸ”„ å‡¦ç†ä¸­',
                'completed': 'âœ… å®Œäº†',
                'failed': 'âŒ å¤±æ•—',
                'applied': 'âœ… é©ç”¨æ¸ˆã¿',
                'rejected': 'âš ï¸ æ‹’å¦',
                'cancelled': 'ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
            };
            return labels[status] || status;
        }

        // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showMessage(type, message) {
            const messageBox = document.getElementById('status-message');
            messageBox.className = 'status-message ' + type;
            messageBox.textContent = message;
            setTimeout(() => {
                messageBox.className = 'status-message';
            }, 5000);
        }
    </script>
</body>
</html>
