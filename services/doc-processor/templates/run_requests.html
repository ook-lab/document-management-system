<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run Requests - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1em;
        }

        .nav-links {
            margin-top: 15px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
            padding: 5px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .main-content {
            padding: 30px;
        }

        .form-section {
            background: #f9fafb;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .requests-list {
            margin-top: 30px;
        }

        .request-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #2563eb;
        }

        .request-card.completed {
            border-left-color: #10b981;
        }

        .request-card.failed {
            border-left-color: #ef4444;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .request-id {
            font-family: monospace;
            background: #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .request-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .request-status.queued {
            background: #fef3c7;
            color: #92400e;
        }

        .request-status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .request-status.processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .request-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .request-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            font-size: 0.9em;
        }

        .info-item .label {
            color: #6b7280;
            margin-bottom: 4px;
        }

        .info-item .value {
            font-weight: 600;
            color: #1f2937;
        }

        .execution-history {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .execution-history h4 {
            color: #374151;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .execution-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .command-box {
            background: #1f2937;
            color: #d1d5db;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 15px;
            overflow-x: auto;
        }

        .command-box code {
            color: #10b981;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-execute {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-execute:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-execute:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-execute.processing {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .btn-retry {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-retry:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-delete {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-delete:hover:not(:disabled) {
            background: #ef4444;
            transform: translateY(-2px);
        }

        .doc-titles {
            margin-top: 10px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 0.85em;
            color: #4b5563;
        }

        .doc-titles-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .doc-titles-list {
            word-break: break-all;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            display: block;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #1e40af;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state p {
            margin-bottom: 10px;
        }

        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .dashboard-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-panel {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
        }

        .dashboard-panel h3 {
            color: #1f2937;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }

        .queue-item {
            text-align: center;
            padding: 12px 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .queue-item .count {
            font-size: 1.8em;
            font-weight: 700;
            line-height: 1;
        }

        .queue-item .label {
            font-size: 0.75em;
            color: #6b7280;
            margin-top: 4px;
        }

        .queue-item.pending .count { color: #f59e0b; }
        .queue-item.queued .count { color: #8b5cf6; }
        .queue-item.processing .count { color: #3b82f6; }
        .queue-item.completed .count { color: #10b981; }
        .queue-item.failed .count { color: #ef4444; }

        .worker-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .worker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 6px;
            border: 1px solid #e5e7eb;
        }

        .worker-item .worker-id {
            font-family: monospace;
            font-size: 0.8em;
            color: #374151;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .worker-item .worker-count {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .worker-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #eff6ff;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .worker-summary .total {
            font-size: 1.5em;
            font-weight: 700;
            color: #2563eb;
        }

        .worker-summary .label {
            font-size: 0.85em;
            color: #1e40af;
        }

        .dashboard-updated {
            font-size: 0.75em;
            color: #9ca3af;
            text-align: right;
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
        }

        .btn-refresh {
            background: #e5e7eb;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-refresh:hover {
            background: #d1d5db;
        }

        .no-workers {
            text-align: center;
            color: #9ca3af;
            padding: 20px;
            font-size: 0.9em;
        }

        .btn-reprocess {
            border: none;
            border-radius: 5px;
            padding: 4px 10px;
            font-size: 0.78em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-reprocess-g17 {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        .btn-reprocess-g17:hover:not(:disabled) {
            background: #fbbf24;
            color: #1c1917;
        }
        .btn-reprocess-g22 {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .btn-reprocess-g22:hover:not(:disabled) {
            background: #34d399;
            color: #022c22;
        }
        .btn-reprocess:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ Processing Queue</h1>
            <p>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ã‚­ãƒ¥ãƒ¼ã®ç®¡ç†</p>
            <div class="nav-links">
                <a href="/">Run Requests</a>
            </div>
        </div>

        <div class="main-content">
            <!-- æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ -->
            <div class="info-box">
                <p><strong>è¨­è¨ˆåŸå‰‡:</strong> pending â†’ queued â†’ processing â†’ completed/failed</p>
                <p><strong>ä½¿ã„æ–¹:</strong> ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã§ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã€‚Worker ãŒè‡ªå‹•çš„ã« queued ã‚’æ¶ˆåŒ–ã—ã¾ã™ã€‚</p>
            </div>

            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div class="dashboard-section" id="dashboard-section">
                <!-- Queue ãƒ‘ãƒãƒ« -->
                <div class="dashboard-panel">
                    <h3>ğŸ“Š Queue çŠ¶æ…‹</h3>
                    <div class="queue-grid" id="queue-grid">
                        <div class="queue-item pending">
                            <div class="count" id="q-pending">-</div>
                            <div class="label">Pending</div>
                        </div>
                        <div class="queue-item queued">
                            <div class="count" id="q-queued">-</div>
                            <div class="label">Queued</div>
                        </div>
                        <div class="queue-item processing">
                            <div class="count" id="q-processing">-</div>
                            <div class="label">Processing</div>
                        </div>
                        <div class="queue-item completed">
                            <div class="count" id="q-completed">-</div>
                            <div class="label">Completed</div>
                        </div>
                        <div class="queue-item failed">
                            <div class="count" id="q-failed">-</div>
                            <div class="label">Failed</div>
                        </div>
                    </div>
                    <div class="dashboard-updated">
                        <span id="dashboard-updated">æ›´æ–°ä¸­...</span>
                        <button class="btn-refresh" onclick="loadDashboard()">ğŸ”„</button>
                    </div>
                </div>

                <!-- Workers ãƒ‘ãƒãƒ« -->
                <div class="dashboard-panel">
                    <h3>ğŸ‘· Workers</h3>
                    <div class="worker-summary">
                        <div>
                            <div class="total" id="w-active">-</div>
                            <div class="label">ä¸¦åˆ—å‡¦ç†ä¸­</div>
                        </div>
                    </div>
                    <div class="worker-list" id="worker-list">
                        <div class="no-workers">ãƒ¯ãƒ¼ã‚«ãƒ¼æƒ…å ±ãªã—</div>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="status-message" id="status-message"></div>

            <!-- ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
            <h2 style="margin-bottom: 20px; color: #1f2937;">â• ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ </h2>
            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="max-items">è¿½åŠ ä»¶æ•°ï¼ˆpending â†’ queuedï¼‰</label>
                        <input type="number" id="max-items" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="workspace">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆçœç•¥å¯ï¼‰</label>
                        <select id="workspace">
                            <option value="">å…¨ä½“ï¼ˆæŒ‡å®šãªã—ï¼‰</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="doc-id">ç‰¹å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆçœç•¥å¯ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å¯ï¼‰</label>
                    <input type="text" id="doc-id" placeholder="UUID ã‚’å…¥åŠ›ï¼ˆçœç•¥æ™‚ã¯ pending ã‹ã‚‰è‡ªå‹•é¸æŠï¼‰">
                </div>
                <button class="btn btn-primary" onclick="enqueueDocuments()">
                    â• ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
                </button>
                <button class="btn" id="btn-execute" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-left: 10px;" onclick="executeQueue()">
                    â–¶ å®Ÿè¡Œ
                </button>
                <button class="btn btn-secondary" onclick="refreshQueue()">
                    ğŸ”„ ä¸€è¦§ã‚’æ›´æ–°
                </button>
                <button class="btn" style="background: #ef4444; color: white; margin-left: 10px;" onclick="clearQueue()">
                    ğŸ—‘ ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                </button>
                <button class="btn" style="background: #f59e0b; color: white; margin-left: 10px;" onclick="clearLock()">
                    ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤
                </button>
                <button class="btn" style="background: #8b5cf6; color: white; margin-left: 10px;" onclick="retryFailed()">
                    ğŸ”„ å¤±æ•—ã‚’å†å®Ÿè¡Œ
                </button>
            </div>

            <!-- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ -->
            <h2 style="margin-bottom: 20px; color: #1f2937; margin-top: 40px;">ğŸ” ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢</h2>
            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="search-workspace">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</label>
                        <select id="search-workspace">
                            <option value="">å…¨ä½“ï¼ˆæŒ‡å®šãªã—ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="search-classification">åˆ†é¡</label>
                        <select id="search-classification">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="search-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select id="search-status">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="pending">pending</option>
                            <option value="queued">queued</option>
                            <option value="processing">processing</option>
                            <option value="completed">completed</option>
                            <option value="failed">failed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label for="search-q">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ä¸€è‡´ï¼‰</label>
                    <input type="text" id="search-q" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="font-size: 0.9em; color: #4b5563; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="exclude-text-only"> ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼ˆæ·»ä»˜ãªã—ï¼‰ã‚’é™¤ã
                    </label>
                </div>
                <button class="btn btn-primary" onclick="searchDocuments()">ğŸ” æ¤œç´¢</button>
            </div>

            <!-- æ¤œç´¢å±¥æ­´ -->
            <div id="search-history-section" style="margin-top: 12px; display: none;">
                <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 6px;">æœ€è¿‘ã®æ¤œç´¢ï¼š</div>
                <div id="search-history-list"></div>
            </div>

            <!-- æ¤œç´¢çµæœ -->
            <div id="search-results-section" style="margin-top: 20px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span id="search-result-count" style="color: #6b7280; font-size: 0.9em;"></span>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" id="btn-classify" onclick="classifySelected()" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; font-size: 0.85em; padding: 6px 14px;">
                            ğŸ· åˆ†é¡ã‚’ç¢ºèª
                        </button>
                        <button class="btn" onclick="openDocTypeModal()" style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; font-size: 0.85em; padding: 6px 14px;">
                            ğŸ“‚ doc_typeå¤‰æ›´
                        </button>
                        <button class="btn" onclick="addSelectedToPending()" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; font-size: 0.85em; padding: 6px 14px;">
                            ğŸ”„ é¸æŠã—ãŸä»¶ã‚’pendingã«æˆ»ã™
                        </button>
                        <button class="btn btn-primary" onclick="addSelectedToQueue()" style="font-size: 0.85em; padding: 6px 14px;">
                            â• é¸æŠã—ãŸä»¶ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
                        </button>
                    </div>
                </div>
                <!-- åˆ†é¡çµæœã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="classify-results-area" style="display: none; margin-bottom: 12px; padding: 12px; background: #f5f3ff; border-radius: 8px; border: 1px solid #c4b5fd; font-size: 0.85em;">
                    <div id="classify-results-content"></div>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85em; color: #6b7280; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="select-all-results" onchange="toggleSelectAll(this)"> ã™ã¹ã¦é¸æŠï¼ˆä¸Šä½20ä»¶ã¾ã§ï¼‰
                    </label>
                </div>
                <div class="requests-list" id="search-results-list"></div>
            </div>

            <!-- ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
            <h2 style="margin-bottom: 20px; color: #1f2937; margin-top: 40px;">ğŸš« Gatekeeper ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå‡¦ç†å¯¾è±¡å¤–ï¼‰</h2>
            <div class="requests-list" id="blocked-list" style="margin-bottom: 40px;">
                <div class="empty-state">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- å‡¦ç†å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
            <h2 style="margin-bottom: 20px; color: #1f2937;">âŒ å‡¦ç†å¤±æ•—</h2>
            <div class="requests-list" id="failed-list" style="margin-bottom: 40px;">
                <div class="empty-state">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- ã‚­ãƒ¥ãƒ¼ä¸€è¦§ -->
            <h2 style="margin-bottom: 20px; color: #1f2937;">ğŸ“‹ ã‚­ãƒ¥ãƒ¼å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>
            <div class="requests-list" id="queue-list">
                <div class="empty-state">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
        const POLLING_INTERVAL = 5000;
        let pollingTimer = null;
        let hasProcessing = false;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('load', function() {
            loadWorkspaces();
            loadClassifications('');
            refreshQueue();
            loadBlockedDocuments();
            loadFailedDocuments();
            loadDashboard();
            startPolling();
            renderSearchHistory();
        });

        // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        function startPolling() {
            if (pollingTimer) return;
            pollingTimer = setInterval(() => {
                refreshQueue();
                loadBlockedDocuments();
                loadFailedDocuments();
                loadDashboard();
            }, POLLING_INTERVAL);
        }

        // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å¤‰æ›´æ™‚ã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚‚æ›´æ–°
        document.getElementById('workspace').addEventListener('change', function() {
            loadDashboard();
            refreshQueue();
            loadBlockedDocuments();
            loadFailedDocuments();
        });

        // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadWorkspaces() {
            try {
                const response = await fetch('/internal/workspaces');
                const data = await response.json();

                if (data.success && data.workspaces) {
                    // ã‚­ãƒ¥ãƒ¼è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
                    const select = document.getElementById('workspace');
                    // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
                    const searchSelect = document.getElementById('search-workspace');
                    data.workspaces.forEach(workspace => {
                        const opt1 = document.createElement('option');
                        opt1.value = workspace;
                        opt1.textContent = workspace;
                        select.appendChild(opt1);

                        const opt2 = document.createElement('option');
                        opt2.value = workspace;
                        opt2.textContent = workspace;
                        searchSelect.appendChild(opt2);
                    });
                }
            } catch (error) {
                console.error('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // åˆ†é¡ï¼ˆorigin_appï¼‰ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadClassifications(workspace) {
            try {
                const params = workspace ? `?workspace=${encodeURIComponent(workspace)}` : '';
                const response = await fetch(`/internal/classifications${params}`);
                const data = await response.json();

                const select = document.getElementById('search-classification');
                // ã€Œã™ã¹ã¦ã€ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
                while (select.options.length > 1) select.remove(1);

                if (data.success && data.classifications) {
                    data.classifications.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        select.appendChild(option);
                    });
                }

                // ç–‘ä¼¼åˆ†é¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆDB ã‚«ãƒ©ãƒ ã§ã¯ãªãæ¡ä»¶ã§çµã‚Šè¾¼ã‚€ï¼‰
                const pseudoStatuses = [
                    { value: 'text_only',      label: '[ãƒ†ã‚­ã‚¹ãƒˆã®ã¿] æ·»ä»˜ãªã—' },
                    { value: 'unclassified',   label: '[æœªåˆ†é¡] ãƒ•ã‚¡ã‚¤ãƒ«ã‚ã‚Šãƒ»åˆ†é¡ãªã—' },
                    { value: 'file_not_found', label: '[ãƒ•ã‚¡ã‚¤ãƒ«æœªç™ºè¦‹] Drive 404' },
                ];
                pseudoStatuses.forEach(ps => {
                    const opt = document.createElement('option');
                    opt.value = ps.value;
                    opt.textContent = ps.label;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('åˆ†é¡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ¤œç´¢ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å¤‰æ›´æ™‚ã«åˆ†é¡ã‚’æ›´æ–°
        document.getElementById('search-workspace').addEventListener('change', function() {
            loadClassifications(this.value);
        });

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
        async function loadDashboard() {
            try {
                const workspace = document.getElementById('workspace').value || '';
                const url = workspace
                    ? `/internal/dashboard?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/dashboard';

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    // Queue çŠ¶æ…‹ã‚’æ›´æ–°
                    document.getElementById('q-pending').textContent = data.queue.pending || 0;
                    document.getElementById('q-queued').textContent = data.queue.queued || 0;
                    document.getElementById('q-processing').textContent = data.queue.processing || 0;
                    document.getElementById('q-completed').textContent = data.queue.completed || 0;
                    document.getElementById('q-failed').textContent = data.queue.failed || 0;

                    // Workers çŠ¶æ…‹ã‚’æ›´æ–°
                    document.getElementById('w-active').textContent = data.workers.active_processing;

                    const workerList = document.getElementById('worker-list');
                    if (data.workers.by_worker && data.workers.by_worker.length > 0) {
                        workerList.innerHTML = data.workers.by_worker.map(w => `
                            <div class="worker-item">
                                <span class="worker-id" title="${w.worker_id}">${w.worker_id}</span>
                                <span class="worker-count">${w.count} ä»¶</span>
                            </div>
                        `).join('');
                    } else {
                        workerList.innerHTML = '<div class="no-workers">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¯ãƒ¼ã‚«ãƒ¼ãªã—</div>';
                    }

                    // æ›´æ–°æ™‚åˆ»
                    const now = new Date();
                    document.getElementById('dashboard-updated').textContent =
                        `æœ€çµ‚æ›´æ–°: ${now.toLocaleTimeString('ja-JP')} (${data.workspace})`;
                }
            } catch (error) {
                console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('dashboard-updated').textContent = 'æ›´æ–°ã‚¨ãƒ©ãƒ¼';
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        async function enqueueDocuments() {
            const limit = parseInt(document.getElementById('max-items')?.value) || 10;
            const workspace = document.getElementById('workspace').value || null;
            const docIdInput = document.getElementById('doc-id').value.trim();

            try {
                const body = { limit: limit };
                if (workspace) body.workspace = workspace;
                if (docIdInput) {
                    // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°IDã«å¯¾å¿œ
                    body.doc_ids = docIdInput.split(',').map(id => id.trim()).filter(id => id);
                }

                const response = await fetch('/internal/run-requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('success', `âœ… ${data.enqueued_count}ä»¶ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸ`);
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œï¼ˆWorker ã‚’èµ·å‹•ï¼‰
        let isExecuting = false;
        let executionMonitorTimer = null;

        async function executeQueue() {
            if (isExecuting) return;

            const btn = document.getElementById('btn-execute');
            const workspace = document.getElementById('workspace').value || 'all';
            const limit = parseInt(document.getElementById('max-items')?.value) || 10;

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            isExecuting = true;
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.innerHTML = 'â³ å®Ÿè¡Œä¸­...';

            try {
                showMessage('info', 'â³ Worker ã‚’èµ·å‹•ä¸­...');

                const response = await fetch('/internal/queue/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace: workspace,
                        limit: limit
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let msg = `âœ… ${data.message}`;
                    if (data.log_file) {
                        msg += `\nãƒ­ã‚°: ${data.log_file}`;
                    }
                    showMessage('success', msg);

                    // å‡¦ç†å®Œäº†ã‚’ç›£è¦–
                    startExecutionMonitor();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                    resetExecuteButton();
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                resetExecuteButton();
            }
        }

        function startExecutionMonitor() {
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (executionMonitorTimer) {
                clearInterval(executionMonitorTimer);
            }

            // 3ç§’ã”ã¨ã«ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’ç¢ºèª
            executionMonitorTimer = setInterval(async () => {
                try {
                    const response = await fetch('/internal/dashboard');
                    const data = await response.json();

                    if (data.success) {
                        const queue = data.queue;
                        const queued = queue.queued || 0;
                        const processing = queue.processing || 0;

                        // æ›´æ–°
                        refreshQueue();
                        loadDashboard();

                        // queued ã‚‚ processing ã‚‚ 0 ãªã‚‰å®Œäº†
                        if (queued === 0 && processing === 0) {
                            clearInterval(executionMonitorTimer);
                            executionMonitorTimer = null;
                            showMessage('success', 'âœ… å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
                            resetExecuteButton();
                        }
                    }
                } catch (error) {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç›£è¦–ã‚’åœæ­¢ã—ã¦ãƒœã‚¿ãƒ³ã‚’æˆ»ã™
                    clearInterval(executionMonitorTimer);
                    executionMonitorTimer = null;
                    resetExecuteButton();
                }
            }, 3000);
        }

        function resetExecuteButton() {
            const btn = document.getElementById('btn-execute');
            isExecuting = false;
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.innerHTML = 'â–¶ å®Ÿè¡Œ';
        }

        // å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å†ã‚­ãƒ¥ãƒ¼
        async function retryFailed() {
            if (!confirm('å¤±æ•—ï¼ˆfailedï¼‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\n\nå†ã‚­ãƒ¥ãƒ¼å¾Œã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã§å‡¦ç†ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚')) {
                return;
            }

            const workspace = document.getElementById('workspace').value || 'all';

            try {
                const response = await fetch('/internal/queue/retry-failed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace: workspace
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.retry_count > 0) {
                        showMessage('success', `ğŸ”„ ${data.message}`);
                    } else {
                        showMessage('info', 'â„¹ï¸ å†ã‚­ãƒ¥ãƒ¼å¯¾è±¡ã®å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒ­ãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢
        async function clearLock() {
            if (!confirm('å‡¦ç†ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã€æ³¨æ„ã€‘\n- Worker ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ãƒ­ãƒƒã‚¯ãŒæ®‹ã£ãŸå ´åˆã«ä½¿ç”¨\n- å®Ÿè¡Œä¸­ã® Worker ãŒã‚ã‚‹å ´åˆã¯é‡è¤‡å‡¦ç†ã®ãƒªã‚¹ã‚¯ã‚ã‚Š')) {
                return;
            }

            try {
                const response = await fetch('/internal/queue/clear-lock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (data.was_locked) {
                        showMessage('success', `ğŸ”“ ${data.message}\nï¼ˆä»¥å‰: ${data.previous_state.locked_by || 'ä¸æ˜'}ï¼‰`);
                    } else {
                        showMessage('info', `â„¹ï¸ ${data.message}`);
                    }
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆqueued â†’ pending ã«æˆ»ã™ï¼‰
        async function clearQueue() {
            if (!confirm('ã‚­ãƒ¥ãƒ¼å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã™ã¹ã¦ pending ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆprocessing ä¸­ã®ã‚‚ã®ã¯è‡ªç„¶å®Œäº†ã—ã¾ã™ï¼‰')) {
                return;
            }

            const workspace = document.getElementById('workspace').value || null;

            try {
                const url = workspace
                    ? `/internal/queue/clear?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/queue/clear';

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('success', `âœ… ${data.cleared_count}ä»¶ã‚’ pending ã«æˆ»ã—ã¾ã—ãŸ`);
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚­ãƒ¥ãƒ¼ä¸€è¦§ã‚’æ›´æ–°
        async function refreshQueue() {
            try {
                const workspace = document.getElementById('workspace').value || '';
                const url = workspace
                    ? `/internal/run-requests?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/run-requests';

                const response = await fetch(url);
                const data = await response.json();

                const listEl = document.getElementById('queue-list');

                if (!data.success) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                    return;
                }

                const queuedDocs = data.queued_docs || [];
                const status = data.status || {};

                if (queuedDocs.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>ğŸ“­ ã‚­ãƒ¥ãƒ¼ï¼ˆqueuedï¼‰ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <p>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã§ pending ã‹ã‚‰ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦ãã ã•ã„</p>
                            <p style="margin-top: 10px; font-size: 0.9em; color: #6b7280;">
                                pending: ${status.pending || 0} / processing: ${status.processing || 0} / completed: ${status.completed || 0}
                            </p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = queuedDocs.map(doc => {
                    const title = doc.title || doc.file_name || '(ç„¡é¡Œ)';

                    return `
                        <div class="request-card">
                            <div class="request-header">
                                <span class="request-id" title="${doc.id}">${doc.id}</span>
                                <span class="request-status queued">â³ queued</span>
                            </div>
                            <div class="doc-titles">
                                <div class="doc-titles-label">ğŸ“„ ${title}</div>
                            </div>
                            <div class="request-info">
                                <div class="info-item">
                                    <div class="label">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</div>
                                    <div class="value">${doc.workspace || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¨®åˆ¥</div>
                                    <div class="value">${doc.doc_type || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">è©¦è¡Œå›æ•°</div>
                                    <div class="value">${doc.attempt_count || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä½œæˆæ—¥æ™‚</div>
                                    <div class="value">${formatDate(doc.created_at)}</div>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn-delete" onclick="removeFromQueue('${doc.id}')" title="ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ï¼ˆpending ã«æˆ»ã™ï¼‰">
                                    ğŸ—‘ ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('ã‚­ãƒ¥ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('queue-list').innerHTML = `
                    <div class="empty-state">
                        <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    </div>
                `;
            }
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadBlockedDocuments() {
            try {
                const workspace = document.getElementById('workspace').value || '';
                const url = workspace
                    ? `/internal/blocked-documents?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/blocked-documents';

                const response = await fetch(url);
                const data = await response.json();

                const listEl = document.getElementById('blocked-list');

                if (!data.success) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                    return;
                }

                const blockedDocs = data.blocked_docs || [];
                const blockStats = data.block_stats || {};

                if (blockedDocs.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âœ… ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                            <p style="font-size: 0.9em; color: #6b7280;">ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒ Gatekeeper ã‚’é€šéã—ã¦ã„ã¾ã™</p>
                        </div>
                    `;
                    return;
                }

                // ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±åˆ¥ã®çµ±è¨ˆã‚’è¡¨ç¤º
                const statsHtml = Object.entries(blockStats)
                    .map(([code, count]) => `<span style="margin-right: 15px; color: #ef4444;">${code}: ${count}ä»¶</span>`)
                    .join('');

                const statsBar = `
                    <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 8px;">ğŸ“Š ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±åˆ¥é›†è¨ˆ</div>
                        <div style="font-size: 0.95em;">${statsHtml}</div>
                    </div>
                `;

                const docsHtml = blockedDocs.map(doc => {
                    const title = doc.title || doc.file_name || '(ç„¡é¡Œ)';
                    const blockCode = doc.gate_block_code || 'UNKNOWN';
                    const blockReason = doc.gate_block_reason || 'ç†ç”±ä¸æ˜';

                    return `
                        <div class="request-card" style="border-left: 4px solid #ef4444;">
                            <div class="request-header">
                                <span class="request-id" title="${doc.id}">${doc.id}</span>
                                <span class="request-status failed" style="background: #fef2f2; color: #991b1b;">ğŸš« BLOCK</span>
                            </div>
                            <div class="doc-titles">
                                <div class="doc-titles-label">ğŸ“„ ${title}</div>
                            </div>
                            <div style="background: #fef2f2; padding: 12px; border-radius: 6px; margin: 10px 0;">
                                <div style="font-weight: 600; color: #991b1b; margin-bottom: 5px;">
                                    âŒ ãƒ–ãƒ­ãƒƒã‚¯ç†ç”±: ${blockCode}
                                </div>
                                <div style="color: #7f1d1d; font-size: 0.9em;">
                                    ${blockReason}
                                </div>
                            </div>
                            <div class="request-info">
                                <div class="info-item">
                                    <div class="label">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</div>
                                    <div class="value">${doc.workspace || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä½œæˆã‚½ãƒ•ãƒˆ</div>
                                    <div class="value">${doc.origin_app || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä¿¡é ¼åº¦</div>
                                    <div class="value">${doc.origin_confidence || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</div>
                                    <div class="value">${doc.layout_profile || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ãƒãƒªã‚·ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                                    <div class="value">${doc.gate_policy_version || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">æ›´æ–°æ—¥æ™‚</div>
                                    <div class="value">${formatDate(doc.updated_at)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                listEl.innerHTML = statsBar + docsHtml;

            } catch (error) {
                console.error('ãƒ–ãƒ­ãƒƒã‚¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('blocked-list').innerHTML = `
                    <div class="empty-state">
                        <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    </div>
                `;
            }
        }

        // å‡¦ç†å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadFailedDocuments() {
            try {
                const workspace = document.getElementById('workspace').value || '';
                const url = workspace
                    ? `/internal/failed-documents?workspace=${encodeURIComponent(workspace)}`
                    : '/internal/failed-documents';

                const response = await fetch(url);
                const data = await response.json();

                const listEl = document.getElementById('failed-list');

                if (!data.success) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                    return;
                }

                const failedDocs = data.failed_docs || [];
                const errorStats = data.error_stats || {};

                if (failedDocs.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>âœ… å‡¦ç†å¤±æ•—ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                            <p style="font-size: 0.9em; color: #6b7280;">ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™</p>
                        </div>
                    `;
                    return;
                }

                // ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã®çµ±è¨ˆã‚’è¡¨ç¤ºï¼ˆä¸Šä½5ä»¶ã®ã¿ï¼‰
                const topErrors = Object.entries(errorStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const statsHtml = topErrors
                    .map(([error, count]) => {
                        const shortError = error.length > 40 ? error.substring(0, 40) + '...' : error;
                        return `<div style="margin-bottom: 5px;"><span style="color: #ef4444; font-weight: 600;">${count}ä»¶:</span> ${shortError}</div>`;
                    })
                    .join('');

                const statsBar = `
                    <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 8px;">ğŸ“Š ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥é›†è¨ˆï¼ˆä¸Šä½5ä»¶ï¼‰</div>
                        <div style="font-size: 0.9em;">${statsHtml}</div>
                    </div>
                `;

                const docsHtml = failedDocs.map(doc => {
                    const title = doc.title || doc.file_name || '(ç„¡é¡Œ)';
                    const attemptCount = doc.attempt_count || 0;

                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: å„ªå…ˆé †ä½ last_error_reason > error_message > metadata.last_error
                    let metadata = {};
                    try {
                        metadata = (typeof doc.metadata === 'string')
                            ? JSON.parse(doc.metadata)
                            : (doc.metadata || {});
                    } catch (e) { metadata = {}; }

                    const errorDetail = doc.last_error_reason
                        || doc.error_message
                        || metadata.last_error
                        || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';

                    // Gatekeeperæƒ…å ±
                    const gateCode   = doc.gate_block_code || '';
                    const gateReason = doc.gate_block_reason || '';
                    const creator    = doc.pdf_creator || '';
                    const producer   = doc.pdf_producer || '';

                    const gateHtml = (gateCode || creator) ? `
                        <div style="background: #fef3c7; padding: 8px 12px; border-radius: 4px; margin-top: 6px; font-size: 0.82em; font-family: monospace;">
                            ${gateCode    ? `<div><b>Gate:</b> ${gateCode}</div>` : ''}
                            ${gateReason  ? `<div><b>ç†ç”±:</b> ${gateReason}</div>` : ''}
                            ${creator     ? `<div><b>Creator:</b> ${creator}</div>` : ''}
                            ${producer    ? `<div><b>Producer:</b> ${producer}</div>` : ''}
                        </div>` : '';

                    return `
                        <div class="request-card" style="border-left: 4px solid #f59e0b;">
                            <div class="request-header">
                                <span class="request-id" title="${doc.id}">${doc.id}</span>
                                <span class="request-status failed">âŒ FAILED</span>
                            </div>
                            <div class="doc-titles">
                                <div class="doc-titles-label">ğŸ“„ ${title}</div>
                            </div>
                            <div style="background: #fffbeb; padding: 12px; border-radius: 6px; margin: 10px 0; border: 1px solid #fbbf24;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 5px;">
                                    âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                                </div>
                                <div style="color: #78350f; font-size: 0.9em; font-family: monospace; white-space: pre-wrap; max-height: 150px; overflow-y: auto;">
                                    ${errorDetail}
                                </div>
                                ${gateHtml}
                            </div>
                            <div class="request-info">
                                <div class="info-item">
                                    <div class="label">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</div>
                                    <div class="value">${doc.workspace || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä½œæˆã‚½ãƒ•ãƒˆ</div>
                                    <div class="value">${doc.origin_app || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">è©¦è¡Œå›æ•°</div>
                                    <div class="value" style="color: ${attemptCount > 2 ? '#ef4444' : '#6b7280'}; font-weight: ${attemptCount > 2 ? '600' : 'normal'};">${attemptCount}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ä¿¡é ¼åº¦</div>
                                    <div class="value">${doc.origin_confidence || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</div>
                                    <div class="value">${doc.layout_profile || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">æ›´æ–°æ—¥æ™‚</div>
                                    <div class="value">${formatDate(doc.updated_at)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                listEl.innerHTML = statsBar + docsHtml;

            } catch (error) {
                console.error('å¤±æ•—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('failed-list').innerHTML = `
                    <div class="empty-state">
                        <p>âŒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    </div>
                `;
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ï¼ˆqueued â†’ pending ã«æˆ»ã™ï¼‰
        async function removeFromQueue(docId) {
            if (!confirm('ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆpending ã«æˆ»ã‚Šã¾ã™ï¼‰')) {
                return;
            }

            try {
                const response = await fetch(`/internal/queue/remove/${docId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('success', 'ğŸ—‘ ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸï¼ˆpending ã«æˆ»ã‚Šã¾ã—ãŸï¼‰');
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ å‰Šé™¤å¤±æ•—: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('error', `âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«
        function getStatusLabel(status) {
            const labels = {
                'queued': 'â³ å¾…æ©Ÿä¸­',
                'processing': 'ğŸ”„ å‡¦ç†ä¸­',
                'completed': 'âœ… å®Œäº†',
                'failed': 'âŒ å¤±æ•—',
                'applied': 'âœ… é©ç”¨æ¸ˆã¿',
                'rejected': 'âš ï¸ æ‹’å¦',
                'cancelled': 'ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
            };
            return labels[status] || status;
        }

        // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===== ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ =====

        // æ¤œç´¢å®Ÿè¡Œ
        async function searchDocuments() {
            const workspace = document.getElementById('search-workspace').value;
            const classification = document.getElementById('search-classification').value;
            const status = document.getElementById('search-status').value;
            const q = document.getElementById('search-q').value.trim();
            const excludeTextOnly = document.getElementById('exclude-text-only').checked;

            const params = new URLSearchParams();
            if (workspace) params.set('workspace', workspace);
            if (classification) params.set('classification', classification);
            if (status) params.set('status', status);
            if (q) params.set('q', q);
            if (excludeTextOnly) params.set('exclude_text_only', 'true');
            params.set('limit', '100');

            try {
                const response = await fetch(`/internal/search?${params}`);
                const data = await response.json();

                if (data.success) {
                    saveSearchHistory({ workspace, classification, status, q });
                    renderSearchResults(data.documents, data.count);
                } else {
                    showMessage('error', `âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // æ¤œç´¢çµæœã‚’è¡¨ç¤º
        function renderSearchResults(docs, count) {
            const section = document.getElementById('search-results-section');
            const list = document.getElementById('search-results-list');
            const countEl = document.getElementById('search-result-count');
            const selectAll = document.getElementById('select-all-results');

            section.style.display = 'block';
            countEl.textContent = `${count} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
            selectAll.checked = false;

            if (!docs.length) {
                list.innerHTML = '<div class="empty-state"><p>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
                return;
            }

            const statusColors = {
                pending: '#6b7280',
                queued: '#2563eb',
                processing: '#f59e0b',
                completed: '#10b981',
                failed: '#ef4444'
            };

            list.innerHTML = docs.map(doc => {
                const color = statusColors[doc.processing_status] || '#6b7280';
                const label = doc.title || doc.file_name || doc.id;
                const safeId = doc.id.replace(/"/g, '&quot;');
                const safeName = escHtml(label).replace(/'/g, '&#39;');
                return `
                <div class="request-card" style="border-left: 4px solid ${color}; cursor: default;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <input type="checkbox" class="search-result-checkbox" value="${doc.id}" style="margin-top: 4px; flex-shrink: 0;">
                        <div style="flex: 1; min-width: 0;">
                            <div data-doc-name style="font-weight: 600; color: #1f2937; word-break: break-all;">${escHtml(label)}</div>
                            <div style="font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                                ${doc.workspace ? `<span style="margin-right: 8px;">ğŸ“ ${escHtml(doc.workspace)}</span>` : ''}
                                ${doc.doc_type ? `<span style="margin-right: 8px;">ğŸ“‚ ${escHtml(doc.doc_type)}</span>` : ''}
                                ${doc.origin_app ? `<span style="margin-right: 8px;">ğŸ· ${escHtml(doc.origin_app)}</span>` : ''}
                                <span>çŠ¶æ…‹: ${escHtml(doc.processing_status)}</span>
                            </div>
                            <div style="margin-top: 8px; display: flex; gap: 6px; align-items: center;">
                                <button class="btn-reprocess btn-reprocess-g17"
                                    id="btn-g17-${safeId}"
                                    onclick="reprocessG('${safeId}', 'G17', '${safeName}')"
                                    title="G14ã®è¡¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰G17(è¡¨AI)ã‚’å†å®Ÿè¡Œã—ã¦J/Kã‚’æ›´æ–°">
                                    ğŸ” G17ã‹ã‚‰
                                </button>
                                <button class="btn-reprocess btn-reprocess-g22"
                                    id="btn-g22-${safeId}"
                                    onclick="reprocessG('${safeId}', 'G22', '${safeName}')"
                                    title="G21ã®åœ°ã®æ–‡ã‹ã‚‰G22(ãƒ†ã‚­ã‚¹ãƒˆAI)ã‚’å†å®Ÿè¡Œã—ã¦J/Kã‚’æ›´æ–°">
                                    ğŸ” G22ã‹ã‚‰
                                </button>
                                <span id="reprocess-status-${safeId}" style="font-size: 0.78em; color: #6b7280;"></span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function escHtml(s) {
            return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ã™ã¹ã¦é¸æŠ / è§£é™¤ï¼ˆé¸æŠã¯ä¸Šä½20ä»¶ã¾ã§ï¼‰
        function toggleSelectAll(checkbox) {
            const allCbs = document.querySelectorAll('.search-result-checkbox');
            if (checkbox.checked) {
                allCbs.forEach((cb, i) => { cb.checked = i < 20; });
            } else {
                allCbs.forEach(cb => { cb.checked = false; });
            }
        }

        // é¸æŠã—ãŸä»¶ã‚’1ä»¶ãšã¤åˆ†é¡ã—ã¦ origin_app ã‚’æ›¸ãè¾¼ã‚€
        async function classifySelected() {
            console.log('[classify] ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');

            const checkboxes = Array.from(document.querySelectorAll('.search-result-checkbox:checked'));
            console.log('[classify] é¸æŠæ•°:', checkboxes.length);

            if (!checkboxes.length) {
                alert('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼‰');
                return;
            }
            if (checkboxes.length > 20) {
                alert('ä¸€åº¦ã«å‡¦ç†ã§ãã‚‹ã®ã¯20ä»¶ã¾ã§ã§ã™');
                return;
            }

            const total = checkboxes.length;
            const btn = document.getElementById('btn-classify');
            const area = document.getElementById('classify-results-area');
            const content = document.getElementById('classify-results-content');

            // ãƒœã‚¿ãƒ³ã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            area.style.display = 'block';

            let doneCount = 0;
            let errorCount = 0;

            // åˆæœŸè¡¨ç¤ºï¼šå…¨ä»¶ã‚’ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¡Œã¨ã—ã¦ä¸¦ã¹ã‚‹
            const initialRows = checkboxes.map(cb => {
                const docId = cb.value;
                const card = cb.closest('.request-card');
                const nameEl = card ? card.querySelector('[data-doc-name]') : null;
                const label = nameEl ? nameEl.textContent : docId;
                return `<div id="classify-row-${docId}" style="margin:3px 0; display:flex; align-items:center; gap:8px;">
                    <span class="classify-spinner">â³</span>
                    <span style="color:#6b7280; font-size:0.9em; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escHtml(label)}</span>
                    <span class="classify-status" style="color:#a78bfa; font-size:0.85em; flex-shrink:0;">å¾…æ©Ÿä¸­</span>
                </div>`;
            }).join('');

            content.innerHTML = `<div id="classify-header" style="margin-bottom:8px; font-weight:600; color:#5b21b6;">ğŸ· åˆ†é¡ä¸­ 0/${total}</div>` + initialRows;

            try {
                // 1ä»¶ãšã¤å‡¦ç†
                for (const cb of checkboxes) {
                    const docId = cb.value;
                    const rowEl = document.getElementById('classify-row-' + docId);

                    rowEl.querySelector('.classify-spinner').textContent = 'ğŸ”„';
                    rowEl.querySelector('.classify-status').textContent = 'åˆ†é¡ä¸­...';
                    rowEl.querySelector('.classify-status').style.color = '#f59e0b';
                    btn.textContent = 'â³ ' + (doneCount + 1) + '/' + total + ' åˆ†é¡ä¸­';

                    try {
                        const resp = await fetch('/internal/classify-documents', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ doc_ids: [docId] })
                        });
                        const data = await resp.json();
                        const r = data.results && data.results[0];

                        if (r && r.success) {
                            rowEl.querySelector('.classify-spinner').textContent = 'âœ…';
                            rowEl.querySelector('.classify-status').style.color = '#7c3aed';
                            rowEl.querySelector('.classify-status').textContent =
                                (r.origin_app || '?') + ' (' + (r.confidence || '?') + ')';
                        } else {
                            errorCount++;
                            rowEl.querySelector('.classify-spinner').textContent = 'âŒ';
                            rowEl.querySelector('.classify-status').style.color = '#ef4444';
                            rowEl.querySelector('.classify-status').textContent =
                                (r && r.error) || data.error || 'å¤±æ•—';
                        }
                    } catch (fetchErr) {
                        errorCount++;
                        rowEl.querySelector('.classify-spinner').textContent = 'âŒ';
                        rowEl.querySelector('.classify-status').style.color = '#ef4444';
                        rowEl.querySelector('.classify-status').textContent = fetchErr.message;
                        console.error('[classify] fetch ã‚¨ãƒ©ãƒ¼:', fetchErr);
                    }

                    // ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
                    cb.checked = false;
                    doneCount++;

                    const pct = Math.round((doneCount / total) * 100);
                    document.getElementById('classify-header').innerHTML =
                        '<span style="font-weight:600; color:#5b21b6;">ğŸ· åˆ†é¡ä¸­ ' + doneCount + '/' + total + '</span>' +
                        '<span style="margin-left:8px; color:#6b7280; font-size:0.85em;">' + pct + '%</span>' +
                        '<div style="margin-top:5px; height:5px; background:#e5e7eb; border-radius:3px;">' +
                        '<div style="height:5px; width:' + pct + '%; background:linear-gradient(90deg,#7c3aed,#5b21b6); border-radius:3px; transition:width 0.3s;"></div></div>';
                }

                // å®Œäº†
                const successCount = doneCount - errorCount;
                document.getElementById('classify-header').innerHTML =
                    '<span style="font-weight:600; color:#059669;">âœ… åˆ†é¡å®Œäº† ' + successCount + '/' + total + ' ä»¶' +
                    (errorCount > 0 ? ' (' + errorCount + ' ä»¶å¤±æ•—)' : '') + '</span>' +
                    '<div style="margin-top:5px; height:5px; background:#e5e7eb; border-radius:3px;">' +
                    '<div style="height:5px; width:100%; background:linear-gradient(90deg,#7c3aed,#5b21b6); border-radius:3px;"></div></div>';

                showMessage('success', 'âœ… åˆ†é¡å®Œäº†: ' + successCount + '/' + total + ' ä»¶');
                document.getElementById('select-all-results').checked = false;
                searchDocuments();

            } catch (outerErr) {
                console.error('[classify] äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:', outerErr);
                showMessage('error', 'âŒ äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: ' + outerErr.message);
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.textContent = 'ğŸ· åˆ†é¡ã‚’ç¢ºèª';
            }
        }

        // é¸æŠã—ãŸä»¶ã‚’pendingã«ãƒªã‚»ãƒƒãƒˆ
        async function addSelectedToPending() {
            const checkboxes = document.querySelectorAll('.search-result-checkbox:checked');
            const docIds = Array.from(checkboxes).map(cb => cb.value);

            if (!docIds.length) {
                showMessage('error', 'âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch('/internal/set-pending', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_ids: docIds })
                });
                const data = await response.json();
                if (data.success) {
                    showMessage('success', `âœ… ${data.updated_count}ä»¶ã‚’pendingã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`);
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // é¸æŠã—ãŸä»¶ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        async function addSelectedToQueue() {
            const checkboxes = document.querySelectorAll('.search-result-checkbox:checked');
            const docIds = Array.from(checkboxes).map(cb => cb.value);

            if (!docIds.length) {
                showMessage('error', 'âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const workspace = document.getElementById('search-workspace').value || 'all';

            try {
                const response = await fetch('/internal/run-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_ids: docIds, workspace })
                });
                const data = await response.json();
                if (data.success) {
                    showMessage('success', `âœ… ${data.enqueued_count}ä»¶ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸ`);
                    refreshQueue();
                    loadDashboard();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ===== æ¤œç´¢å±¥æ­´ï¼ˆlocalStorageï¼‰ =====

        const SEARCH_HISTORY_KEY = 'doc_search_history';
        const MAX_HISTORY = 10;

        function saveSearchHistory(params) {
            const history = getSearchHistory();
            const key = JSON.stringify(params);
            const filtered = history.filter(h => JSON.stringify(h) !== key);
            filtered.unshift(params);
            localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(filtered.slice(0, MAX_HISTORY)));
            renderSearchHistory();
        }

        function getSearchHistory() {
            try {
                return JSON.parse(localStorage.getItem(SEARCH_HISTORY_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function renderSearchHistory() {
            const history = getSearchHistory();
            const section = document.getElementById('search-history-section');
            const list = document.getElementById('search-history-list');

            if (!history.length) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = history.map((h, i) => {
                const parts = [];
                if (h.workspace) parts.push(h.workspace);
                if (h.classification) parts.push(`åˆ†é¡:${h.classification}`);
                if (h.status) parts.push(`çŠ¶æ…‹:${h.status}`);
                if (h.q) parts.push(`"${h.q}"`);
                const label = parts.join(' / ') || 'å…¨ä»¶';
                return `<button class="btn btn-secondary" style="margin: 2px 4px; font-size: 0.8em; padding: 4px 10px;"
                    onclick="applySearchHistory(${i})">${escHtml(label)}</button>`;
            }).join('');
        }

        function applySearchHistory(index) {
            const h = getSearchHistory()[index];
            if (!h) return;
            document.getElementById('search-workspace').value = h.workspace || '';
            document.getElementById('search-classification').value = h.classification || '';
            document.getElementById('search-status').value = h.status || '';
            document.getElementById('search-q').value = h.q || '';
            searchDocuments();
        }

        // G17 / G22 å†å‡¦ç†
        async function reprocessG(docId, stage, docName) {
            const btnG17 = document.getElementById('btn-g17-' + docId);
            const btnG22 = document.getElementById('btn-g22-' + docId);
            const statusEl = document.getElementById('reprocess-status-' + docId);

            if (!confirm(`ã€Œ${docName}ã€ã‚’ ${stage} ã‹ã‚‰å†å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»G17: è¡¨AIã‚’å†å®Ÿè¡Œï¼ˆè¡¨ã®è§£æçµæœã‚’æ›´æ–°ï¼‰\nãƒ»G22: ãƒ†ã‚­ã‚¹ãƒˆAIã‚’å†å®Ÿè¡Œï¼ˆã‚¿ã‚¹ã‚¯ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»æ³¨æ„äº‹é …ã‚’æ›´æ–°ï¼‰\n\nã„ãšã‚Œã‚‚æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆJ/Kï¼‰ã‚‚æ›´æ–°ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            if (btnG17) { btnG17.disabled = true; }
            if (btnG22) { btnG22.disabled = true; }
            if (statusEl) { statusEl.textContent = `â³ ${stage} å‡¦ç†ä¸­...`; statusEl.style.color = '#f59e0b'; }

            try {
                const response = await fetch('/internal/reprocess-g', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_id: docId, start_stage: stage })
                });
                const data = await response.json();

                if (data.success) {
                    if (statusEl) {
                        statusEl.textContent = `âœ… å®Œäº† (${data.chunks_saved ?? '?'} chunks)`;
                        statusEl.style.color = '#10b981';
                    }
                    showMessage('success', `âœ… ${stage} å†å‡¦ç†å®Œäº†: ${docName} (${data.chunks_saved ?? '?'} chunks)`);
                } else {
                    if (statusEl) { statusEl.textContent = `âŒ ${data.error}`; statusEl.style.color = '#ef4444'; }
                    showMessage('error', `âŒ ${stage} å†å‡¦ç†å¤±æ•—: ${data.error}`);
                }
            } catch (err) {
                if (statusEl) { statusEl.textContent = `âŒ ${err.message}`; statusEl.style.color = '#ef4444'; }
                showMessage('error', `âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            } finally {
                if (btnG17) { btnG17.disabled = false; }
                if (btnG22) { btnG22.disabled = false; }
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showMessage(type, message) {
            const messageBox = document.getElementById('status-message');
            messageBox.className = 'status-message ' + type;
            messageBox.textContent = message;
            setTimeout(() => {
                messageBox.className = 'status-message';
            }, 5000);
        }
        // ===== doc_type ä¸€æ‹¬å¤‰æ›´ =====

        function openDocTypeModal() {
            const checkboxes = document.querySelectorAll('.search-result-checkbox:checked');
            if (!checkboxes.length) {
                showMessage('error', 'âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            document.getElementById('doc-type-modal-count').textContent = checkboxes.length + 'ä»¶';
            document.getElementById('doc-type-input').value = '';
            document.getElementById('doc-type-modal').style.display = 'flex';
            document.getElementById('doc-type-input').focus();
        }

        function closeDocTypeModal() {
            document.getElementById('doc-type-modal').style.display = 'none';
        }

        async function applyDocTypeChange() {
            const docType = document.getElementById('doc-type-input').value.trim();
            if (!docType) {
                showMessage('error', 'âŒ doc_type ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            const checkboxes = document.querySelectorAll('.search-result-checkbox:checked');
            const docIds = Array.from(checkboxes).map(cb => cb.value);

            const btn = document.getElementById('btn-apply-doc-type');
            btn.disabled = true;
            btn.textContent = 'å¤‰æ›´ä¸­...';

            try {
                const response = await fetch('/internal/update-doc-type', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_ids: docIds, doc_type: docType })
                });
                const data = await response.json();
                closeDocTypeModal();
                if (data.success) {
                    showMessage('success', `âœ… ${data.updated_count}ä»¶ã® doc_type ã‚’ã€Œ${docType}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
                    searchDocuments();
                } else {
                    showMessage('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'å¤‰æ›´ã™ã‚‹';
            }
        }

        // Escã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeDocTypeModal();
        });
    </script>

    <!-- doc_typeå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="doc-type-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:12px; padding:28px; min-width:360px; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin:0 0 16px; font-size:1.1em; color:#1f2937;">ğŸ“‚ doc_type ä¸€æ‹¬å¤‰æ›´</h3>
            <p style="margin:0 0 16px; color:#6b7280; font-size:0.9em;"><span id="doc-type-modal-count"></span>ã® doc_type ã‚’å¤‰æ›´ã—ã¾ã™</p>
            <input id="doc-type-input" type="text" placeholder="æ–°ã—ã„ doc_type ã‚’å…¥åŠ›"
                style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:0.95em; box-sizing:border-box; margin-bottom:16px;"
                onkeydown="if(event.key==='Enter') applyDocTypeChange()">
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn" onclick="closeDocTypeModal()" style="background:#f3f4f6; color:#374151;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="btn-apply-doc-type" class="btn" onclick="applyDocTypeChange()" style="background:linear-gradient(135deg,#d97706,#b45309); color:white;">å¤‰æ›´ã™ã‚‹</button>
            </div>
        </div>
    </div>
</body>
</html>
