{% extends 'base.html' %}

{% block title %}ãƒ¡ãƒ¼ãƒ«å—ä¿¡ãƒˆãƒ¬ã‚¤ - Document Review{% endblock %}

{% block content %}
<div class="layout-sidebar">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar">
        <div class="sidebar-section">
            <h3 class="sidebar-title">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿</h3>
            <div class="form-group">
                <label for="doctype-filter">ãƒ¡ãƒ¼ãƒ«ç¨®åˆ¥</label>
                <select id="doctype-filter">
                    <option value="">å…¨ã¦</option>
                    <option value="DM-mail">DM-mail</option>
                    <option value="JOB-mail">JOB-mail</option>
                </select>
            </div>
            <button id="filter-btn" class="btn btn-primary" style="width:100%;">æ¤œç´¢</button>
        </div>

        <button id="refresh-btn" class="btn btn-secondary" style="width:100%;">ğŸ”„ ãƒªã‚¹ãƒˆã‚’æ›´æ–°</button>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-area">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ğŸ“¬ ãƒ¡ãƒ¼ãƒ«å—ä¿¡ãƒˆãƒ¬ã‚¤</h2>
                <span id="email-count"></span>
            </div>

            <!-- ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="bulk-actions">
                <button id="bulk-approve-btn" class="btn btn-success" disabled>âœ… ã¾ã¨ã‚ã¦æ‰¿èª</button>
                <button id="bulk-delete-btn" class="btn btn-danger" disabled>ğŸ—‘ï¸ ã¾ã¨ã‚ã¦å‰Šé™¤</button>
            </div>

            <!-- ãƒ¡ãƒ¼ãƒ«ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div id="email-list-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ãƒ¼ãƒ«è©³ç´° -->
        <div id="email-detail-container" style="display: none;">
            <div class="layout-split">
                <!-- HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“„ ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    </div>
                    <div id="preview-container" class="preview-container">
                        <div class="empty-state">
                            <p>ãƒ¡ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>
                </div>

                <!-- è©³ç´°ãƒ»ç·¨é›† -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">âœï¸ ãƒ¡ãƒ¼ãƒ«æƒ…å ±</h3>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div id="email-info" style="margin-bottom:20px;">
                    </div>

                    <!-- ã‚¿ãƒ– -->
                    <div class="tabs">
                        <button class="tab active" data-tab="tab-metadata">ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</button>
                        <button class="tab" data-tab="tab-json">ğŸ” JSON</button>
                    </div>

                    <!-- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¿ãƒ– -->
                    <div id="tab-metadata" class="tab-content active">
                        <div id="metadata-editor-container">
                            <p>ãƒ¡ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>

                    <!-- JSONã‚¿ãƒ– -->
                    <div id="tab-json" class="tab-content">
                        <div class="form-group">
                            <label>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ (JSON)</label>
                            <textarea id="json-editor" class="json-editor" rows="15"></textarea>
                        </div>
                        <div id="json-error" class="error-message" style="display:none;"></div>
                    </div>

                    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                    <div class="action-buttons">
                        <button id="save-btn" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                        <button id="review-btn" class="btn btn-success">âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†</button>
                        <button id="unreview-btn" class="btn btn-secondary" style="display:none;">â†©ï¸ æœªå®Œäº†ã«æˆ»ã™</button>
                        <button id="delete-btn" class="btn btn-danger">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/**
 * Email Inbox - ãƒ¡ãƒ¼ãƒ«å—ä¿¡ãƒˆãƒ¬ã‚¤ç”¨JavaScript
 */

const EmailState = {
    emails: [],
    currentEmail: null,
    currentMetadata: null,
    isReviewed: false,
};

// =============================================================================
// ãƒ¡ãƒ¼ãƒ«ä¸€è¦§
// =============================================================================

async function loadEmails() {
    App.showLoading('email-list-container');

    try {
        const docType = document.getElementById('doctype-filter')?.value || '';

        const params = new URLSearchParams({
            doc_type: docType,
            limit: 50,
        });

        const data = await App.api(`/api/emails?${params}`);
        EmailState.emails = data.emails;

        renderEmailList();
        updateEmailCount(data.count);

        const emailIdFromUrl = App.getUrlParam('email_id');
        if (emailIdFromUrl) {
            selectEmail(emailIdFromUrl);
        }

    } catch (error) {
        console.error('Failed to load emails:', error);
        document.getElementById('email-list-container').innerHTML =
            `<div class="error-message">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
    }
}

function renderEmailList() {
    const container = document.getElementById('email-list-container');

    if (EmailState.emails.length === 0) {
        App.showEmpty('email-list-container', 'ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }

    const html = `
        <table class="data-table" id="email-table">
            <thead>
                <tr>
                    <th class="checkbox-cell">
                        <input type="checkbox" onchange="App.toggleSelectAll(this, 'email-table')">
                    </th>
                    <th>å·®å‡ºäºº</th>
                    <th>ä»¶å</th>
                    <th>æ—¥æ™‚</th>
                    <th>ç¨®åˆ¥</th>
                    <th>çŠ¶æ…‹</th>
                </tr>
            </thead>
            <tbody>
                ${EmailState.emails.map(email => `
                    <tr data-id="${email.id}" onclick="selectEmail('${email.id}')" class="${EmailState.currentEmail?.id === email.id ? 'selected' : ''}">
                        <td class="checkbox-cell" onclick="event.stopPropagation();">
                            <input type="checkbox"
                                   data-id="${email.id}"
                                   onchange="App.toggleSelect(this)"
                                   ${App.state.selectedIds.has(email.id) ? 'checked' : ''}>
                        </td>
                        <td>${escapeHtml(email.display_sender || email.display_sender_email || '')}</td>
                        <td>${escapeHtml(email.display_subject || '(ä»¶åãªã—)')}</td>
                        <td>${(email.display_sent_at || email.created_at || '').substring(0, 16)}</td>
                        <td>${email.doc_type || ''}</td>
                        <td>
                            ${email.is_reviewed
                                ? '<span class="badge badge-success">ç¢ºèªæ¸ˆ</span>'
                                : '<span class="badge badge-warning">æœªç¢ºèª</span>'}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    container.innerHTML = html;
}

function updateEmailCount(count) {
    const el = document.getElementById('email-count');
    if (el) {
        el.textContent = `${count}ä»¶`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

// =============================================================================
// ãƒ¡ãƒ¼ãƒ«é¸æŠãƒ»è©³ç´°
// =============================================================================

async function selectEmail(emailId) {
    App.setUrlParam('email_id', emailId);

    document.querySelectorAll('#email-table tbody tr').forEach(tr => {
        tr.classList.remove('selected');
        if (tr.dataset.id === emailId) {
            tr.classList.add('selected');
        }
    });

    document.getElementById('email-detail-container').style.display = 'block';

    try {
        const email = await App.api(`/api/emails/${emailId}`);
        EmailState.currentEmail = email;
        EmailState.currentMetadata = email.metadata || {};
        EmailState.isReviewed = email.is_reviewed || false;

        renderEmailDetail(email);
        loadHtmlPreview(email);

    } catch (error) {
        console.error('Failed to load email:', error);
        App.toast('ãƒ¡ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

function renderEmailDetail(email) {
    // åŸºæœ¬æƒ…å ±
    document.getElementById('email-info').innerHTML = `
        <div style="margin-bottom:10px;">
            <strong>å·®å‡ºäºº:</strong> ${escapeHtml(email.display_sender || '')}
            &lt;${escapeHtml(email.display_sender_email || '')}&gt;
        </div>
        <div style="margin-bottom:10px;">
            <strong>ä»¶å:</strong> ${escapeHtml(email.display_subject || '')}
        </div>
        <div style="margin-bottom:10px;">
            <strong>æ—¥æ™‚:</strong> ${email.display_sent_at || ''}
        </div>
        <div>
            <strong>ç¨®åˆ¥:</strong> ${email.doc_type || ''}
        </div>
    `;

    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç·¨é›†
    renderMetadataEditor(email.metadata || {});

    // JSONç·¨é›†
    document.getElementById('json-editor').value = JSON.stringify(email.metadata || {}, null, 2);

    // ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã«ã‚ˆã‚‹ãƒœã‚¿ãƒ³è¡¨ç¤º
    const reviewBtn = document.getElementById('review-btn');
    const unreviewBtn = document.getElementById('unreview-btn');

    if (EmailState.isReviewed) {
        reviewBtn.style.display = 'none';
        unreviewBtn.style.display = 'inline-block';
    } else {
        reviewBtn.style.display = 'inline-block';
        unreviewBtn.style.display = 'none';
    }
}

function renderMetadataEditor(metadata) {
    const container = document.getElementById('metadata-editor-container');

    if (!metadata || Object.keys(metadata).length === 0) {
        container.innerHTML = '<p>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    const fields = Object.entries(metadata)
        .filter(([key]) => !key.endsWith('_list') && !key.endsWith('_blocks'))
        .map(([key, value]) => {
            const isComplex = typeof value === 'object' && value !== null;

            if (isComplex) {
                return `
                    <div class="form-group">
                        <label>${formatFieldName(key)}</label>
                        <textarea class="json-editor"
                                  data-field="${key}"
                                  rows="3">${JSON.stringify(value, null, 2)}</textarea>
                    </div>
                `;
            }

            return `
                <div class="form-group">
                    <label>${formatFieldName(key)}</label>
                    <input type="text"
                           data-field="${key}"
                           value="${escapeHtml(String(value || ''))}">
                </div>
            `;
        });

    container.innerHTML = fields.join('') || '<p>ç·¨é›†å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>';
}

function formatFieldName(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

// =============================================================================
// HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
// =============================================================================

function loadHtmlPreview(email) {
    const container = document.getElementById('preview-container');

    // sandboxed iframe ã§HTMLã‚’è¡¨ç¤º
    container.innerHTML = `
        <iframe src="/api/emails/${email.id}/html"
                sandbox="allow-same-origin"
                style="width:100%;height:100%;border:none;background:#fff;">
        </iframe>
    `;
}

// =============================================================================
// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
// =============================================================================

async function saveEmail() {
    if (!EmailState.currentEmail) {
        App.toast('ãƒ¡ãƒ¼ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
    }

    const jsonEditor = document.getElementById('json-editor');
    let metadata;

    try {
        metadata = JSON.parse(jsonEditor.value);
    } catch (e) {
        document.getElementById('json-error').textContent = 'JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
        document.getElementById('json-error').style.display = 'block';
        App.toast('JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
    }

    document.getElementById('json-error').style.display = 'none';

    try {
        await App.api(`/api/emails/${EmailState.currentEmail.id}`, {
            method: 'PUT',
            body: JSON.stringify({
                metadata,
                doc_type: EmailState.currentEmail.doc_type,
                notes: 'Flask UIã‹ã‚‰ã®æ‰‹å‹•ä¿®æ­£',
            }),
        });

        App.toast('ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        EmailState.currentMetadata = metadata;

    } catch (error) {
        App.toast(`ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
    }
}

async function markReviewed() {
    if (!EmailState.currentEmail) return;

    try {
        await App.api(`/api/emails/${EmailState.currentEmail.id}/review`, { method: 'POST' });
        App.toast('ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ', 'success');
        EmailState.isReviewed = true;
        renderEmailDetail(EmailState.currentEmail);
        loadEmails();
    } catch (error) {
        App.toast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

async function markUnreviewed() {
    if (!EmailState.currentEmail) return;

    try {
        await App.api(`/api/emails/${EmailState.currentEmail.id}/unreview`, { method: 'POST' });
        App.toast('æœªå®Œäº†ã«æˆ»ã—ã¾ã—ãŸ', 'success');
        EmailState.isReviewed = false;
        renderEmailDetail(EmailState.currentEmail);
        loadEmails();
    } catch (error) {
        App.toast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

async function deleteEmail() {
    if (!EmailState.currentEmail) return;

    App.showDeleteModal('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼ŸGmailãƒ»Google Driveã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚', async () => {
        try {
            await App.api(`/api/emails/${EmailState.currentEmail.id}`, { method: 'DELETE' });
            App.toast('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            EmailState.currentEmail = null;
            document.getElementById('email-detail-container').style.display = 'none';
            App.setUrlParam('email_id', null);
            loadEmails();
        } catch (error) {
            App.toast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        }
    });
}

// =============================================================================
// ä¸€æ‹¬æ“ä½œ
// =============================================================================

async function bulkApprove() {
    const ids = Array.from(App.state.selectedIds);
    if (ids.length === 0) return;

    try {
        const result = await App.api('/api/emails/bulk-approve', {
            method: 'POST',
            body: JSON.stringify({ email_ids: ids }),
        });

        App.toast(`${result.success_count}ä»¶ã‚’æ‰¿èªã—ã¾ã—ãŸ`, 'success');
        App.clearSelection();
        loadEmails();

    } catch (error) {
        App.toast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

async function bulkDelete() {
    const ids = Array.from(App.state.selectedIds);
    if (ids.length === 0) return;

    App.showDeleteModal(`${ids.length}ä»¶ã®ãƒ¡ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
        try {
            const result = await App.api('/api/emails/bulk-delete', {
                method: 'POST',
                body: JSON.stringify({ email_ids: ids }),
            });

            App.toast(`${result.success_count}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
            App.clearSelection();
            loadEmails();

        } catch (error) {
            App.toast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        }
    });
}

// =============================================================================
// åˆæœŸåŒ–
// =============================================================================

document.addEventListener('DOMContentLoaded', async () => {
    if (!App.state.isAuthenticated) {
        await new Promise(resolve => setTimeout(resolve, 500));
        if (!App.state.isAuthenticated) return;
    }

    await loadEmails();

    document.getElementById('filter-btn')?.addEventListener('click', loadEmails);
    document.getElementById('refresh-btn')?.addEventListener('click', loadEmails);

    document.getElementById('save-btn')?.addEventListener('click', saveEmail);
    document.getElementById('review-btn')?.addEventListener('click', markReviewed);
    document.getElementById('unreview-btn')?.addEventListener('click', markUnreviewed);
    document.getElementById('delete-btn')?.addEventListener('click', deleteEmail);

    document.getElementById('bulk-approve-btn')?.addEventListener('click', bulkApprove);
    document.getElementById('bulk-delete-btn')?.addEventListener('click', bulkDelete);
});

window.selectEmail = selectEmail;
</script>
{% endblock %}
