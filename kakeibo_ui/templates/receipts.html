<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼ - å®¶è¨ˆç°¿</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .nav { display: flex; gap: 1rem; }
        .nav a { color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; }
        .nav a:hover { background: rgba(255,255,255,0.1); }
        .nav a.active { background: rgba(255,255,255,0.2); }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        .filters { background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 1rem; align-items: center; }
        .filters label { font-weight: 500; }
        .filters select { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }

        .receipt-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }

        .receipt-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
        .receipt-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .receipt-card a { text-decoration: none; color: inherit; display: block; }

        .card-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-header .status { font-size: 1.2rem; }
        .card-header .status.success { color: #27ae60; }
        .card-header .status.failed { color: #e74c3c; }
        .card-header .date { color: #7f8c8d; font-size: 0.9rem; }

        .card-body { padding: 1rem; }
        .card-body .filename { font-weight: 500; margin-bottom: 0.5rem; word-break: break-all; }
        .card-body .info { color: #7f8c8d; font-size: 0.85rem; }

        .card-footer { padding: 0.75rem 1rem; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        .badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .badge.linked { background: #d4edda; color: #155724; }
        .badge.unlinked { background: #fff3cd; color: #856404; }
        .badge.verified { background: #cce5ff; color: #004085; }

        .empty-state { text-align: center; padding: 4rem 2rem; color: #7f8c8d; }
        .empty-state h2 { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼</h1>
        <nav class="nav">
            <a href="/">æ˜ç´°ä¸€è¦§</a>
            <a href="/loans">ãƒ­ãƒ¼ãƒ³ç®¡ç†</a>
            <a href="/receipts" class="active">ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼</a>
            <a href="/reconcile">æ¶ˆè¾¼</a>
        </nav>
    </div>

    <div class="container">
        <div class="filters">
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
            <select id="statusFilter" onchange="applyFilter()">
                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>ã™ã¹ã¦</option>
                <option value="success" {% if status_filter == 'success' %}selected{% endif %}>æˆåŠŸ</option>
                <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>å¤±æ•—</option>
            </select>
            <span style="color: #7f8c8d;">{{ receipts|length }}ä»¶</span>
            <button id="importBtn" onclick="importReceipts()" style="margin-left: auto; padding: 0.5rem 1rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                ğŸ“¥ ãƒ¬ã‚·ãƒ¼ãƒˆå–ã‚Šè¾¼ã¿
            </button>
        </div>

        <div id="importStatus" style="display: none; background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <span id="importMessage">å–ã‚Šè¾¼ã¿ä¸­...</span>
        </div>

        {% if receipts %}
        <div class="receipt-grid">
            {% for r in receipts %}
            <div class="receipt-card">
                <a href="/receipts/{{ r.receipt_id or r.id }}">
                    <div class="card-header">
                        <span class="status {% if r.status == 'success' %}success{% else %}failed{% endif %}">
                            {{ r.status_icon }}
                        </span>
                        <span class="date">{{ r.date_short }}</span>
                    </div>
                    <div class="card-body">
                        <div class="filename">{{ r.file_name }}</div>
                        <div class="info">
                            {% if r.ocr_model %}ãƒ¢ãƒ‡ãƒ«: {{ r.ocr_model }}{% endif %}
                            {% if r.error_message %}<br>ã‚¨ãƒ©ãƒ¼: {{ r.error_message[:50] }}...{% endif %}
                        </div>
                    </div>
                    <div class="card-footer">
                        {% if r.is_linked %}
                        <span class="badge linked">ç´ä»˜ã‘æ¸ˆ</span>
                        {% else %}
                        <span class="badge unlinked">æœªç´ä»˜ã‘</span>
                        {% endif %}
                        <span style="color: #7f8c8d; font-size: 0.85rem;">è©³ç´°ã‚’è¦‹ã‚‹ â†’</span>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h2>ãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h2>
            <p>å‡¦ç†æ¸ˆã¿ã®ãƒ¬ã‚·ãƒ¼ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
        {% endif %}
    </div>

    <script>
        function applyFilter() {
            const status = document.getElementById('statusFilter').value;
            window.location.href = `/receipts?status=${status}`;
        }

        async function importReceipts() {
            const btn = document.getElementById('importBtn');
            const statusDiv = document.getElementById('importStatus');
            const messageSpan = document.getElementById('importMessage');

            btn.disabled = true;
            btn.textContent = 'å–ã‚Šè¾¼ã¿ä¸­...';
            statusDiv.style.display = 'block';
            messageSpan.textContent = 'Google Driveã‹ã‚‰ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’å–å¾—ã—ã¦ã„ã¾ã™...';

            try {
                const res = await fetch('/api/receipts/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.status === 'success') {
                    messageSpan.textContent = `âœ… ${data.processed}ä»¶ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆæˆåŠŸ: ${data.success}ä»¶ã€å¤±æ•—: ${data.failed}ä»¶ï¼‰`;
                    statusDiv.style.background = '#d4edda';
                    setTimeout(() => location.reload(), 2000);
                } else {
                    messageSpan.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`;
                    statusDiv.style.background = '#f8d7da';
                }
            } catch (e) {
                messageSpan.textContent = `âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                statusDiv.style.background = '#f8d7da';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“¥ ãƒ¬ã‚·ãƒ¼ãƒˆå–ã‚Šè¾¼ã¿';
            }
        }
    </script>
</body>
</html>
