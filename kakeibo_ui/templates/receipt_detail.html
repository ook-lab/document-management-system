<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆè©³ç´° - å®¶è¨ˆç°¿</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .nav { display: flex; gap: 1rem; }
        .nav a { color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; }
        .nav a:hover { background: rgba(255,255,255,0.1); }
        .nav a.active { background: rgba(255,255,255,0.2); }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }

        .back-link { margin-bottom: 1rem; }
        .back-link a { color: #3498db; text-decoration: none; }
        .back-link a:hover { text-decoration: underline; }

        .main-grid { display: grid; grid-template-columns: 400px 1fr; gap: 2rem; }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }

        .panel { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .panel-header { background: #f8f9fa; padding: 1rem; border-bottom: 1px solid #eee; font-weight: 600; }
        .panel-body { padding: 1rem; }

        .image-panel { position: sticky; top: 1rem; max-height: calc(100vh - 6rem); overflow-y: auto; }
        .receipt-image { width: 100%; height: auto; background: #f5f5f5; }
        .no-image { padding: 4rem 2rem; text-align: center; color: #7f8c8d; background: #f5f5f5; }

        .info-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; margin-bottom: 1rem; }
        .info-grid dt { color: #7f8c8d; }
        .info-grid dd { font-weight: 500; }

        .items-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .items-table th, .items-table td { padding: 0.75rem 0.5rem; text-align: left; border-bottom: 1px solid #eee; }
        .items-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        .items-table tr:hover { background: #f8f9fa; }
        .items-table tr.suggested { background: #fff8e1; }
        .items-table tr.suggested:hover { background: #fff3c4; }
        .items-table .amount { text-align: right; font-family: monospace; }
        .items-table input { width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; }
        .items-table input.narrow { width: 60px; }

        .summary { background: #f8f9fa; padding: 1rem; margin-top: 1rem; border-radius: 4px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .summary-row.total { font-weight: 600; font-size: 1.1rem; border-top: 2px solid #ddd; padding-top: 0.5rem; margin-top: 0.5rem; }

        .link-section { margin-top: 2rem; }
        .linked-tx { background: #d4edda; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .linked-tx .label { font-size: 0.85rem; color: #155724; margin-bottom: 0.5rem; }
        .linked-tx .content { font-weight: 500; }

        .candidates-list { max-height: 300px; overflow-y: auto; }
        .candidate-item { padding: 0.75rem; border: 1px solid #eee; border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .candidate-item:hover { border-color: #3498db; background: #f0f7ff; }
        .candidate-item.selected { border-color: #27ae60; background: #d4edda; }
        .candidate-item.same-day { border-left: 3px solid #27ae60; }
        .candidate-item .date { color: #7f8c8d; font-size: 0.85rem; }
        .candidate-item .content { margin: 0.25rem 0; }
        .candidate-item .amount { font-family: monospace; font-weight: 500; }
        .candidate-item .institution { color: #7f8c8d; font-size: 0.85rem; }

        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #219a52; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }

        .actions { display: flex; gap: 0.5rem; margin-top: 1rem; }

        .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 8px; color: white; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ãƒ¬ã‚·ãƒ¼ãƒˆè©³ç´°</h1>
        <nav class="nav">
            <a href="/">æ˜ç´°ä¸€è¦§</a>
            <a href="/loans">ãƒ­ãƒ¼ãƒ³ç®¡ç†</a>
            <a href="/receipts" class="active">ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼</a>
            <a href="/reconcile">æ¶ˆè¾¼</a>
        </nav>
    </div>

    <div class="container">
        <div class="back-link">
            <a href="/receipts">â† ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã«æˆ»ã‚‹</a>
        </div>

        <div class="main-grid">
            <!-- å·¦ï¼šãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒ -->
            <div class="image-panel">
                <div class="panel">
                    <div class="panel-header">ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒ</div>
                    <div class="panel-body" style="padding: 0;">
                        {% if image_base64 %}
                        <img src="{{ image_base64 }}" alt="ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒ" class="receipt-image">
                        {% else %}
                        <div class="no-image">ç”»åƒã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>
                        {% endif %}
                    </div>
                </div>

                <!-- å‡¦ç†æƒ…å ± -->
                <div class="panel" style="margin-top: 1rem;">
                    <div class="panel-header">å‡¦ç†æƒ…å ±</div>
                    <div class="panel-body">
                        <dl class="info-grid">
                            <dt>ãƒ•ã‚¡ã‚¤ãƒ«å</dt>
                            <dd>{{ log.file_name }}</dd>
                            <dt>å‡¦ç†æ—¥æ™‚</dt>
                            <dd>{{ log.processed_at[:19] if log.processed_at else '-' }}</dd>
                            <dt>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</dt>
                            <dd>{{ log.status }}</dd>
                            <dt>OCRãƒ¢ãƒ‡ãƒ«</dt>
                            <dd>{{ log.ocr_model or '-' }}</dd>
                            {% if log.error_message %}
                            <dt>ã‚¨ãƒ©ãƒ¼</dt>
                            <dd style="color: #e74c3c;">{{ log.error_message }}</dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>
            </div>

            <!-- å³ï¼šæ˜ç´°ã¨ãƒªãƒ³ã‚¯ -->
            <div>
                {% if receipt %}
                <!-- åº—èˆ—æƒ…å ±ï¼ˆç·¨é›†å¯èƒ½ï¼‰ -->
                <div class="panel" style="margin-bottom: 1rem;">
                    <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>åº—èˆ—æƒ…å ±</span>
                        <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteReceipt()">ãƒ¬ã‚·ãƒ¼ãƒˆå‰Šé™¤</button>
                    </div>
                    <div class="panel-body">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; align-items: center;">
                            <label>åº—èˆ—å</label>
                            <input type="text" id="shop_name" value="{{ receipt.shop_name or '' }}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">

                            <label>å–å¼•æ—¥</label>
                            <input type="date" id="transaction_date" value="{{ receipt.transaction_date or '' }}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">

                            <label>ãƒ¬ã‚·ãƒ¼ãƒˆåˆè¨ˆ</label>
                            <input type="number" id="total_amount_check" value="{{ receipt.total_amount_check or 0 }}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">

                            <label>å°è¨ˆ</label>
                            <input type="number" id="subtotal_amount" value="{{ receipt.subtotal_amount or 0 }}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">

                            <label>8%ç¨é¡</label>
                            <input type="number" id="tax_8_amount" value="{{ receipt.tax_8_amount or 0 }}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">

                            <label>10%ç¨é¡</label>
                            <input type="number" id="tax_10_amount" value="{{ receipt.tax_10_amount or 0 }}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="saveHeader()">åº—èˆ—æƒ…å ±ã‚’ä¿å­˜</button>
                    </div>
                </div>

                <!-- æ˜ç´°ä¸€è¦§ -->
                <div class="panel">
                    <div class="panel-header">æ˜ç´°ä¸€è¦§ ({{ items|length }}ä»¶)</div>
                    <div class="panel-body" style="padding: 0; overflow-x: auto;">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>å–å¾—å</th>
                                    <th style="width: 150px;">å•†å“å</th>
                                    <th style="width: 50px;">æ•°é‡</th>
                                    <th style="width: 60px;">ç¨ç‡</th>
                                    <th style="width: 80px;">ç¨é¡</th>
                                    <th style="width: 90px;">ç¨è¾¼ä¾¡</th>
                                    <th style="width: 70px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr data-item-id="{{ item.id }}" data-line-number="{{ loop.index }}" {% if item.is_suggested %}class="suggested"{% endif %} {% if (item.tax_included or 0) < 0 %}class="discount-row"{% endif %}>
                                    <td style="font-size: 0.85rem; color: #666;">{{ item.ocr_name or '' }}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 2px;">
                                            <input type="text" class="item-input" data-field="official_name" value="{{ item.product_name_display or '' }}" style="flex: 1;" placeholder="å•†å“åã‚’å…¥åŠ›">
                                            <button class="btn-icon" style="padding: 2px 4px; font-size: 0.7rem; background: #9b59b6; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="registerProductRule('{{ item.ocr_name|e }}', this)" title="ãƒ«ãƒ¼ãƒ«ç™»éŒ²">R</button>
                                        </div>
                                    </td>
                                    <td><input type="number" class="item-input" data-field="quantity" value="{{ item.quantity or 1 }}" style="width: 45px;"></td>
                                    <td>
                                        <select class="item-input" data-field="tax_rate" style="width: 55px;">
                                            <option value="10" {% if item.tax_rate == 10 %}selected{% endif %}>10%</option>
                                            <option value="8" {% if item.tax_rate == 8 %}selected{% endif %}>8%</option>
                                        </select>
                                    </td>
                                    <td><input type="number" class="item-input" data-field="tax_amount" value="{{ item.tax_amount or 0 }}" style="width: 70px;"></td>
                                    <td><input type="number" class="item-input" data-field="std_amount" value="{{ item.tax_included or 0 }}" style="width: 80px;"></td>
                                    <td style="white-space: nowrap;">
                                        {% if (item.tax_included or 0) < 0 and not loop.first %}
                                        <button class="btn btn-warning" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #f39c12;" onclick="mergeWithAbove('{{ item.id }}')" title="ä¸Šã®è¡Œã¨åˆç®—">â†‘</button>
                                        {% endif %}
                                        <button class="btn btn-danger" style="padding: 0.2rem 0.4rem; font-size: 0.7rem;" onclick="deleteItem('{{ item.id }}')">Ã—</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- æ–°è¦æ˜ç´°è¿½åŠ  -->
                    <div style="padding: 1rem; border-top: 1px solid #eee;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">æ˜ç´°ã‚’è¿½åŠ </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <input type="text" id="new_ocr_name" placeholder="å–å¾—å" style="flex: 1; min-width: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" id="new_product_name" placeholder="å•†å“å" style="flex: 1; min-width: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="new_quantity" placeholder="æ•°é‡" value="1" style="width: 60px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <select id="new_tax_rate" style="width: 70px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="10">10%</option>
                                <option value="8">8%</option>
                            </select>
                            <input type="number" id="new_std_amount" placeholder="ç¨è¾¼ä¾¡" style="width: 90px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button class="btn btn-success" onclick="addItem()">è¿½åŠ </button>
                        </div>
                    </div>

                    <!-- é‡‘é¡æ¯”è¼ƒè¡¨ï¼ˆOCR vs è¨ˆç®—ï¼‰ -->
                    <div class="summary" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                        <div style="font-weight: 600; border-bottom: 2px solid #ddd; padding-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; border-bottom: 2px solid #ddd; padding-bottom: 0.5rem; text-align: right;">ãƒ¬ã‚·ãƒ¼ãƒˆè¨˜è¼‰</div>
                        <div style="font-weight: 600; border-bottom: 2px solid #ddd; padding-bottom: 0.5rem; text-align: right;">æ˜ç´°åˆç®—</div>

                        <div>8%ç¨é¡</div>
                        <div style="text-align: right;">{% if ocr_tax_8 is not none %}Â¥{{ '{:,}'.format(ocr_tax_8) }}{% else %}-{% endif %}</div>
                        <div style="text-align: right;">Â¥{{ '{:,}'.format(calc_tax_8) }}</div>

                        <div>10%ç¨é¡</div>
                        <div style="text-align: right;">{% if ocr_tax_10 is not none %}Â¥{{ '{:,}'.format(ocr_tax_10) }}{% else %}-{% endif %}</div>
                        <div style="text-align: right;">Â¥{{ '{:,}'.format(calc_tax_10) }}</div>

                        <div>ç¨é¡åˆè¨ˆ</div>
                        <div style="text-align: right;">{% if ocr_tax_8 is not none or ocr_tax_10 is not none %}Â¥{{ '{:,}'.format((ocr_tax_8 or 0) + (ocr_tax_10 or 0)) }}{% else %}-{% endif %}</div>
                        <div style="text-align: right;">Â¥{{ '{:,}'.format(calc_tax) }}</div>

                        <div>å°è¨ˆ</div>
                        <div style="text-align: right;">{% if ocr_subtotal is not none %}Â¥{{ '{:,}'.format(ocr_subtotal) }}{% else %}-{% endif %}</div>
                        <div style="text-align: right;">Â¥{{ '{:,}'.format(calc_total - calc_tax) }}</div>

                        <div style="font-weight: 600; border-top: 2px solid #ddd; padding-top: 0.5rem;">åˆè¨ˆ</div>
                        <div style="font-weight: 600; border-top: 2px solid #ddd; padding-top: 0.5rem; text-align: right;">{% if ocr_total is not none %}Â¥{{ '{:,}'.format(ocr_total) }}{% else %}-{% endif %}</div>
                        <div style="font-weight: 600; border-top: 2px solid #ddd; padding-top: 0.5rem; text-align: right;">Â¥{{ '{:,}'.format(calc_total) }}</div>

                        {% if ocr_total is not none and calc_total != ocr_total %}
                        <div style="color: #e74c3c;">å·®é¡</div>
                        <div></div>
                        <div style="text-align: right; color: #e74c3c;">Â¥{{ '{:,}'.format(calc_total - ocr_total) }}</div>
                        {% endif %}
                    </div>

                    <div class="actions">
                        <button class="btn btn-success" onclick="verifyReceipt()">ç¢ºèªæ¸ˆã¿ã«ã™ã‚‹</button>
                        <button class="btn btn-primary" onclick="saveAllCategories()">æ˜ç´°ã‚’ä¿å­˜</button>
                    </div>
                </div>

                <!-- æ”¯æ‰•ã„å–å¼•ã¨ã®ç´ä»˜ã‘ -->
                <div class="panel link-section">
                    <div class="panel-header">æ”¯æ‰•ã„å–å¼•ã¨ã®ç´ä»˜ã‘</div>
                    <div class="panel-body">
                        {% if linked_transaction %}
                        <div class="linked-tx">
                            <div class="label">ç´ä»˜ã‘æ¸ˆã¿å–å¼•</div>
                            <div class="content">
                                {{ linked_transaction.Rawdata_BANK_transactions.date }} -
                                {{ linked_transaction.Rawdata_BANK_transactions.content }}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                                <span style="color: #666; font-size: 0.85rem;">{{ linked_transaction.Rawdata_BANK_transactions.institution }}</span>
                                <span style="font-family: monospace; font-weight: 500;">Â¥{{ '{:,}'.format(linked_transaction.Rawdata_BANK_transactions.amount or 0) }}</span>
                            </div>
                            <button class="btn btn-danger" style="margin-top: 0.5rem;" onclick="unlinkReceipt()">ç´ä»˜ã‘è§£é™¤</button>
                        </div>
                        {% else %}
                        <!-- ç¾é‡‘æ±ºæ¸ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #fff3cd; border-radius: 4px;">
                            <button class="btn" style="background: #28a745; color: white; width: 100%;" onclick="markAsCash()">
                                ğŸ’µ ç¾é‡‘æ±ºæ¸ˆã¨ã—ã¦ç™»éŒ²ï¼ˆç´ä»˜ã‘ãªã—ã§æ˜ç´°ä¸€è¦§ã¸è¿½åŠ ï¼‰
                            </button>
                        </div>

                        <!-- æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ -->
                        <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <label style="font-size: 0.85rem; color: #666;">æ—¥ä»˜æŒ‡å®š:</label>
                            <input type="date" id="filter_date" value="{{ filter_date or (receipt.transaction_date[:10] if receipt and receipt.transaction_date else '') }}" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button class="btn btn-primary" style="padding: 0.4rem 0.8rem;" onclick="filterByDate()">çµè¾¼</button>
                            {% if filter_date %}
                            <button class="btn btn-danger" style="padding: 0.4rem 0.8rem;" onclick="clearFilter()">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
                            {% endif %}
                        </div>

                        {% if filter_date %}
                        <p style="margin-bottom: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: 4px; font-size: 0.85rem;">
                            <strong>{{ filter_date }}</strong> ã®å–å¼•ã‚’è¡¨ç¤ºä¸­ï¼ˆ{{ candidates|length }}ä»¶ã€é‡‘é¡è¿‘ã„é †ï¼‰
                        </p>
                        {% else %}
                        <p style="margin-bottom: 0.5rem; color: #7f8c8d; font-size: 0.85rem;">
                            å€™è£œ: {{ candidates|length }}ä»¶ï¼ˆåŒæ—¥å„ªå…ˆã€é‡‘é¡è¿‘ã„é †ï¼‰
                        </p>
                        {% endif %}
                        {% endif %}

                        <div class="candidates-list" id="candidatesList">
                            {% for c in candidates %}
                            <div class="candidate-item {% if linked_transaction and linked_transaction.transaction_id == c.id %}selected{% endif %} {% if receipt and receipt.transaction_date and c.date == receipt.transaction_date[:10] %}same-day{% endif %}"
                                 data-tx-id="{{ c.id }}" data-date="{{ c.date }}" onclick="selectCandidate(this, '{{ c.id }}')">
                                <div class="date">{{ c.date }}{% if receipt and receipt.transaction_date and c.date == receipt.transaction_date[:10] %} <span style="color: #27ae60; font-weight: bold;">â—åŒæ—¥</span>{% endif %}</div>
                                <div class="content">{{ c.content }}</div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span class="institution">{{ c.institution }}</span>
                                    <span class="amount">Â¥{{ '{:,}'.format(c.amount or 0) }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        {% if not linked_transaction and candidates %}
                        <div class="actions">
                            <button class="btn btn-primary" onclick="linkSelected()" id="linkBtn" disabled>é¸æŠã—ãŸå–å¼•ã¨ç´ä»˜ã‘</button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="panel">
                    <div class="panel-body">
                        <p style="color: #7f8c8d; text-align: center; padding: 2rem;">
                            ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå‡¦ç†ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const receiptId = "{{ receipt.id if receipt else '' }}";
        let selectedTxId = null;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function selectCandidate(el, txId) {
            document.querySelectorAll('.candidate-item').forEach(item => item.classList.remove('selected'));
            el.classList.add('selected');
            selectedTxId = txId;
            const linkBtn = document.getElementById('linkBtn');
            if (linkBtn) linkBtn.disabled = false;
        }

        // ç¾é‡‘æ±ºæ¸ˆã¨ã—ã¦ç™»éŒ²ï¼ˆç´ä»˜ã‘ãªã—ã§æ˜ç´°ä¸€è¦§ã¸è¿½åŠ ï¼‰
        async function markAsCash() {
            if (!receiptId) return;
            if (!confirm('ç¾é‡‘æ±ºæ¸ˆã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆæ˜ç´°ãŒãã®ã¾ã¾æ˜ç´°ä¸€è¦§ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼‰')) return;

            try {
                const res = await fetch('/api/receipt/mark_cash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receipt_id: receiptId })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('ç¾é‡‘æ±ºæ¸ˆã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // æ—¥ä»˜ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å–å¾—ï¼‰
        function filterByDate() {
            const filterDate = document.getElementById('filter_date').value;
            if (!filterDate) {
                showToast('æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }
            // æ—¥ä»˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            const url = new URL(window.location.href);
            url.searchParams.set('filter_date', filterDate);
            window.location.href = url.toString();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
        function clearFilter() {
            const url = new URL(window.location.href);
            url.searchParams.delete('filter_date');
            window.location.href = url.toString();
        }

        async function linkSelected() {
            if (!selectedTxId || !receiptId) return;

            try {
                const res = await fetch('/api/receipt/link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receipt_id: receiptId, transaction_id: selectedTxId })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('ç´ä»˜ã‘ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        async function unlinkReceipt() {
            if (!receiptId) return;
            if (!confirm('ç´ä»˜ã‘ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const res = await fetch('/api/receipt/unlink', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receipt_id: receiptId })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('ç´ä»˜ã‘ã‚’è§£é™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        async function verifyReceipt() {
            if (!receiptId) return;

            try {
                const res = await fetch('/api/receipt/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receipt_id: receiptId })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('ç¢ºèªæ¸ˆã¿ã«ã—ã¾ã—ãŸ');
                } else {
                    showToast(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        async function saveAllCategories() {
            // è¡Œã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¦ä¿å­˜
            const rows = document.querySelectorAll('tbody tr[data-item-id]');
            let savedCount = 0;

            for (const row of rows) {
                const itemId = row.dataset.itemId;
                const inputs = row.querySelectorAll('.item-input');

                const data = { item_id: itemId };
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    let value = input.value;

                    // æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¤‰æ›
                    if (['quantity', 'tax_rate', 'base_price', 'tax_amount', 'std_amount'].includes(field)) {
                        value = parseInt(value) || 0;
                    }
                    data[field] = value;
                });

                try {
                    const res = await fetch('/api/receipt/update_item', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await res.json();
                    if (result.status === 'success') savedCount++;
                } catch (e) {
                    console.error('Save error:', e);
                }
            }

            showToast(`${savedCount}ä»¶ã®æ˜ç´°ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
            location.reload();  // åˆè¨ˆå†è¨ˆç®—ã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
        }

        // åº—èˆ—æƒ…å ±ã‚’ä¿å­˜
        async function saveHeader() {
            if (!receiptId) return;

            const data = {
                receipt_id: receiptId,
                shop_name: document.getElementById('shop_name').value,
                transaction_date: document.getElementById('transaction_date').value,
                total_amount_check: parseInt(document.getElementById('total_amount_check').value) || 0,
                subtotal_amount: parseInt(document.getElementById('subtotal_amount').value) || 0,
                tax_8_amount: parseInt(document.getElementById('tax_8_amount').value) || 0,
                tax_10_amount: parseInt(document.getElementById('tax_10_amount').value) || 0
            };

            try {
                const res = await fetch('/api/receipt/update_header', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast('åº—èˆ—æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } else {
                    showToast(result.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // æ˜ç´°ã‚’è¿½åŠ 
        async function addItem() {
            if (!receiptId) return;

            const ocrName = document.getElementById('new_ocr_name').value.trim();
            const productName = document.getElementById('new_product_name').value.trim();
            if (!ocrName && !productName) {
                showToast('å–å¾—åã¾ãŸã¯å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const stdAmount = parseInt(document.getElementById('new_std_amount').value) || 0;
            const taxRate = parseInt(document.getElementById('new_tax_rate').value) || 10;
            const taxAmount = Math.floor(stdAmount * taxRate / (100 + taxRate));

            const data = {
                receipt_id: receiptId,
                product_name: ocrName || productName,  // å–å¾—åï¼ˆOCRèª­ã¿å–ã‚Šå€¤ã¨ã—ã¦ä¿å­˜ï¼‰
                official_name: productName || null,    // å•†å“åï¼ˆæ‰‹å…¥åŠ›ï¼‰
                quantity: parseInt(document.getElementById('new_quantity').value) || 1,
                tax_rate: taxRate,
                std_amount: stdAmount,
                tax_amount: taxAmount
            };

            try {
                const res = await fetch('/api/receipt/add_item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast('æ˜ç´°ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    showToast(result.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // æ˜ç´°ã‚’å‰Šé™¤
        async function deleteItem(itemId) {
            if (!confirm('ã“ã®æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const res = await fetch('/api/receipt/delete_item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId })
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast('æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    showToast(result.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // å‰²å¼•è¡Œã‚’ä¸Šã®è¡Œã¨åˆç®—
        async function mergeWithAbove(itemId) {
            try {
                const res = await fetch('/api/receipt/merge_item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId, receipt_id: receiptId })
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast('ä¸Šã®è¡Œã¨åˆç®—ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    showToast(result.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // å•†å“åãƒ«ãƒ¼ãƒ«ã‚’ç™»éŒ²
        async function registerProductRule(ocrName, btn) {
            const row = btn.closest('tr');
            const productNameInput = row.querySelector('input[data-field="official_name"]');
            const productName = productNameInput ? productNameInput.value.trim() : '';

            if (!productName) {
                showToast('å•†å“åã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰Rãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (ocrName === productName) {
                showToast('å–å¾—åã¨å•†å“åãŒåŒã˜ã§ã™', 'error');
                return;
            }

            const shopName = document.getElementById('shop_name')?.value || null;

            try {
                const res = await fetch('/api/receipt/register_product_rule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ocr_name: ocrName, product_name: productName, shop_name: shopName })
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast(`ãƒ«ãƒ¼ãƒ«ç™»éŒ²: ${ocrName} â†’ ${productName}`);
                    btn.style.background = '#27ae60';
                } else {
                    showToast(result.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // ãƒ¬ã‚·ãƒ¼ãƒˆå…¨ä½“ã‚’å‰Šé™¤
        async function deleteReceipt() {
            if (!receiptId) return;
            if (!confirm('ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç´ä»˜ã‘ã‚‰ã‚ŒãŸå–å¼•ã¯å¾©å…ƒã•ã‚Œã¾ã™ï¼‰')) return;

            try {
                const res = await fetch('/api/receipt/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receipt_id: receiptId })
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    window.location.href = '/receipts';
                } else {
                    showToast(result.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (e) {
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }
    </script>
</body>
</html>
