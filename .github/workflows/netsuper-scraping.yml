name: ネットスーパースクレイピング

on:
  # ⚠️ 自動実行を無効化（コスト削減のため）
  # schedule:
  #   - cron: '0 17 * * *'  # UTC 17:00 = JST 02:00（翌日）

  # 手動実行のみ可能
  workflow_dispatch:
    inputs:
      store:
        description: '対象店舗'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - rakuten_seiyu
          - tokyu_store
          - daiei

jobs:
  scrape-netsuper:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3時間でタイムアウト

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libgbm1

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install playwright loguru supabase
          playwright install chromium

      - name: 楽天西友スクレイピング
        if: ${{ github.event.inputs.store == 'all' || github.event.inputs.store == 'rakuten_seiyu' || github.event_name == 'schedule' }}
        env:
          RAKUTEN_ID: ${{ secrets.RAKUTEN_ID }}
          RAKUTEN_PASSWORD: ${{ secrets.RAKUTEN_PASSWORD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "楽天西友スクレイピング開始"
          python -m B_ingestion.rakuten_seiyu.process_with_schedule
        continue-on-error: true

      - name: 東急ストアスクレイピング
        if: ${{ github.event.inputs.store == 'all' || github.event.inputs.store == 'tokyu_store' || github.event_name == 'schedule' }}
        env:
          TOKYU_STORE_LOGIN_ID: ${{ secrets.TOKYU_STORE_LOGIN_ID }}
          TOKYU_STORE_PASSWORD: ${{ secrets.TOKYU_STORE_PASSWORD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "東急ストアスクレイピング開始"
          python -m B_ingestion.tokyu_store.process_with_schedule
        continue-on-error: true

      - name: ダイエースクレイピング
        if: ${{ github.event.inputs.store == 'all' || github.event.inputs.store == 'daiei' || github.event_name == 'schedule' }}
        env:
          DAIEI_LOGIN_ID: ${{ secrets.DAIEI_LOGIN_ID }}
          DAIEI_PASSWORD: ${{ secrets.DAIEI_PASSWORD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ダイエースクレイピング開始"
          python -m B_ingestion.daiei.process_with_schedule
        continue-on-error: true

      - name: Upload category config as artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: category-config
          path: B_ingestion/common/category_config.json
          retention-days: 30
