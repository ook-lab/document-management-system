name: Import Receipts from Google Drive

on:
  # 定期実行: 毎時0分に実行
  schedule:
    - cron: '0 * * * *'  # 毎時0分（1時間ごと）

  # 手動実行も可能
  workflow_dispatch:
    inputs:
      limit:
        description: '処理する最大件数'
        required: false
        default: '10'

jobs:
  import-receipts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install loguru google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client supabase

      - name: Create service account credentials file
        env:
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        run: |
          echo "$GCP_SERVICE_ACCOUNT" > service_account.json

      - name: Run receipt import
        env:
          GOOGLE_APPLICATION_CREDENTIALS: service_account.json
          KAKEIBO_INBOX_EASY_FOLDER_ID: ${{ secrets.KAKEIBO_INBOX_EASY_FOLDER_ID }}
          KAKEIBO_INBOX_HARD_FOLDER_ID: ${{ secrets.KAKEIBO_INBOX_HARD_FOLDER_ID }}
          KAKEIBO_ARCHIVE_FOLDER_ID: ${{ secrets.KAKEIBO_ARCHIVE_FOLDER_ID }}
          KAKEIBO_ERROR_FOLDER_ID: ${{ secrets.KAKEIBO_ERROR_FOLDER_ID }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          LIMIT="${{ github.event.inputs.limit || '10' }}"
          python shared/kakeibo/reimport_receipts_from_drive.py --limit=$LIMIT

      - name: Clean up credentials
        if: always()
        run: |
          rm -f service_account.json
